<!DOCTYPE html>
<html lang="en">
<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content>
    <meta name="keyword" content>
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
        2019看雪CTF部分解题思路 - 萝卜
        
    </title>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/aircloud.css">
    <link rel="stylesheet" href="/css/gitment.css">
    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_pl6z7sid89qkt9.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>
</head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
     你若盛开，清风自来！ 
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar radius">
            <img src="/img/avatar.jpg">
        </div>
        <div class="name">
            萝卜
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li>
                <a href="/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>HOME</span>
                </a>
            </li>
            <li>
                <a href="/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>TAGS</span>
                </a>
            </li>
            <li>
                <a href="/archives">
                    <i class="iconfont icon-guidang2"></i>
                    <span>ARCHIVES</span>
                </a>
            </li>
            <li>
                <a href="/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>ABOUT</span>
                </a>
            </li>
            
            <li>
                <a id="search">
                    <i class="iconfont icon-sousuo1"></i>
                    <span>SEARCH</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#流浪者"><span class="toc-text">流浪者</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#序列号：j0rXI4bTeustBiIGHeCF70DDM"><span class="toc-text">序列号：j0rXI4bTeustBiIGHeCF70DDM</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#初入好望角"><span class="toc-text">初入好望角</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#序列号：Kanxue2019Q1CTF"><span class="toc-text">序列号：Kanxue2019Q1CTF</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Repwn"><span class="toc-text">Repwn</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#序列号：20101001X1Y0uN3tG00dHaCkWel1C0me"><span class="toc-text">序列号：20101001X1Y0uN3tG00dHaCkWel1C0me</span></a></li></ol></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input">
            <span id="begin-search">search</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>

        <div class="index-about-mobile">
            <i> 你若盛开，清风自来！ </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        2019看雪CTF部分解题思路
    </div>

    <div class="post-meta">
        <span class="attr">Post：<span>2019-03-26 22:48:28</span></span>
        
        <span class="attr">Tags：/
        
        <a class="tag" href="/tags/#WP" title="WP">WP</a>
        <span>/</span>
        
        
        </span>
        <span class="attr">Visit：<span id="busuanzi_value_page_pv"></span>
</span>

    </div>
    <div class="post-content no-indent">
        <p>第一次做这个看雪的CTF<br><a id="more"></a></p>
<h3 id="流浪者"><a href="#流浪者" class="headerlink" title="流浪者"></a>流浪者</h3><p>首先拿到程序之后发现是MFC程序，查壳发现没有壳，拖入IDA中通过查看关键字符串来定位到关键代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">int __thiscall sub_401890(CWnd *this)</span><br><span class="line">&#123;</span><br><span class="line">  struct CString *v1; // ST08_4</span><br><span class="line">  CWnd *v2; // eax</span><br><span class="line">  int v3; // eax</span><br><span class="line">  int v5[26]; // [esp+4Ch] [ebp-74h]</span><br><span class="line">  int i; // [esp+B4h] [ebp-Ch]</span><br><span class="line">  char *Str; // [esp+B8h] [ebp-8h]</span><br><span class="line">  CWnd *v8; // [esp+BCh] [ebp-4h]</span><br><span class="line"></span><br><span class="line">  v8 = this;</span><br><span class="line">  v1 = (this + 100);</span><br><span class="line">  v2 = CWnd::GetDlgItem(this, 1002);</span><br><span class="line">  CWnd::GetWindowTextA(v2, v1);</span><br><span class="line">  v3 = sub_401A30(v8 + 100);</span><br><span class="line">  Str = CString::GetBuffer((v8 + 100), v3);</span><br><span class="line">  if ( !strlen(Str) )</span><br><span class="line">    return CWnd::MessageBoxA(v8, &quot;请输入pass!&quot;, 0, 0);</span><br><span class="line">  for ( i = 0; Str[i]; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    if ( Str[i] &gt; 57 || Str[i] &lt; 48 )</span><br><span class="line">    &#123;</span><br><span class="line">      if ( Str[i] &gt; 122 || Str[i] &lt; 97 )</span><br><span class="line">      &#123;</span><br><span class="line">        if ( Str[i] &gt; 90 || Str[i] &lt; 65 )</span><br><span class="line">          sub_4017B0();</span><br><span class="line">        else</span><br><span class="line">          v5[i] = Str[i] - 29;</span><br><span class="line">      &#125;</span><br><span class="line">      else</span><br><span class="line">      &#123;</span><br><span class="line">        v5[i] = Str[i] - 87;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">      v5[i] = Str[i] - 48;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  return sub_4017F0(v5);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先获取输入框中的字符串，限制字符串必须是数字、大写字母、小写字母，对于这三种有不同的处理方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1. 数字：减去48</span><br><span class="line">2.大写字母：减去87</span><br><span class="line">3.小写字母：减去29</span><br></pre></td></tr></table></figure></p>
<p>然后进入到sub_4017F0函数中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">BOOL __cdecl sub_4017F0(int a1)</span><br><span class="line">&#123;</span><br><span class="line">  BOOL result; // eax</span><br><span class="line">  char Str1[28]; // [esp+D8h] [ebp-24h]</span><br><span class="line">  int v3; // [esp+F4h] [ebp-8h]</span><br><span class="line">  int v4; // [esp+F8h] [ebp-4h]</span><br><span class="line"></span><br><span class="line">  v4 = 0;</span><br><span class="line">  v3 = 0;</span><br><span class="line">  while ( *(a1 + 4 * v4) &lt; 62 &amp;&amp; *(a1 + 4 * v4) &gt;= 0 )</span><br><span class="line">  &#123;</span><br><span class="line">    Str1[v4] = aAbcdefghiabcde[*(a1 + 4 * v4)];</span><br><span class="line">    ++v4;</span><br><span class="line">  &#125;</span><br><span class="line">  Str1[v4] = 0;</span><br><span class="line">  if ( !strcmp(Str1, &quot;KanXueCTF2019JustForhappy&quot;) )</span><br><span class="line">    result = sub_401770();                      // 1</span><br><span class="line">  else</span><br><span class="line">    result = sub_4017B0();                      // 0</span><br><span class="line">  return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个函数是将处理过后的字符串当做索引，“abcdefghiABCDEFGHIJKLMNjklmn0123456789opqrstuvwxyzOPQRSTUVWXYZ”来作为数组，生成一个新的字符串，然后对第二次处理过的字符串和“KanXueCTF2019JustForhappy”对比一下，一样则正确。</p>
<p>根据题意解题脚本如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">current = &quot;KanXueCTF2019JustForhappy&quot;</span><br><span class="line">index = &quot;abcdefghiABCDEFGHIJKLMNjklmn0123456789opqrstuvwxyzOPQRSTUVWXYZ&quot;</span><br><span class="line">current_index = []</span><br><span class="line">for x in xrange(len(current)):</span><br><span class="line">	current_index.append(index.index(current[x]))</span><br><span class="line"># 0 9</span><br><span class="line"># 10 35</span><br><span class="line"># 36 61</span><br><span class="line">for x in xrange(0,len(current_index)):</span><br><span class="line">	if current_index[x]&lt;=9 and current_index[x]&gt;=0:</span><br><span class="line">		current_index[x]+=48</span><br><span class="line">	elif current_index[x]&lt;=35 and current_index&gt;=10:</span><br><span class="line">		current_index[x]+=87</span><br><span class="line">	elif current_index[x]&lt;=61 and current_index&gt;=35:</span><br><span class="line">		current_index[x]+=29</span><br><span class="line">flag = &quot;&quot;</span><br><span class="line">for x in xrange(len(current_index)):</span><br><span class="line">	flag+=chr(current_index[x])</span><br><span class="line">print flag</span><br></pre></td></tr></table></figure>
<h4 id="序列号：j0rXI4bTeustBiIGHeCF70DDM"><a href="#序列号：j0rXI4bTeustBiIGHeCF70DDM" class="headerlink" title="序列号：j0rXI4bTeustBiIGHeCF70DDM"></a>序列号：j0rXI4bTeustBiIGHeCF70DDM</h4><h3 id="初入好望角"><a href="#初入好望角" class="headerlink" title="初入好望角"></a>初入好望角</h3><p>PEID查发现是C#的程序，一开始我用的是x64dbg来调试这个程序，mmp，巨难受，受Dummy师傅指点，c#的程序逆向用Reflector比较容易一点。</p>
<p>用这个软件打开程序之后发现，我靠，又有点牛逼了！<br><img src="https://s2.ax1x.com/2019/03/26/AUbecF.png" alt> </p>
<p>第一个函数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">private static void a(string[] A_0)</span><br><span class="line">&#123;</span><br><span class="line">    Console.WriteLine(&quot;Please Input Serial:&quot;);![](imgs/20190325-220309.png)</span><br><span class="line">    if (a(Console.ReadLine(), &quot;Kanxue2019&quot;) == &quot;4RTlF9Ca2+oqExJwx68FiA==&quot;)</span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine(&quot;Congratulations!  : )&quot;);</span><br><span class="line">        Console.ReadLine();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到将我们的输入和“kanxue2019”当做参数传进a函数，返回值和“4RTlF9Ca2+oqExJwx68FiA==”做比较。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public static string a(string A_0, string A_1)</span><br><span class="line">	&#123;</span><br><span class="line">		byte[] bytes = Encoding.UTF8.GetBytes(&quot;Kanxue2019CTF-Q1&quot;);</span><br><span class="line">		byte[] bytes2 = Encoding.UTF8.GetBytes(A_0);</span><br><span class="line">		byte[] bytes3 = new PasswordDeriveBytes(A_1, null).GetBytes(32);</span><br><span class="line">		ICryptoTransform transform = new RijndaelManaged</span><br><span class="line">		&#123;</span><br><span class="line">			Mode = CipherMode.CBC</span><br><span class="line">		&#125;.CreateEncryptor(bytes3, bytes);</span><br><span class="line">		MemoryStream memoryStream = new MemoryStream();</span><br><span class="line">		CryptoStream cryptoStream = new CryptoStream(memoryStream, transform, CryptoStreamMode.Write);</span><br><span class="line">		cryptoStream.Write(bytes2, 0, bytes2.Length);</span><br><span class="line">		cryptoStream.FlushFinalBlock();</span><br><span class="line">		byte[] inArray = memoryStream.ToArray();</span><br><span class="line">		memoryStream.Close();</span><br><span class="line">		cryptoStream.Close();</span><br><span class="line">		return Convert.ToBase64String(inArray);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>从这段代码中可以看出：AES加密，key、偏移<br>秘钥可以用dnspy调试的时候dump出来</p>
<p><img src="https://s2.ax1x.com/2019/03/26/AUbWHs.jpg" alt> </p>
<p>解题脚本：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">from Crypto.Cipher import AES</span><br><span class="line">import base64</span><br><span class="line">k = &apos;Kanxue2019CTF-Q1&apos;</span><br><span class="line">key = &apos;&apos;.join([chr(i) for i in [0x6D, 0xDE, 0xF7, 0xA4, 0x3C, 0x00, 0x4F, 0x7D, 0x69, 0x83, 0x04, 0x4B, 0x1E, 0x36, 0xA9, 0x34, 0x59, 0xF1, 0x8B, 0xC8, 0x37, 0xC4, 0x6E, 0xAF, 0x32, 0x11, 0x32, 0x73, 0x41, 0x63, 0xA0, 0xB4]])</span><br><span class="line">ci = AES.new(key,AES.MODE_CBC,k)</span><br><span class="line">print ci.decrypt(base64.b64decode(&quot;4RTlF9Ca2+oqExJwx68FiA==&quot;))</span><br></pre></td></tr></table></figure>
<h4 id="序列号：Kanxue2019Q1CTF"><a href="#序列号：Kanxue2019Q1CTF" class="headerlink" title="序列号：Kanxue2019Q1CTF"></a>序列号：Kanxue2019Q1CTF</h4><h3 id="Repwn"><a href="#Repwn" class="headerlink" title="Repwn"></a>Repwn</h3><p>第一次做windows平台上的pwn，没有经验</p>
<p>程序没壳，32位程序，用PEID插件Krypto AnALyzer查看发现存在DES加密</p>
<p>拖入IDA通过关键字符串定位到关键代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">int sub_4014C0()</span><br><span class="line">&#123;</span><br><span class="line">  unsigned int v0; // ebx</span><br><span class="line">  char Str[4]; // [esp+10h] [ebp-58h]</span><br><span class="line">  int v3; // [esp+20h] [ebp-48h]</span><br><span class="line">  int v4; // [esp+24h] [ebp-44h]</span><br><span class="line">  int v5; // [esp+28h] [ebp-40h]</span><br><span class="line">  int v6; // [esp+2Ch] [ebp-3Ch]</span><br><span class="line">  int v7; // [esp+30h] [ebp-38h]</span><br><span class="line">  int v8; // [esp+34h] [ebp-34h]</span><br><span class="line">  int v9; // [esp+38h] [ebp-30h]</span><br><span class="line">  int v10; // [esp+3Ch] [ebp-2Ch]</span><br><span class="line">  char v11; // [esp+40h] [ebp-28h]</span><br><span class="line"></span><br><span class="line">  sub_404930();</span><br><span class="line">  sub_4044B0();</span><br><span class="line">  v0 = 0;</span><br><span class="line">  v3 = 2138666078;</span><br><span class="line">  v4 = 728779875;</span><br><span class="line">  v5 = 1630229319;</span><br><span class="line">  v6 = 1194152263;</span><br><span class="line">  v7 = 1198270550;</span><br><span class="line">  v8 = 695827786;</span><br><span class="line">  v9 = 1397178665;</span><br><span class="line">  v10 = 6644011;</span><br><span class="line">  strcpy(Str, &quot;Ansome_Is_Wrong&quot;);</span><br><span class="line">  while ( v0 &lt; strlen(&amp;v3) )</span><br><span class="line">    *(&amp;v3 + v0++) ^= 0x18u;</span><br><span class="line">  puts(&quot;Please Input Your Key_ Now!&quot;);</span><br><span class="line">  scanf(&quot;%s&quot;, &amp;v11);</span><br><span class="line">  if ( sub_4012F0(&amp;v11) )</span><br><span class="line">  &#123;</span><br><span class="line">    sub_401460(&amp;v11);</span><br><span class="line">    system(&quot;pause&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">  else</span><br><span class="line">  &#123;</span><br><span class="line">    puts(Str);</span><br><span class="line">  &#125;</span><br><span class="line">  return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先异或了一段数据，结果是一个字符串“Flag{Th3_K3y_I5_N0t_Rea11Y_K3y}”,然后要求输入一个字符串</p>
<p>函数4012f0：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">signed int __cdecl sub_4012F0(int a1)</span><br><span class="line">&#123;</span><br><span class="line">  signed int v1; // ecx</span><br><span class="line">  signed int v2; // edx</span><br><span class="line">  signed int result; // eax</span><br><span class="line">  int v4; // [esp+0h] [ebp-38h]</span><br><span class="line">  int v5; // [esp+4h] [ebp-34h]</span><br><span class="line">  int v6; // [esp+8h] [ebp-30h]</span><br><span class="line">  char v7; // [esp+Ch] [ebp-2Ch]</span><br><span class="line">  int v8; // [esp+10h] [ebp-28h]</span><br><span class="line">  int v9; // [esp+14h] [ebp-24h]</span><br><span class="line">  int v10; // [esp+18h] [ebp-20h]</span><br><span class="line">  int v11; // [esp+1Ch] [ebp-1Ch]</span><br><span class="line">  int v12; // [esp+20h] [ebp-18h]</span><br><span class="line"></span><br><span class="line">  v1 = 8;</span><br><span class="line">  v2 = 0;</span><br><span class="line">  v8 = &apos;ruoY&apos;;</span><br><span class="line">  v9 = &apos;pnI_&apos;;</span><br><span class="line">  v10 = &apos;I_tu&apos;;</span><br><span class="line">  v11 = &apos;rW_s&apos;;</span><br><span class="line">  v12 = &apos;gno&apos;;</span><br><span class="line">  v4 = &apos;0Y1X&apos;;</span><br><span class="line">  v5 = &apos;t3Nu&apos;;</span><br><span class="line">  v6 = &apos;d00G&apos;;</span><br><span class="line">  v7 = 0;</span><br><span class="line">  while ( *(&amp;v4 + v2) == *(v1 + a1) )</span><br><span class="line">  &#123;</span><br><span class="line">    ++v2;</span><br><span class="line">    ++v1;</span><br><span class="line">    if ( v2 &gt; 11 )</span><br><span class="line">    &#123;</span><br><span class="line">      result = 1;</span><br><span class="line">      if ( *(a1 + 20) == 72 )</span><br><span class="line">        return result;</span><br><span class="line">      return 0;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>限制了字符串的8-20位必须是“X1Y0uN3tG00dH”</p>
<p>函数401460：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">int __cdecl sub_401460(char *Str)</span><br><span class="line">&#123;</span><br><span class="line">  char Dest; // [esp+8h] [ebp-10h]</span><br><span class="line"></span><br><span class="line">  if ( strlen(Str) == 24 )</span><br><span class="line">  &#123;</span><br><span class="line">    if ( sub_4013B0(Str) )</span><br><span class="line">    &#123;</span><br><span class="line">      Str[20] -= 88;</span><br><span class="line">      Str[21] -= 70;</span><br><span class="line">      Str[22] -= 3;</span><br><span class="line">      Str[23] -= 107;</span><br><span class="line">      strcpy(&amp;Dest, Str);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  else</span><br><span class="line">  &#123;</span><br><span class="line">    printf(&quot;String Length is Wrong&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">  return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先是判断了一下输入字符串的长度是否等于24，然后进入函数4013b0</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">signed int __cdecl sub_4013B0(int a1)</span><br><span class="line">&#123;</span><br><span class="line">  int v1; // ebx</span><br><span class="line">  int v2; // ecx</span><br><span class="line">  int v3; // esi</span><br><span class="line">  signed int result; // eax</span><br><span class="line"></span><br><span class="line">  sub_401380(a1);</span><br><span class="line">  v1 = dword_40802C + 1000 * dword_408020 + 100 * dword_408024 + 10 * dword_408028;</span><br><span class="line">  v2 = dword_408034 + 10 * dword_408030;</span><br><span class="line">  v3 = dword_40803C + 10 * dword_408038;</span><br><span class="line">  if ( 2 * (v1 + v2) != 4040 || 3 * v2 / 2 + 100 * v3 != 115 )</span><br><span class="line">    goto LABEL_2;</span><br><span class="line">  result = 1;</span><br><span class="line">  if ( v1 - 110 * v3 != 1900 )</span><br><span class="line">  &#123;</span><br><span class="line">    printf(&quot;Key_Is_Wrong,Please_Input_Again!&quot;);</span><br><span class="line">LABEL_2:</span><br><span class="line">    result = 0;</span><br><span class="line">  &#125;</span><br><span class="line">  return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对前八位进行了限制，这里我们可以用z3来解出符合条件的值：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">from z3 import *</span><br><span class="line">from Crypto.Cipher import DES</span><br><span class="line">x = BitVec(&apos;x&apos;,16)</span><br><span class="line">y = BitVec(&apos;y&apos;,16)</span><br><span class="line">z = BitVec(&apos;z&apos;,16)</span><br><span class="line">solve((x+y)*2==4040,3*y/2+100*z==115,x-110*z==1900)</span><br><span class="line"></span><br><span class="line">out：</span><br><span class="line">[z = 1, y = 10, x = 2010]</span><br></pre></td></tr></table></figure>
<p>可以得出来前八位是“20101001”</p>
<p>如果前八位符合条件限制，会将后四位进行处理，并且将字符串复制到Dest里面：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Str[20] -= 88;</span><br><span class="line"> Str[21] -= 70;</span><br><span class="line"> Str[22] -= 3;</span><br><span class="line"> Str[23] -= 107;</span><br><span class="line"> strcpy(&amp;Dest, Str);</span><br></pre></td></tr></table></figure>
<p>漏洞点就出现在这里，dest在栈上的位置是“ebp-0x10”，我们输入的字符串的长度是24，那么我们输入的字符串的后四位会覆盖点返回地址</p>
<p>后四位现在已知的是“H×××”，我们知道函数的地址是“0x0040<em>**</em>”,那么我们就可以推断出最后以为就是“k”，倒数第二位就是“C”,倒数第三位我们可以猜测到是“A/a”，分别看看两种情况下的函数，发现是“a”的时候是关键函数，将已知的字符串拼接到一块输入发现是正确的</p>
<p>进入函数401bf0：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">void __noreturn sub_401BF0()</span><br><span class="line">&#123;</span><br><span class="line">  unsigned int v0; // ebx</span><br><span class="line">  char *v1; // ebx</span><br><span class="line">  int v2; // [esp+10h] [ebp-48h]</span><br><span class="line">  int v3; // [esp+14h] [ebp-44h]</span><br><span class="line">  char v4; // [esp+18h] [ebp-40h]</span><br><span class="line">  char v5[28]; // [esp+20h] [ebp-38h]</span><br><span class="line">  __int16 v6; // [esp+3Ch] [ebp-1Ch]</span><br><span class="line">  char v7; // [esp+3Eh] [ebp-1Ah]</span><br><span class="line"></span><br><span class="line">  qmemcpy(v5, &amp;unk_4060A4, sizeof(v5));</span><br><span class="line">  v0 = 0;</span><br><span class="line">  v6 = word_4060C0;</span><br><span class="line">  v7 = byte_4060C2;</span><br><span class="line">  while ( v0 &lt; strlen(v5) )</span><br><span class="line">  &#123;</span><br><span class="line">    v5[v0] += v0;</span><br><span class="line">    ++v0;</span><br><span class="line">  &#125;</span><br><span class="line">  system(&quot;cls&quot;);</span><br><span class="line">  printf(&quot;%.*s\n&quot;, 29, v5);</span><br><span class="line">  v2 = &apos;oyiX&apos;;</span><br><span class="line">  v3 = &apos;teNu&apos;;</span><br><span class="line">  v4 = 0;</span><br><span class="line">  fflush(iob);</span><br><span class="line">  v1 = (char *)sub_401CF0(8u);</span><br><span class="line">  gets(v1);</span><br><span class="line">  sub_401730((int)&amp;v2);</span><br><span class="line">  sub_4018B0(v1, v1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为刚刚我们用PEID检测出程序用到了DES加密  ，在之前的验证都没有用到这个加密，所以这里是用到的DES加密</p>
<p>函数401730是初始化向量，函数4018b0中是对字符串进行加密</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">while ( 1 )</span><br><span class="line">  &#123;</span><br><span class="line">    if ( Dst[v9] != v13[v9] )</span><br><span class="line">      v10 = 1;</span><br><span class="line">    if ( ++v9 &gt; 31 )</span><br><span class="line">    &#123;</span><br><span class="line">      if ( !v10 )</span><br><span class="line">        printf(Format);</span><br><span class="line">      putchar(10);</span><br><span class="line">      system(&quot;pause&quot;);</span><br><span class="line">      ExitProcess(0);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>Dst变量是加密后的输入，而v13是正确的数据，那么我们可以将v13提取出来：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">memcpy(v13, &amp;unk_406010, 0x94u);</span><br></pre></td></tr></table></figure>
<p>在函数前面有对v13赋值，把unk_406010提取出来</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[9,13,11,8,4,10,12,9,7,4,1,14,3,5,6,9,7,13,5,10,4,9,9,3,5,5,10,2,8]</span><br></pre></td></tr></table></figure>
<p>解密脚本：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">from Crypto.Cipher import DES</span><br><span class="line">obj = DES.new(&quot;XiyouNet&quot;,DES.MODE_ECB)</span><br><span class="line">mi = &quot;9DB084AC97041E305697D5A499355A28&quot;.decode(&quot;hex&quot;)</span><br><span class="line">print obj.decrypt(mi)</span><br><span class="line"></span><br><span class="line">out：</span><br><span class="line">Wel1C0me</span><br></pre></td></tr></table></figure>
<h4 id="序列号：20101001X1Y0uN3tG00dHaCkWel1C0me"><a href="#序列号：20101001X1Y0uN3tG00dHaCkWel1C0me" class="headerlink" title="序列号：20101001X1Y0uN3tG00dHaCkWel1C0me"></a>序列号：20101001X1Y0uN3tG00dHaCkWel1C0me</h4>
        
        <br>
        <div id="comment-container">
        </div>
        <div id="disqus_thread"></div>

        <div id="lv-container">
        </div>

    </div>
</div>

    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        

        

        

        

        

    </ul>
    
    <p>
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
        转发请备注<a href="“https://luobuming.github.io”">一筐萝卜</a>的个人博客 <br>
        本站总访问量<span id="busuanzi_value_site_pv"></span>次
       </p>
</footer>




</body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = "search.json"
    window.hexo_root = "/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="/js/index.js"></script>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




</html>
