<!DOCTYPE html>
<html lang="en">
<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content>
    <meta name="keyword" content>
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
        IO_FILE-fopen函数详解 - 萝卜
        
    </title>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/aircloud.css">
    <link rel="stylesheet" href="/css/gitment.css">
    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_pl6z7sid89qkt9.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>
</head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
     你若盛开，清风自来！ 
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar radius">
            <img src="/img/avatar.jpg">
        </div>
        <div class="name">
            萝卜
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li>
                <a href="/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>HOME</span>
                </a>
            </li>
            <li>
                <a href="/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>TAGS</span>
                </a>
            </li>
            <li>
                <a href="/archives">
                    <i class="iconfont icon-guidang2"></i>
                    <span>ARCHIVES</span>
                </a>
            </li>
            <li>
                <a href="/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>ABOUT</span>
                </a>
            </li>
            
            <li>
                <a id="search">
                    <i class="iconfont icon-sousuo1"></i>
                    <span>SEARCH</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#源码分析"><span class="toc-text">源码分析</span></a></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input">
            <span id="begin-search">search</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>

        <div class="index-about-mobile">
            <i> 你若盛开，清风自来！ </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        IO_FILE-fopen函数详解
    </div>

    <div class="post-meta">
        <span class="attr">Post：<span>2019-08-02 09:00:00</span></span>
        
        <span class="attr">Tags：/
        
        <a class="tag" href="/tags/#pwn" title="pwn">pwn</a>
        <span>/</span>
        
        
        </span>
        <span class="attr">Visit：<span id="busuanzi_value_page_pv"></span>
</span>

    </div>
    <div class="post-content no-indent">
        <h3 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h3><p>简单的写一个demo</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FILE *file_point = fopen(<span class="string">"test.txt"</span>,<span class="string">"r"</span>);</span><br><span class="line">    <span class="keyword">char</span> *heap_point = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我在ubuntu16.04中调试的，使用的是gdb-pwndbg，glibc的版本是2.23，去官方上下载，<a href="http://gnu.mirror.constant.com/libc/glibc-2.23.tar.gz" target="_blank" rel="noopener">glibc-2.23下载地址</a></p>
<blockquote>
<p>编译C时，加上-g参数，这样会保留代码的文字信息</p>
</blockquote>
<blockquote>
<p>在gdb中附加glibc源码：directory ../glibc-2.23/libio/</p>
</blockquote>
<p>首先在main函数下断点</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; start</span><br><span class="line">Temporary breakpoint 2 at 0x40056e: file 123.c, line 4.</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">────────────────────────────────────────────────────────────────[ REGISTERS ]─────────────────────────────────────────────────────────────────</span><br><span class="line"> RAX  0x400566 (main) ◂— push   rbp</span><br><span class="line"> RBX  0x0</span><br><span class="line"> RCX  0x0</span><br><span class="line"> RDX  0x7fffffffdf98 —▸ 0x7fffffffe312 ◂— <span class="string">'XDG_SEAT_PATH=/org/freedesktop/DisplayManager/Seat0'</span></span><br><span class="line"> RDI  0x1</span><br><span class="line"> RSI  0x7fffffffdf88 —▸ 0x7fffffffe302 ◂— <span class="string">'/root/test/test'</span></span><br><span class="line"> R8   0x400610 (__libc_csu_fini) ◂— ret    </span><br><span class="line"> R9   0x7ffff7de7ac0 (_dl_fini) ◂— push   rbp</span><br><span class="line"> R10  0x846</span><br><span class="line"> R11  0x7ffff7a2d740 (__libc_start_main) ◂— push   r14</span><br><span class="line"> R12  0x400470 (_start) ◂— xor    ebp, ebp</span><br><span class="line"> R13  0x7fffffffdf80 ◂— 0x1</span><br><span class="line"> R14  0x0</span><br><span class="line"> R15  0x0</span><br><span class="line"> RBP  0x7fffffffdea0 —▸ 0x4005a0 (__libc_csu_init) ◂— push   r15</span><br><span class="line"> RSP  0x7fffffffde90 —▸ 0x7fffffffdf80 ◂— 0x1</span><br><span class="line"> RIP  0x40056e (main+8) ◂— mov    esi, 0x400624</span><br><span class="line">──────────────────────────────────────────────────────────────────[ DISASM ]──────────────────────────────────────────────────────────────────</span><br><span class="line"> ► 0x40056e &lt;main+8&gt;     mov    esi, 0x400624</span><br><span class="line">   0x400573 &lt;main+13&gt;    mov    edi, 0x400626</span><br><span class="line">   0x400578 &lt;main+18&gt;    call   fopen@plt &lt;0x400450&gt;</span><br><span class="line"> </span><br><span class="line">   0x40057d &lt;main+23&gt;    mov    qword ptr [rbp - 0x10], rax</span><br><span class="line">   0x400581 &lt;main+27&gt;    mov    edi, 0x20</span><br><span class="line">   0x400586 &lt;main+32&gt;    call   malloc@plt &lt;0x400440&gt;</span><br><span class="line"> </span><br><span class="line">   0x40058b &lt;main+37&gt;    mov    qword ptr [rbp - 8], rax</span><br><span class="line">   0x40058f &lt;main+41&gt;    mov    eax, 0</span><br><span class="line">   0x400594 &lt;main+46&gt;    leave  </span><br><span class="line">   0x400595 &lt;main+47&gt;    ret    </span><br><span class="line"> </span><br><span class="line">   0x400596              nop    word ptr cs:[rax + rax]</span><br><span class="line">──────────────────────────────────────────────────────────────[ SOURCE (CODE) ]───────────────────────────────────────────────────────────────</span><br><span class="line">In file: /root/<span class="built_in">test</span>/123.c</span><br><span class="line">   1 <span class="comment">#include&lt;stdio.h&gt;</span></span><br><span class="line">   2 int main()</span><br><span class="line">   3 &#123;</span><br><span class="line"> ► 4     FILE *file_point = fopen(<span class="string">"test.txt"</span>,<span class="string">"r"</span>);</span><br><span class="line">   5     char *heap_point = malloc(0x20);</span><br><span class="line">   6     <span class="built_in">return</span> 0;</span><br><span class="line">   7 &#125;</span><br><span class="line">──────────────────────────────────────────────────────────────────[ STACK ]───────────────────────────────────────────────────────────────────</span><br><span class="line">00:0000│ rsp  0x7fffffffde90 —▸ 0x7fffffffdf80 ◂— 0x1</span><br><span class="line">01:0008│      0x7fffffffde98 ◂— 0x0</span><br><span class="line">02:0010│ rbp  0x7fffffffdea0 —▸ 0x4005a0 (__libc_csu_init) ◂— push   r15</span><br><span class="line">03:0018│      0x7fffffffdea8 —▸ 0x7ffff7a2d830 (__libc_start_main+240) ◂— mov    edi, eax</span><br><span class="line">04:0020│      0x7fffffffdeb0 ◂— 0x1</span><br><span class="line">05:0028│      0x7fffffffdeb8 —▸ 0x7fffffffdf88 —▸ 0x7fffffffe302 ◂— <span class="string">'/root/test/test'</span></span><br><span class="line">06:0030│      0x7fffffffdec0 ◂— 0x1f7ffcca0</span><br><span class="line">07:0038│      0x7fffffffdec8 —▸ 0x400566 (main) ◂— push   rbp</span><br><span class="line">────────────────────────────────────────────────────────────────[ BACKTRACE ]─────────────────────────────────────────────────────────────────</span><br><span class="line"> ► f 0           40056e main+8</span><br><span class="line">   f 1     7ffff7a2d830 __libc_start_main+240</span><br><span class="line">──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">Breakpoint main</span><br><span class="line">Breakpoint main</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure>
<p>在pwndbg中也可以看到C源程序的代码，有点舒服，到fopen函数处，使用s单步步入，可以看到，当我们使用fopen函数的时候，世纪上时调用了<code>_IO_new_fopen</code>函数，</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; s</span><br><span class="line">_IO_new_fopen (filename=0x400626 <span class="string">"test.txt"</span>, mode=0x400624 <span class="string">"r"</span>) at iofopen.c:97</span><br><span class="line">97	  <span class="built_in">return</span> __fopen_internal (filename, mode, 1);</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">────────────────────────────────────────────────────────────────[ REGISTERS ]─────────────────────────────────────────────────────────────────</span><br><span class="line"> RAX  0x400566 (main) ◂— push   rbp</span><br><span class="line"> RBX  0x0</span><br><span class="line"> RCX  0x0</span><br><span class="line"> RDX  0x7fffffffdf98 —▸ 0x7fffffffe312 ◂— <span class="string">'XDG_SEAT_PATH=/org/freedesktop/DisplayManager/Seat0'</span></span><br><span class="line"> RDI  0x400626 ◂— je     0x40068d /* <span class="string">'test.txt'</span> */</span><br><span class="line"> RSI  0x400624 ◂— jb     0x400626 /* <span class="string">'r'</span> */</span><br><span class="line"> R8   0x400610 (__libc_csu_fini) ◂— ret    </span><br><span class="line"> R9   0x7ffff7de7ac0 (_dl_fini) ◂— push   rbp</span><br><span class="line"> R10  0xad</span><br><span class="line"> R11  0x7ffff7a7ad70 (fopen64) ◂— mov    edx, 1</span><br><span class="line"> R12  0x400470 (_start) ◂— xor    ebp, ebp</span><br><span class="line"> R13  0x7fffffffdf80 ◂— 0x1</span><br><span class="line"> R14  0x0</span><br><span class="line"> R15  0x0</span><br><span class="line"> RBP  0x7fffffffdea0 —▸ 0x4005a0 (__libc_csu_init) ◂— push   r15</span><br><span class="line"> RSP  0x7fffffffde88 —▸ 0x40057d (main+23) ◂— mov    qword ptr [rbp - 0x10], rax</span><br><span class="line"> RIP  0x7ffff7a7ad70 (fopen64) ◂— mov    edx, 1</span><br><span class="line">──────────────────────────────────────────────────────────────────[ DISASM ]──────────────────────────────────────────────────────────────────</span><br><span class="line"> ► 0x7ffff7a7ad70 &lt;fopen64&gt;                mov    edx, 1</span><br><span class="line">   0x7ffff7a7ad75 &lt;fopen64+5&gt;              jmp    __fopen_internal &lt;0x7ffff7a7acc0&gt;</span><br><span class="line">    ↓</span><br><span class="line">   0x7ffff7a7acc0 &lt;__fopen_internal&gt;       push   r13</span><br><span class="line">   0x7ffff7a7acc2 &lt;__fopen_internal+2&gt;     push   r12</span><br><span class="line">   0x7ffff7a7acc4 &lt;__fopen_internal+4&gt;     mov    r13d, edx</span><br><span class="line">   0x7ffff7a7acc7 &lt;__fopen_internal+7&gt;     push   rbp</span><br><span class="line">   0x7ffff7a7acc8 &lt;__fopen_internal+8&gt;     push   rbx</span><br><span class="line">   0x7ffff7a7acc9 &lt;__fopen_internal+9&gt;     mov    rbp, rdi</span><br><span class="line">   0x7ffff7a7accc &lt;__fopen_internal+12&gt;    mov    edi, 0x228</span><br><span class="line">   0x7ffff7a7acd1 &lt;__fopen_internal+17&gt;    mov    r12, rsi</span><br><span class="line">   0x7ffff7a7acd4 &lt;__fopen_internal+20&gt;    sub    rsp, 8</span><br><span class="line">──────────────────────────────────────────────────────────────[ SOURCE (CODE) ]───────────────────────────────────────────────────────────────</span><br><span class="line">In file: /root/glibc-2.23/libio/iofopen.c</span><br><span class="line">    92 &#125;</span><br><span class="line">    93 </span><br><span class="line">    94 _IO_FILE *</span><br><span class="line">    95 _IO_new_fopen (const char *filename, const char *mode)</span><br><span class="line">    96 &#123;</span><br><span class="line"> ►  97   <span class="built_in">return</span> __fopen_internal (filename, mode, 1);</span><br><span class="line">    98 &#125;</span><br><span class="line">    99 </span><br><span class="line">   100 <span class="comment">#ifdef _LIBC</span></span><br><span class="line">   101 strong_alias (_IO_new_fopen, __new_fopen)</span><br><span class="line">   102 versioned_symbol (libc, _IO_new_fopen, _IO_fopen, GLIBC_2_1);</span><br><span class="line">──────────────────────────────────────────────────────────────────[ STACK ]───────────────────────────────────────────────────────────────────</span><br><span class="line">00:0000│ rsp  0x7fffffffde88 —▸ 0x40057d (main+23) ◂— mov    qword ptr [rbp - 0x10], rax</span><br><span class="line">01:0008│      0x7fffffffde90 —▸ 0x7fffffffdf80 ◂— 0x1</span><br><span class="line">02:0010│      0x7fffffffde98 ◂— 0x0</span><br><span class="line">03:0018│ rbp  0x7fffffffdea0 —▸ 0x4005a0 (__libc_csu_init) ◂— push   r15</span><br><span class="line">04:0020│      0x7fffffffdea8 —▸ 0x7ffff7a2d830 (__libc_start_main+240) ◂— mov    edi, eax</span><br><span class="line">05:0028│      0x7fffffffdeb0 ◂— 0x1</span><br><span class="line">06:0030│      0x7fffffffdeb8 —▸ 0x7fffffffdf88 —▸ 0x7fffffffe302 ◂— <span class="string">'/root/test/test'</span></span><br><span class="line">07:0038│      0x7fffffffdec0 ◂— 0x1f7ffcca0</span><br><span class="line">────────────────────────────────────────────────────────────────[ BACKTRACE ]─────────────────────────────────────────────────────────────────</span><br><span class="line"> ► f 0     7ffff7a7ad70 fopen64</span><br><span class="line">   f 1           40057d main+23</span><br><span class="line">   f 2     7ffff7a2d830 __libc_start_main+240</span><br><span class="line">──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure>
<p>而<code>_IO_new_fopen</code>函数中是调用了<code>__fopen_internal</code>，再单步步入</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">_IO_FILE *</span><br><span class="line">__fopen_internal (<span class="keyword">const</span> <span class="keyword">char</span> *filename, <span class="keyword">const</span> <span class="keyword">char</span> *mode, <span class="keyword">int</span> is32)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">locked_FILE</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE_plus</span> <span class="title">fp</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _IO_MTSAFE_IO</span></span><br><span class="line">    _IO_lock_t lock;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">IO_wide_data</span> <span class="title">wd</span>;</span></span><br><span class="line">  &#125; *new_f = (struct locked_FILE *) <span class="built_in">malloc</span> (<span class="keyword">sizeof</span> (struct locked_FILE));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (new_f == <span class="literal">NULL</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _IO_MTSAFE_IO</span></span><br><span class="line">  new_f-&gt;fp.file._lock = &amp;new_f-&gt;lock;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined _LIBC || defined _GLIBCPP_USE_WCHAR_T</span></span><br><span class="line">  _IO_no_init (&amp;new_f-&gt;fp.file, <span class="number">0</span>, <span class="number">0</span>, &amp;new_f-&gt;wd, &amp;_IO_wfile_jumps);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">  _IO_no_init (&amp;new_f-&gt;fp.file, <span class="number">1</span>, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  _IO_JUMPS (&amp;new_f-&gt;fp) = &amp;_IO_file_jumps;</span><br><span class="line">  _IO_file_init (&amp;new_f-&gt;fp);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span>  !_IO_UNIFIED_JUMPTABLES</span></span><br><span class="line">  new_f-&gt;fp.vtable = <span class="literal">NULL</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  <span class="keyword">if</span> (_IO_file_fopen ((_IO_FILE *) new_f, filename, mode, is32) != <span class="literal">NULL</span>)</span><br><span class="line">    <span class="keyword">return</span> __fopen_maybe_mmap (&amp;new_f-&gt;fp.file);</span><br><span class="line"></span><br><span class="line">  _IO_un_link (&amp;new_f-&gt;fp);</span><br><span class="line">  <span class="built_in">free</span> (new_f);</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先是使用malloc分配空间（struct locked_FILE）<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; n</span><br><span class="line">71	  <span class="keyword">if</span> (new_f == NULL)</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">────────────────────────────────────────────────────────────────[ REGISTERS ]─────────────────────────────────────────────────────────────────</span><br><span class="line"> RAX  0x602010 ◂— 0x0</span><br><span class="line"> RBX  0x0</span><br><span class="line"> RCX  0x7ffff7dd1b20 (main_arena) ◂— 0x100000000</span><br><span class="line"> RDX  0x602010 ◂— 0x0</span><br><span class="line"> RDI  0x7ffff7dd1b20 (main_arena) ◂— 0x100000000</span><br><span class="line"> RSI  0x602230 ◂— 0x0</span><br><span class="line"> R8   0x602000 ◂— 0x0</span><br><span class="line"> R9   0xd</span><br><span class="line"> R10  0x7ffff7dd1b78 (main_arena+88) —▸ 0x602230 ◂— 0x0</span><br><span class="line"> R11  0x0</span><br><span class="line"> R12  0x400624 ◂— jb     0x400626 /* <span class="string">'r'</span> */</span><br><span class="line"> R13  0x1</span><br><span class="line"> R14  0x0</span><br><span class="line"> R15  0x0</span><br><span class="line"> RBP  0x400626 ◂— je     0x40068d /* <span class="string">'test.txt'</span> */</span><br><span class="line"> RSP  0x7fffffffde60 ◂— 0x1</span><br><span class="line"> RIP  0x7ffff7a7acdd (__fopen_internal+29) ◂— <span class="built_in">test</span>   rax, rax</span><br><span class="line">──────────────────────────────────────────────────────────────────[ DISASM ]──────────────────────────────────────────────────────────────────</span><br><span class="line">   0x7ffff7a7acc9 &lt;__fopen_internal+9&gt;     mov    rbp, rdi</span><br><span class="line">   0x7ffff7a7accc &lt;__fopen_internal+12&gt;    mov    edi, 0x228</span><br><span class="line">   0x7ffff7a7acd1 &lt;__fopen_internal+17&gt;    mov    r12, rsi</span><br><span class="line">   0x7ffff7a7acd4 &lt;__fopen_internal+20&gt;    sub    rsp, 8</span><br><span class="line">   0x7ffff7a7acd8 &lt;__fopen_internal+24&gt;    call   0x7ffff7a2c8a0</span><br><span class="line"> </span><br><span class="line"> ► 0x7ffff7a7acdd &lt;__fopen_internal+29&gt;    <span class="built_in">test</span>   rax, rax</span><br><span class="line">   0x7ffff7a7ace0 &lt;__fopen_internal+32&gt;    je     __fopen_internal+157 &lt;0x7ffff7a7ad5d&gt;</span><br><span class="line"> </span><br><span class="line">   0x7ffff7a7ace2 &lt;__fopen_internal+34&gt;    mov    rbx, rax</span><br><span class="line">   0x7ffff7a7ace5 &lt;__fopen_internal+37&gt;    lea    rax, [rax + 0xe0]</span><br><span class="line">   0x7ffff7a7acec &lt;__fopen_internal+44&gt;    lea    r8, [rip + 0x35556d] &lt;0x7ffff7dd0260&gt;</span><br><span class="line">   0x7ffff7a7acf3 &lt;__fopen_internal+51&gt;    lea    rcx, [rbx + 0xf0]</span><br><span class="line">──────────────────────────────────────────────────────────────[ SOURCE (CODE) ]───────────────────────────────────────────────────────────────</span><br><span class="line">In file: /root/glibc-2.23/libio/iofopen.c</span><br><span class="line">   66     _IO_lock_t lock;</span><br><span class="line">   67 <span class="comment">#endif</span></span><br><span class="line">   68     struct _IO_wide_data wd;</span><br><span class="line">   69   &#125; *new_f = (struct locked_FILE *) malloc (sizeof (struct locked_FILE));</span><br><span class="line">   70 </span><br><span class="line"> ► 71   <span class="keyword">if</span> (new_f == NULL)</span><br><span class="line">   72     <span class="built_in">return</span> NULL;</span><br><span class="line">   73 <span class="comment">#ifdef _IO_MTSAFE_IO</span></span><br><span class="line">   74   new_f-&gt;fp.file._lock = &amp;new_f-&gt;lock;</span><br><span class="line">   75 <span class="comment">#endif</span></span><br><span class="line">   76 <span class="comment">#if defined _LIBC || defined _GLIBCPP_USE_WCHAR_T</span></span><br><span class="line">──────────────────────────────────────────────────────────────────[ STACK ]───────────────────────────────────────────────────────────────────</span><br><span class="line">00:0000│ rsp  0x7fffffffde60 ◂— 0x1</span><br><span class="line">01:0008│      0x7fffffffde68 ◂— 0x0</span><br><span class="line">02:0010│      0x7fffffffde70 —▸ 0x7fffffffdea0 —▸ 0x4005a0 (__libc_csu_init) ◂— push   r15</span><br><span class="line">03:0018│      0x7fffffffde78 —▸ 0x400470 (_start) ◂— xor    ebp, ebp</span><br><span class="line">04:0020│      0x7fffffffde80 —▸ 0x7fffffffdf80 ◂— 0x1</span><br><span class="line">05:0028│      0x7fffffffde88 —▸ 0x40057d (main+23) ◂— mov    qword ptr [rbp - 0x10], rax</span><br><span class="line">06:0030│      0x7fffffffde90 —▸ 0x7fffffffdf80 ◂— 0x1</span><br><span class="line">07:0038│      0x7fffffffde98 ◂— 0x0</span><br><span class="line">────────────────────────────────────────────────────────────────[ BACKTRACE ]─────────────────────────────────────────────────────────────────</span><br><span class="line"> ► f 0     7ffff7a7acdd __fopen_internal+29</span><br><span class="line">   f 1           40057d main+23</span><br><span class="line">   f 2     7ffff7a2d830 __libc_start_main+240</span><br><span class="line">──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">pwndbg&gt; heap</span><br><span class="line">0x602000 PREV_INUSE &#123;</span><br><span class="line">  prev_size = 0, </span><br><span class="line">  size = 561, </span><br><span class="line">  fd = 0x0, </span><br><span class="line">  bk = 0x0, </span><br><span class="line">  fd_nextsize = 0x0, </span><br><span class="line">  bk_nextsize = 0x0</span><br><span class="line">&#125;</span><br><span class="line">0x602230 PREV_INUSE &#123;</span><br><span class="line">  prev_size = 0, </span><br><span class="line">  size = 134609, </span><br><span class="line">  fd = 0x0, </span><br><span class="line">  bk = 0x0, </span><br><span class="line">  fd_nextsize = 0x0, </span><br><span class="line">  bk_nextsize = 0x0</span><br><span class="line">&#125;</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure></p>
<p>可以看到<code>new_f</code>是一个0x230大小的chunk（带chunk的头部）</p>
<p>结构体数据如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line">$2 = &#123;</span><br><span class="line">  fp = &#123;</span><br><span class="line">    file = &#123;</span><br><span class="line">      _flags = 0, </span><br><span class="line">      _IO_read_ptr = 0x0, </span><br><span class="line">      _IO_read_end = 0x0, </span><br><span class="line">      _IO_read_base = 0x0, </span><br><span class="line">      _IO_write_base = 0x0, </span><br><span class="line">      _IO_write_ptr = 0x0, </span><br><span class="line">      _IO_write_end = 0x0, </span><br><span class="line">      _IO_buf_base = 0x0, </span><br><span class="line">      _IO_buf_end = 0x0, </span><br><span class="line">      _IO_save_base = 0x0, </span><br><span class="line">      _IO_backup_base = 0x0, </span><br><span class="line">      _IO_save_end = 0x0, </span><br><span class="line">      _markers = 0x0, </span><br><span class="line">      _chain = 0x0, </span><br><span class="line">      _fileno = 0, </span><br><span class="line">      _flags2 = 0, </span><br><span class="line">      _old_offset = 0, </span><br><span class="line">      _cur_column = 0, </span><br><span class="line">      _vtable_offset = 0 &apos;\000&apos;, </span><br><span class="line">      _shortbuf = &quot;&quot;, </span><br><span class="line">      _lock = 0x0, </span><br><span class="line">      _offset = 0, </span><br><span class="line">      _codecvt = 0x0, </span><br><span class="line">      _wide_data = 0x0, </span><br><span class="line">      _freeres_list = 0x0, </span><br><span class="line">      _freeres_buf = 0x0, </span><br><span class="line">      __pad5 = 0, </span><br><span class="line">      _mode = 0, </span><br><span class="line">      _unused2 = &apos;\000&apos; &lt;repeats 19 times&gt;</span><br><span class="line">    &#125;, </span><br><span class="line">    vtable = 0x0</span><br><span class="line">  &#125;, </span><br><span class="line">  lock = &#123;</span><br><span class="line">    lock = 0, </span><br><span class="line">    cnt = 0, </span><br><span class="line">    owner = 0x0</span><br><span class="line">  &#125;, </span><br><span class="line">  wd = &#123;</span><br><span class="line">    _IO_read_ptr = 0x0, </span><br><span class="line">    _IO_read_end = 0x0, </span><br><span class="line">    _IO_read_base = 0x0, </span><br><span class="line">    _IO_write_base = 0x0, </span><br><span class="line">    _IO_write_ptr = 0x0, </span><br><span class="line">    _IO_write_end = 0x0, </span><br><span class="line">    _IO_buf_base = 0x0, </span><br><span class="line">    _IO_buf_end = 0x0, </span><br><span class="line">    _IO_save_base = 0x0, </span><br><span class="line">    _IO_backup_base = 0x0, </span><br><span class="line">    _IO_save_end = 0x0, </span><br><span class="line">    _IO_state = &#123;</span><br><span class="line">      __count = 0, </span><br><span class="line">      __value = &#123;</span><br><span class="line">        __wch = 0, </span><br><span class="line">        __wchb = &quot;\000\000\000&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;, </span><br><span class="line">    _IO_last_state = &#123;</span><br><span class="line">      __count = 0, </span><br><span class="line">      __value = &#123;</span><br><span class="line">        __wch = 0, </span><br><span class="line">        __wchb = &quot;\000\000\000&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;, </span><br><span class="line">    _codecvt = &#123;</span><br><span class="line">      __codecvt_destr = 0x0, </span><br><span class="line">      __codecvt_do_out = 0x0, </span><br><span class="line">      __codecvt_do_unshift = 0x0, </span><br><span class="line">      __codecvt_do_in = 0x0, </span><br><span class="line">      __codecvt_do_encoding = 0x0, </span><br><span class="line">      __codecvt_do_always_noconv = 0x0, </span><br><span class="line">      __codecvt_do_length = 0x0, </span><br><span class="line">      __codecvt_do_max_length = 0x0, </span><br><span class="line">      __cd_in = &#123;</span><br><span class="line">        __cd = &#123;</span><br><span class="line">          __nsteps = 0, </span><br><span class="line">          __steps = 0x0, </span><br><span class="line">          __data = 0x6021b8</span><br><span class="line">        &#125;, </span><br><span class="line">        __combined = &#123;</span><br><span class="line">          __cd = &#123;</span><br><span class="line">            __nsteps = 0, </span><br><span class="line">            __steps = 0x0, </span><br><span class="line">            __data = 0x6021b8</span><br><span class="line">          &#125;, </span><br><span class="line">          __data = &#123;</span><br><span class="line">            __outbuf = 0x0, </span><br><span class="line">            __outbufend = 0x0, </span><br><span class="line">            __flags = 0, </span><br><span class="line">            __invocation_counter = 0, </span><br><span class="line">            __internal_use = 0, </span><br><span class="line">            __statep = 0x0, </span><br><span class="line">            __state = &#123;</span><br><span class="line">              __count = 0, </span><br><span class="line">              __value = &#123;</span><br><span class="line">                __wch = 0, </span><br><span class="line">                __wchb = &quot;\000\000\000&quot;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;, </span><br><span class="line">      __cd_out = &#123;</span><br><span class="line">        __cd = &#123;</span><br><span class="line">          __nsteps = 0, </span><br><span class="line">          __steps = 0x0, </span><br><span class="line">          __data = 0x6021f8</span><br><span class="line">        &#125;, </span><br><span class="line">        __combined = &#123;</span><br><span class="line">          __cd = &#123;</span><br><span class="line">            __nsteps = 0, </span><br><span class="line">            __steps = 0x0, </span><br><span class="line">            __data = 0x6021f8</span><br><span class="line">          &#125;, </span><br><span class="line">          __data = &#123;</span><br><span class="line">            __outbuf = 0x0, </span><br><span class="line">            __outbufend = 0x0, </span><br><span class="line">            __flags = 0, </span><br><span class="line">            __invocation_counter = 0, </span><br><span class="line">            __internal_use = 0, </span><br><span class="line">            __statep = 0x0, </span><br><span class="line">            __state = &#123;</span><br><span class="line">              __count = 0, </span><br><span class="line">              __value = &#123;</span><br><span class="line">                __wch = 0, </span><br><span class="line">                __wchb = &quot;\000\000\000&quot;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;, </span><br><span class="line">    _shortbuf = L&quot;&quot;, </span><br><span class="line">    _wide_vtable = 0x0</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后判断是否分配成功<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (new_f == <span class="literal">NULL</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br></pre></td></tr></table></figure></p>
<p>然后调用<code>_IO_no_init</code>初始化<code>new_f</code>，<code>_IO_no_init</code>内部代码在<code>glibc-2.23/libio/genops.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">_IO_no_init (fp, flags, orientation, wd, jmp)</span><br><span class="line">     _IO_FILE *fp;</span><br><span class="line">     <span class="keyword">int</span> flags;</span><br><span class="line">     <span class="keyword">int</span> orientation;</span><br><span class="line">     <span class="class"><span class="keyword">struct</span> _<span class="title">IO_wide_data</span> *<span class="title">wd</span>;</span></span><br><span class="line">     <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> *<span class="title">jmp</span>;</span></span><br><span class="line">&#123;</span><br><span class="line">  fp-&gt;_flags = _IO_MAGIC|flags;</span><br><span class="line">  fp-&gt;_flags2 = <span class="number">0</span>;</span><br><span class="line">  fp-&gt;_IO_buf_base = <span class="literal">NULL</span>;</span><br><span class="line">  fp-&gt;_IO_buf_end = <span class="literal">NULL</span>;</span><br><span class="line">  fp-&gt;_IO_read_base = <span class="literal">NULL</span>;</span><br><span class="line">  fp-&gt;_IO_read_ptr = <span class="literal">NULL</span>;</span><br><span class="line">  fp-&gt;_IO_read_end = <span class="literal">NULL</span>;</span><br><span class="line">  fp-&gt;_IO_write_base = <span class="literal">NULL</span>;</span><br><span class="line">  fp-&gt;_IO_write_ptr = <span class="literal">NULL</span>;</span><br><span class="line">  fp-&gt;_IO_write_end = <span class="literal">NULL</span>;</span><br><span class="line">  fp-&gt;_chain = <span class="literal">NULL</span>; <span class="comment">/* Not necessary. */</span></span><br><span class="line"></span><br><span class="line">  fp-&gt;_IO_save_base = <span class="literal">NULL</span>;</span><br><span class="line">  fp-&gt;_IO_backup_base = <span class="literal">NULL</span>;</span><br><span class="line">  fp-&gt;_IO_save_end = <span class="literal">NULL</span>;</span><br><span class="line">  fp-&gt;_markers = <span class="literal">NULL</span>;</span><br><span class="line">  fp-&gt;_cur_column = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> _IO_JUMPS_OFFSET</span></span><br><span class="line">  fp-&gt;_vtable_offset = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _IO_MTSAFE_IO</span></span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_lock != <span class="literal">NULL</span>)</span><br><span class="line">    _IO_lock_init (*fp-&gt;_lock);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  fp-&gt;_mode = orientation;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined _LIBC || defined _GLIBCPP_USE_WCHAR_T</span></span><br><span class="line">  <span class="keyword">if</span> (orientation &gt;= <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      fp-&gt;_wide_data = wd;</span><br><span class="line">      fp-&gt;_wide_data-&gt;_IO_buf_base = <span class="literal">NULL</span>;</span><br><span class="line">      fp-&gt;_wide_data-&gt;_IO_buf_end = <span class="literal">NULL</span>;</span><br><span class="line">      fp-&gt;_wide_data-&gt;_IO_read_base = <span class="literal">NULL</span>;</span><br><span class="line">      fp-&gt;_wide_data-&gt;_IO_read_ptr = <span class="literal">NULL</span>;</span><br><span class="line">      fp-&gt;_wide_data-&gt;_IO_read_end = <span class="literal">NULL</span>;</span><br><span class="line">      fp-&gt;_wide_data-&gt;_IO_write_base = <span class="literal">NULL</span>;</span><br><span class="line">      fp-&gt;_wide_data-&gt;_IO_write_ptr = <span class="literal">NULL</span>;</span><br><span class="line">      fp-&gt;_wide_data-&gt;_IO_write_end = <span class="literal">NULL</span>;</span><br><span class="line">      fp-&gt;_wide_data-&gt;_IO_save_base = <span class="literal">NULL</span>;</span><br><span class="line">      fp-&gt;_wide_data-&gt;_IO_backup_base = <span class="literal">NULL</span>;</span><br><span class="line">      fp-&gt;_wide_data-&gt;_IO_save_end = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">      fp-&gt;_wide_data-&gt;_wide_vtable = jmp;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>初始化后的<code>new_f</code>结构体如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line">$3 = &#123;</span><br><span class="line">  fp = &#123;</span><br><span class="line">    file = &#123;</span><br><span class="line">      _flags = -72548352, </span><br><span class="line">      _IO_read_ptr = 0x0, </span><br><span class="line">      _IO_read_end = 0x0, </span><br><span class="line">      _IO_read_base = 0x0, </span><br><span class="line">      _IO_write_base = 0x0, </span><br><span class="line">      _IO_write_ptr = 0x0, </span><br><span class="line">      _IO_write_end = 0x0, </span><br><span class="line">      _IO_buf_base = 0x0, </span><br><span class="line">      _IO_buf_end = 0x0, </span><br><span class="line">      _IO_save_base = 0x0, </span><br><span class="line">      _IO_backup_base = 0x0, </span><br><span class="line">      _IO_save_end = 0x0, </span><br><span class="line">      _markers = 0x0, </span><br><span class="line">      _chain = 0x0, </span><br><span class="line">      _fileno = 0, </span><br><span class="line">      _flags2 = 0, </span><br><span class="line">      _old_offset = 0, </span><br><span class="line">      _cur_column = 0, </span><br><span class="line">      _vtable_offset = 0 &apos;\000&apos;, </span><br><span class="line">      _shortbuf = &quot;&quot;, </span><br><span class="line">      _lock = 0x6020f0, </span><br><span class="line">      _offset = 0, </span><br><span class="line">      _codecvt = 0x0, </span><br><span class="line">      _wide_data = 0x602100, </span><br><span class="line">      _freeres_list = 0x0, </span><br><span class="line">      _freeres_buf = 0x0, </span><br><span class="line">      __pad5 = 0, </span><br><span class="line">      _mode = 0, </span><br><span class="line">      _unused2 = &apos;\000&apos; &lt;repeats 19 times&gt;</span><br><span class="line">    &#125;, </span><br><span class="line">    vtable = 0x0</span><br><span class="line">  &#125;, </span><br><span class="line">  lock = &#123;</span><br><span class="line">    lock = 0, </span><br><span class="line">    cnt = 0, </span><br><span class="line">    owner = 0x0</span><br><span class="line">  &#125;, </span><br><span class="line">  wd = &#123;</span><br><span class="line">    _IO_read_ptr = 0x0, </span><br><span class="line">    _IO_read_end = 0x0, </span><br><span class="line">    _IO_read_base = 0x0, </span><br><span class="line">    _IO_write_base = 0x0, </span><br><span class="line">    _IO_write_ptr = 0x0, </span><br><span class="line">    _IO_write_end = 0x0, </span><br><span class="line">    _IO_buf_base = 0x0, </span><br><span class="line">    _IO_buf_end = 0x0, </span><br><span class="line">    _IO_save_base = 0x0, </span><br><span class="line">    _IO_backup_base = 0x0, </span><br><span class="line">    _IO_save_end = 0x0, </span><br><span class="line">    _IO_state = &#123;</span><br><span class="line">      __count = 0, </span><br><span class="line">      __value = &#123;</span><br><span class="line">        __wch = 0, </span><br><span class="line">        __wchb = &quot;\000\000\000&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;, </span><br><span class="line">    _IO_last_state = &#123;</span><br><span class="line">      __count = 0, </span><br><span class="line">      __value = &#123;</span><br><span class="line">        __wch = 0, </span><br><span class="line">        __wchb = &quot;\000\000\000&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;, </span><br><span class="line">    _codecvt = &#123;</span><br><span class="line">      __codecvt_destr = 0x0, </span><br><span class="line">      __codecvt_do_out = 0x0, </span><br><span class="line">      __codecvt_do_unshift = 0x0, </span><br><span class="line">      __codecvt_do_in = 0x0, </span><br><span class="line">      __codecvt_do_encoding = 0x0, </span><br><span class="line">      __codecvt_do_always_noconv = 0x0, </span><br><span class="line">      __codecvt_do_length = 0x0, </span><br><span class="line">      __codecvt_do_max_length = 0x0, </span><br><span class="line">      __cd_in = &#123;</span><br><span class="line">        __cd = &#123;</span><br><span class="line">          __nsteps = 0, </span><br><span class="line">          __steps = 0x0, </span><br><span class="line">          __data = 0x6021b8</span><br><span class="line">        &#125;, </span><br><span class="line">        __combined = &#123;</span><br><span class="line">          __cd = &#123;</span><br><span class="line">            __nsteps = 0, </span><br><span class="line">            __steps = 0x0, </span><br><span class="line">            __data = 0x6021b8</span><br><span class="line">          &#125;, </span><br><span class="line">          __data = &#123;</span><br><span class="line">            __outbuf = 0x0, </span><br><span class="line">            __outbufend = 0x0, </span><br><span class="line">            __flags = 0, </span><br><span class="line">            __invocation_counter = 0, </span><br><span class="line">            __internal_use = 0, </span><br><span class="line">            __statep = 0x0, </span><br><span class="line">            __state = &#123;</span><br><span class="line">              __count = 0, </span><br><span class="line">              __value = &#123;</span><br><span class="line">                __wch = 0, </span><br><span class="line">                __wchb = &quot;\000\000\000&quot;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;, </span><br><span class="line">      __cd_out = &#123;</span><br><span class="line">        __cd = &#123;</span><br><span class="line">          __nsteps = 0, </span><br><span class="line">          __steps = 0x0, </span><br><span class="line">          __data = 0x6021f8</span><br><span class="line">        &#125;, </span><br><span class="line">        __combined = &#123;</span><br><span class="line">          __cd = &#123;</span><br><span class="line">            __nsteps = 0, </span><br><span class="line">            __steps = 0x0, </span><br><span class="line">            __data = 0x6021f8</span><br><span class="line">          &#125;, </span><br><span class="line">          __data = &#123;</span><br><span class="line">            __outbuf = 0x0, </span><br><span class="line">            __outbufend = 0x0, </span><br><span class="line">            __flags = 0, </span><br><span class="line">            __invocation_counter = 0, </span><br><span class="line">            __internal_use = 0, </span><br><span class="line">            __statep = 0x0, </span><br><span class="line">            __state = &#123;</span><br><span class="line">              __count = 0, </span><br><span class="line">              __value = &#123;</span><br><span class="line">                __wch = 0, </span><br><span class="line">                __wchb = &quot;\000\000\000&quot;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;, </span><br><span class="line">    _shortbuf = L&quot;&quot;, </span><br><span class="line">    _wide_vtable = 0x7ffff7dd0260 &lt;_IO_wfile_jumps&gt;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>回到<code>__fopen_internal</code>函数，将<code>_IO_FILE_plus</code>结构体设置成了<code>&amp;_IO_file_jumps</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_IO_JUMPS (&amp;new_f-&gt;fp) = &amp;_IO_file_jumps;</span><br></pre></td></tr></table></figure>
<p>然后调用<code>_IO_file_init</code>函数将<code>new_f</code>中的<code>_IO_FILE_plus</code>结构体链到<code>_IO_list_all</code>中，在gdb中跟进（<code>/root/glibc-2.23/libio/fileops.c</code>）：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">_IO_new_file_init (struct _IO_FILE_plus *fp)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">/* POSIX.1 allows another file handle to be used to change the position</span></span><br><span class="line"><span class="comment">     of our file descriptor.  Hence we actually don't know the actual</span></span><br><span class="line"><span class="comment">     position before we do the first fseek (and until a following fflush). */</span></span><br><span class="line">  fp-&gt;file._offset = _IO_pos_BAD;</span><br><span class="line">  fp-&gt;file._IO_file_flags |= CLOSED_FILEBUF_FLAGS;</span><br><span class="line"></span><br><span class="line">  _IO_link_in (fp);</span><br><span class="line">  fp-&gt;file._fileno = <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个函数调用了<code>_IO_link_in</code>，源码跟进（<code>/root/glibc-2.23/libio/genops.c</code>）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">_IO_link_in (struct _IO_FILE_plus *fp)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ((fp-&gt;file._flags &amp; _IO_LINKED) == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      fp-&gt;file._flags |= _IO_LINKED;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _IO_MTSAFE_IO</span></span><br><span class="line">      _IO_cleanup_region_start_noarg (flush_cleanup);</span><br><span class="line">      _IO_lock_lock (list_all_lock);</span><br><span class="line">      run_fp = (_IO_FILE *) fp;</span><br><span class="line">      _IO_flockfile ((_IO_FILE *) fp);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">      fp-&gt;file._chain = (_IO_FILE *) _IO_list_all;</span><br><span class="line">      _IO_list_all = fp;</span><br><span class="line">      ++_IO_list_all_stamp;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _IO_MTSAFE_IO</span></span><br><span class="line">      _IO_funlockfile ((_IO_FILE *) fp);</span><br><span class="line">      run_fp = <span class="literal">NULL</span>;</span><br><span class="line">      _IO_lock_unlock (list_all_lock);</span><br><span class="line">      _IO_cleanup_region_end (<span class="number">0</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后调用<code>_IO_file_fopen</code>函数来打开文件句柄，源码跟进（<code>/root/glibc-2.23/libio/fileops.c</code>）：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br></pre></td><td class="code"><pre><span class="line">_IO_FILE *</span><br><span class="line">_IO_new_file_fopen (_IO_FILE *fp, <span class="keyword">const</span> <span class="keyword">char</span> *filename, <span class="keyword">const</span> <span class="keyword">char</span> *mode,</span><br><span class="line">		    <span class="keyword">int</span> is32not64)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">int</span> oflags = <span class="number">0</span>, omode;</span><br><span class="line">  <span class="keyword">int</span> read_write;</span><br><span class="line">  <span class="keyword">int</span> oprot = <span class="number">0666</span>;</span><br><span class="line">  <span class="keyword">int</span> i;</span><br><span class="line">  _IO_FILE *result;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _LIBC</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *cs;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *last_recognized;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (_IO_file_is_open (fp))</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">switch</span> (*mode)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'r'</span>:</span><br><span class="line">      omode = O_RDONLY;</span><br><span class="line">      read_write = _IO_NO_WRITES;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'w'</span>:</span><br><span class="line">      omode = O_WRONLY;</span><br><span class="line">      oflags = O_CREAT|O_TRUNC;</span><br><span class="line">      read_write = _IO_NO_READS;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'a'</span>:</span><br><span class="line">      omode = O_WRONLY;</span><br><span class="line">      oflags = O_CREAT|O_APPEND;</span><br><span class="line">      read_write = _IO_NO_READS|_IO_IS_APPENDING;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      __set_errno (EINVAL);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _LIBC</span></span><br><span class="line">  last_recognized = mode;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">1</span>; i &lt; <span class="number">7</span>; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">switch</span> (*++mode)</span><br><span class="line">	&#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">'\0'</span>:</span><br><span class="line">	  <span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">'+'</span>:</span><br><span class="line">	  omode = O_RDWR;</span><br><span class="line">	  read_write &amp;= _IO_IS_APPENDING;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _LIBC</span></span><br><span class="line">	  last_recognized = mode;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	  <span class="keyword">continue</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">'x'</span>:</span><br><span class="line">	  oflags |= O_EXCL;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _LIBC</span></span><br><span class="line">	  last_recognized = mode;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	  <span class="keyword">continue</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">'b'</span>:</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _LIBC</span></span><br><span class="line">	  last_recognized = mode;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	  <span class="keyword">continue</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">'m'</span>:</span><br><span class="line">	  fp-&gt;_flags2 |= _IO_FLAGS2_MMAP;</span><br><span class="line">	  <span class="keyword">continue</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">'c'</span>:</span><br><span class="line">	  fp-&gt;_flags2 |= _IO_FLAGS2_NOTCANCEL;</span><br><span class="line">	  <span class="keyword">continue</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">'e'</span>:</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> O_CLOEXEC</span></span><br><span class="line">	  oflags |= O_CLOEXEC;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	  fp-&gt;_flags2 |= _IO_FLAGS2_CLOEXEC;</span><br><span class="line">	  <span class="keyword">continue</span>;</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">	  <span class="comment">/* Ignore.  */</span></span><br><span class="line">	  <span class="keyword">continue</span>;</span><br><span class="line">	&#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  result = _IO_file_open (fp, filename, omode|oflags, oprot, read_write,</span><br><span class="line">			  is32not64);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (result != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __ASSUME_O_CLOEXEC</span></span><br><span class="line">      <span class="keyword">if</span> ((fp-&gt;_flags2 &amp; _IO_FLAGS2_CLOEXEC) != <span class="number">0</span> &amp;&amp; __have_o_cloexec &lt;= <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">	  <span class="keyword">int</span> fd = _IO_fileno (fp);</span><br><span class="line">	  <span class="keyword">if</span> (__have_o_cloexec == <span class="number">0</span>)</span><br><span class="line">	    &#123;</span><br><span class="line">	      <span class="keyword">int</span> flags = __fcntl (fd, F_GETFD);</span><br><span class="line">	      __have_o_cloexec = (flags &amp; FD_CLOEXEC) == <span class="number">0</span> ? <span class="number">-1</span> : <span class="number">1</span>;</span><br><span class="line">	    &#125;</span><br><span class="line">	  <span class="keyword">if</span> (__have_o_cloexec &lt; <span class="number">0</span>)</span><br><span class="line">	    __fcntl (fd, F_SETFD, FD_CLOEXEC);</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Test whether the mode string specifies the conversion.  */</span></span><br><span class="line">      cs = <span class="built_in">strstr</span> (last_recognized + <span class="number">1</span>, <span class="string">",ccs="</span>);</span><br><span class="line">      <span class="keyword">if</span> (cs != <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">	  <span class="comment">/* Yep.  Load the appropriate conversions and set the orientation</span></span><br><span class="line"><span class="comment">	     to wide.  */</span></span><br><span class="line">	  <span class="class"><span class="keyword">struct</span> <span class="title">gconv_fcts</span> <span class="title">fcts</span>;</span></span><br><span class="line">	  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_codecvt</span> *<span class="title">cc</span>;</span></span><br><span class="line">	  <span class="keyword">char</span> *endp = __strchrnul (cs + <span class="number">5</span>, <span class="string">','</span>);</span><br><span class="line">	  <span class="keyword">char</span> *ccs = <span class="built_in">malloc</span> (endp - (cs + <span class="number">5</span>) + <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">	  <span class="keyword">if</span> (ccs == <span class="literal">NULL</span>)</span><br><span class="line">	    &#123;</span><br><span class="line">	      <span class="keyword">int</span> malloc_err = errno;  <span class="comment">/* Whatever malloc failed with.  */</span></span><br><span class="line">	      (<span class="keyword">void</span>) _IO_file_close_it (fp);</span><br><span class="line">	      __set_errno (malloc_err);</span><br><span class="line">	      <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">	    &#125;</span><br><span class="line"></span><br><span class="line">	  *((<span class="keyword">char</span> *) __mempcpy (ccs, cs + <span class="number">5</span>, endp - (cs + <span class="number">5</span>))) = <span class="string">'\0'</span>;</span><br><span class="line">	  strip (ccs, ccs);</span><br><span class="line"></span><br><span class="line">	  <span class="keyword">if</span> (__wcsmbs_named_conv (&amp;fcts, ccs[<span class="number">2</span>] == <span class="string">'\0'</span></span><br><span class="line">				   ? upstr (ccs, cs + <span class="number">5</span>) : ccs) != <span class="number">0</span>)</span><br><span class="line">	    &#123;</span><br><span class="line">	      <span class="comment">/* Something went wrong, we cannot load the conversion modules.</span></span><br><span class="line"><span class="comment">		 This means we cannot proceed since the user explicitly asked</span></span><br><span class="line"><span class="comment">		 for these.  */</span></span><br><span class="line">	      (<span class="keyword">void</span>) _IO_file_close_it (fp);</span><br><span class="line">	      <span class="built_in">free</span> (ccs);</span><br><span class="line">	      __set_errno (EINVAL);</span><br><span class="line">	      <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">	    &#125;</span><br><span class="line"></span><br><span class="line">	  <span class="built_in">free</span> (ccs);</span><br><span class="line"></span><br><span class="line">	  assert (fcts.towc_nsteps == <span class="number">1</span>);</span><br><span class="line">	  assert (fcts.tomb_nsteps == <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">	  fp-&gt;_wide_data-&gt;_IO_read_ptr = fp-&gt;_wide_data-&gt;_IO_read_end;</span><br><span class="line">	  fp-&gt;_wide_data-&gt;_IO_write_ptr = fp-&gt;_wide_data-&gt;_IO_write_base;</span><br><span class="line"></span><br><span class="line">	  <span class="comment">/* Clear the state.  We start all over again.  */</span></span><br><span class="line">	  <span class="built_in">memset</span> (&amp;fp-&gt;_wide_data-&gt;_IO_state, <span class="string">'\0'</span>, <span class="keyword">sizeof</span> (<span class="keyword">__mbstate_t</span>));</span><br><span class="line">	  <span class="built_in">memset</span> (&amp;fp-&gt;_wide_data-&gt;_IO_last_state, <span class="string">'\0'</span>, <span class="keyword">sizeof</span> (<span class="keyword">__mbstate_t</span>));</span><br><span class="line"></span><br><span class="line">	  cc = fp-&gt;_codecvt = &amp;fp-&gt;_wide_data-&gt;_codecvt;</span><br><span class="line"></span><br><span class="line">	  <span class="comment">/* The functions are always the same.  */</span></span><br><span class="line">	  *cc = __libio_codecvt;</span><br><span class="line"></span><br><span class="line">	  cc-&gt;__cd_in.__cd.__nsteps = fcts.towc_nsteps;</span><br><span class="line">	  cc-&gt;__cd_in.__cd.__steps = fcts.towc;</span><br><span class="line"></span><br><span class="line">	  cc-&gt;__cd_in.__cd.__data[<span class="number">0</span>].__invocation_counter = <span class="number">0</span>;</span><br><span class="line">	  cc-&gt;__cd_in.__cd.__data[<span class="number">0</span>].__internal_use = <span class="number">1</span>;</span><br><span class="line">	  cc-&gt;__cd_in.__cd.__data[<span class="number">0</span>].__flags = __GCONV_IS_LAST;</span><br><span class="line">	  cc-&gt;__cd_in.__cd.__data[<span class="number">0</span>].__statep = &amp;result-&gt;_wide_data-&gt;_IO_state;</span><br><span class="line"></span><br><span class="line">	  cc-&gt;__cd_out.__cd.__nsteps = fcts.tomb_nsteps;</span><br><span class="line">	  cc-&gt;__cd_out.__cd.__steps = fcts.tomb;</span><br><span class="line"></span><br><span class="line">	  cc-&gt;__cd_out.__cd.__data[<span class="number">0</span>].__invocation_counter = <span class="number">0</span>;</span><br><span class="line">	  cc-&gt;__cd_out.__cd.__data[<span class="number">0</span>].__internal_use = <span class="number">1</span>;</span><br><span class="line">	  cc-&gt;__cd_out.__cd.__data[<span class="number">0</span>].__flags</span><br><span class="line">	    = __GCONV_IS_LAST | __GCONV_TRANSLIT;</span><br><span class="line">	  cc-&gt;__cd_out.__cd.__data[<span class="number">0</span>].__statep =</span><br><span class="line">	    &amp;result-&gt;_wide_data-&gt;_IO_state;</span><br><span class="line"></span><br><span class="line">	  <span class="comment">/* From now on use the wide character callback functions.  */</span></span><br><span class="line">	  _IO_JUMPS_FILE_plus (fp) = fp-&gt;_wide_data-&gt;_wide_vtable;</span><br><span class="line"></span><br><span class="line">	  <span class="comment">/* Set the mode now.  */</span></span><br><span class="line">	  result-&gt;_mode = <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>先判断文件是否打开，然后再获取文件打开的方式，再调用<code>_IO_file_open</code>来打开文件</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">_IO_FILE *</span><br><span class="line">_IO_file_open (_IO_FILE *fp, <span class="keyword">const</span> <span class="keyword">char</span> *filename, <span class="keyword">int</span> posix_mode, <span class="keyword">int</span> prot,</span><br><span class="line">	       <span class="keyword">int</span> read_write, <span class="keyword">int</span> is32not64)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">int</span> fdesc;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _LIBC</span></span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (fp-&gt;_flags2 &amp; _IO_FLAGS2_NOTCANCEL))</span><br><span class="line">    fdesc = open_not_cancel (filename,</span><br><span class="line">			     posix_mode | (is32not64 ? <span class="number">0</span> : O_LARGEFILE), prot);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    fdesc = open (filename, posix_mode | (is32not64 ? <span class="number">0</span> : O_LARGEFILE), prot);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">  fdesc = open (filename, posix_mode, prot);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  <span class="keyword">if</span> (fdesc &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">  fp-&gt;_fileno = fdesc;</span><br><span class="line">  _IO_mask_flags (fp, read_write,_IO_NO_READS+_IO_NO_WRITES+_IO_IS_APPENDING);</span><br><span class="line">  <span class="comment">/* For append mode, send the file offset to the end of the file.  Don't</span></span><br><span class="line"><span class="comment">     update the offset cache though, since the file handle is not active.  */</span></span><br><span class="line">  <span class="keyword">if</span> ((read_write &amp; (_IO_IS_APPENDING | _IO_NO_READS))</span><br><span class="line">      == (_IO_IS_APPENDING | _IO_NO_READS))</span><br><span class="line">    &#123;</span><br><span class="line">      _IO_off64_t new_pos = _IO_SYSSEEK (fp, <span class="number">0</span>, _IO_seek_end);</span><br><span class="line">      <span class="keyword">if</span> (new_pos == _IO_pos_BAD &amp;&amp; errno != ESPIPE)</span><br><span class="line">	&#123;</span><br><span class="line">	  close_not_cancel (fdesc);</span><br><span class="line">	  <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  _IO_link_in ((struct _IO_FILE_plus *) fp);</span><br><span class="line">  <span class="keyword">return</span> fp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用open函数打开文件，最后再次调用<code>_IO_link_in</code>确保这个结构体进入到<code>_IO_list_all</code>链表</p>
<p>最后<code>new_f-&gt;$12-&gt;fp.vtable</code>的值：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p *(struct _IO_jump_t *)0x7ffff7dd06e0</span><br><span class="line">$19 = &#123;</span><br><span class="line">  __dummy = 0, </span><br><span class="line">  __dummy2 = 0, </span><br><span class="line">  __finish = 0x7ffff7a869c0 &lt;_IO_new_file_finish&gt;, </span><br><span class="line">  __overflow = 0x7ffff7a87730 &lt;_IO_new_file_overflow&gt;, </span><br><span class="line">  __underflow = 0x7ffff7a874a0 &lt;_IO_new_file_underflow&gt;, </span><br><span class="line">  __uflow = 0x7ffff7a88600 &lt;__GI__IO_default_uflow&gt;, </span><br><span class="line">  __pbackfail = 0x7ffff7a89980 &lt;__GI__IO_default_pbackfail&gt;, </span><br><span class="line">  __xsputn = 0x7ffff7a861e0 &lt;_IO_new_file_xsputn&gt;, </span><br><span class="line">  __xsgetn = 0x7ffff7a85ec0 &lt;__GI__IO_file_xsgetn&gt;, </span><br><span class="line">  __seekoff = 0x7ffff7a854c0 &lt;_IO_new_file_seekoff&gt;, </span><br><span class="line">  __seekpos = 0x7ffff7a88a00 &lt;_IO_default_seekpos&gt;, </span><br><span class="line">  __setbuf = 0x7ffff7a85430 &lt;_IO_new_file_setbuf&gt;, </span><br><span class="line">  __sync = 0x7ffff7a85370 &lt;_IO_new_file_sync&gt;, </span><br><span class="line">  __doallocate = 0x7ffff7a7a180 &lt;__GI__IO_file_doallocate&gt;, </span><br><span class="line">  __read = 0x7ffff7a861a0 &lt;__GI__IO_file_read&gt;, </span><br><span class="line">  __write = 0x7ffff7a85b70 &lt;_IO_new_file_write&gt;, </span><br><span class="line">  __seek = 0x7ffff7a85970 &lt;__GI__IO_file_seek&gt;, </span><br><span class="line">  __close = 0x7ffff7a85340 &lt;__GI__IO_file_close&gt;, </span><br><span class="line">  __stat = 0x7ffff7a85b60 &lt;__GI__IO_file_stat&gt;, </span><br><span class="line">  __showmanyc = 0x7ffff7a89af0 &lt;_IO_default_showmanyc&gt;, </span><br><span class="line">  __imbue = 0x7ffff7a89b00 &lt;_IO_default_imbue&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

        
        <br>
        <div id="comment-container">
        </div>
        <div id="disqus_thread"></div>

        <div id="lv-container">
        </div>

    </div>
</div>

    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        

        

        

        

        

    </ul>
    
    <p>
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
        转发请备注<a href="“https://luobuming.github.io”">一筐萝卜</a>的个人博客 <br>
        本站总访问量<span id="busuanzi_value_site_pv"></span>次
       </p>
</footer>




</body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = "search.json"
    window.hexo_root = "/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="/js/index.js"></script>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




</html>
